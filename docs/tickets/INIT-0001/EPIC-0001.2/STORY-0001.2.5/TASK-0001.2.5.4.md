# TASK-0001.2.5.4: Pipeline Integration + Final BDD

**Parent Story**: [STORY-0001.2.5](README.md)
**Status**: ðŸ”µ Not Started
**Estimated Hours**: 1
**Actual Hours**: -

## Objective

Integrate ProgressReporter into indexing pipeline, implement graceful SIGINT handling, and complete final BDD scenarios 4-5. This completes the story with full E2E pipeline working per TUI_GUIDE.md patterns.

## BDD Progress

**Before this task**: 3/5 scenarios passing (Scenarios 1-3)
**After this task**: 5/5 scenarios passing (all scenarios âœ…)

**Scenarios for this task:**

- Scenario 4: Graceful cancellation (TUI_GUIDE.md:377-387)
- Scenario 5: Empty repository handling

## Implementation Checklist

### Phase 1: Pipeline Integration

- [ ] Check if `src/gitctx/indexing/pipeline.py` exists
  - Current status: Does NOT exist (verified in planning)
  - Action: CREATE new file (~100 lines) with index_repository() function
  - If future tasks create it first: MODIFY instead
- [ ] Add imports:
  - `from pathlib import Path`, `import sys`
  - `from gitctx.indexing.progress import ProgressReporter, CostEstimator`
  - Pipeline imports: walker, chunker, embedder, store
- [ ] Implement `index_repository(repo_path: Path, settings: GitCtxSettings, dry_run: bool = False, verbose: bool = False)`:
  - If dry_run: run CostEstimator, print results, return early
  - Initialize components: reporter, walker, chunker, embedder, store
  - Call `reporter.start()`
  - Wrap main loop in try/except KeyboardInterrupt
- [ ] Add walking phase:
  - `reporter.phase("Walking commit graph")`
  - Iterate walker, update stats
- [ ] Add embedding phase:
  - `reporter.phase("Generating embeddings")`
  - Chunk files, embed, update stats
- [ ] Add KeyboardInterrupt handler:
  - Print "\nInterrupted" to stderr
  - Call `reporter.finish()` to show partial stats
  - Exit with code 130: `sys.exit(130)`
- [ ] Add finally block:
  - `reporter.finish()` (called on success path too)
- [ ] Add empty repo handling:
  - Check if walker finds zero blobs
  - Print "No files to index"
  - Exit code 0

### Phase 2: BDD Implementation - Scenario 4 (Graceful Cancellation)

- [ ] Open `tests/e2e/steps/progress_steps.py`
- [ ] Implement `@given('indexing is in progress with {n} files')`:
  - Use `e2e_git_repo_factory` to create repo with n files
  - Start subprocess: `subprocess.Popen(["gitctx", "index"], ...)`
  - Wait briefly (0.5s) to ensure indexing starts
  - Store process handle in context
- [ ] Implement `@when('I send SIGINT to the process')`:
  - Import signal module
  - Send SIGINT: `process.send_signal(signal.SIGINT)`
  - Wait for termination: `process.wait(timeout=10)`
  - Store stdout, stderr, exit_code in context
  - If timeout: fail test with message
- [ ] Implement `@then('I should see "Interrupted" message')`:
  - Parse stderr for "Interrupted" or "Cancelled"
  - Assert message present
- [ ] Implement `@then('partial stats with tokens and cost')`:
  - Parse stdout/stderr for partial statistics
  - Assert tokens displayed (may be partial)
  - Assert cost displayed (may be partial)
- [ ] Implement `@then('exit code should be {code}')`:
  - Assert context["exit_code"] == int(code)
  - For SIGINT: assert exit_code == 130
- [ ] Run BDD test: `uv run pytest tests/e2e/features/progress_tracking.feature::test_graceful_cancellation`
  - Verify Scenario 4 passes âœ“

### Phase 3: BDD Implementation - Scenario 5 (Empty Repository)

- [ ] Implement `@given('an empty repository with no files')`:
  - Use `e2e_git_repo_factory` to create empty repo (just init, no files)
  - Store repo path in context
- [ ] Implement `@then('I should see "No files to index"')`:
  - Parse stdout for message
  - Assert "No files to index" present
- [ ] Run BDD test: `uv run pytest tests/e2e/features/progress_tracking.feature::test_empty_repository_handling`
  - Verify Scenario 5 passes âœ“

### Phase 4: Verification

- [ ] Run ALL BDD tests: `uv run pytest tests/e2e/features/progress_tracking.feature -v`
  - Assert 5/5 scenarios passing âœ…
- [ ] Run full test suite: `uv run pytest`
  - Assert no regressions in other tests
- [ ] Run type checking: `uv run mypy src/gitctx/indexing/`
- [ ] Run linting: `uv run ruff check src tests`
- [ ] Run formatting: `uv run ruff format src tests`
- [ ] Check code coverage: `uv run pytest --cov=src/gitctx`
  - Assert coverage >90%

## Files to Create/Modify

- CREATE: `src/gitctx/indexing/pipeline.py` (~100 lines total)
  - Status: File does NOT exist (verified in planning)
  - If created by earlier tasks: MODIFY instead
- MODIFY: `tests/e2e/steps/progress_steps.py` (implement ~6 steps for Scenarios 4-5)

## Pattern Reuse

- **CommitWalker** (STORY-0001.2.1) - provides blob iteration with stats âœ…
- **Blob Chunking** (STORY-0001.2.2) - provides chunk creation âœ…
- **OpenAI Embeddings** (STORY-0001.2.3) - provides token/cost data âœ…
- **LanceDB Storage** (STORY-0001.2.4) - provides storage operations âœ…
- **Subprocess signal handling** - for SIGINT in E2E tests
- **`e2e_git_repo_factory`** - for creating empty repos and repos with files

## Integration Verification

**Full E2E Pipeline**:
```
walker â†’ chunker â†’ embedder â†’ store
   â†“         â†“         â†“         â†“
reporter.phase() + reporter.update()
              â†“
   Terse/Verbose Output
```

**Error Handling**:
- KeyboardInterrupt (SIGINT) caught â†’ show partial stats â†’ exit 130
- Empty repository â†’ "No files to index" â†’ exit 0
- Other errors â†’ reporter.record_error() â†’ continue processing

**State at End**:
- reporter.finish() called in finally block
- Final summary displayed (terse or verbose based on flag)
- All statistics accurate (tokens, cost, time, errors)

## Testing Notes

**E2E Tests:**
- Use real subprocess with signal handling
- Create empty repos to test edge case
- Verify graceful shutdown (no hanging processes)
- Test both SIGINT (exit 130) and normal completion (exit 0)

**Critical Constraints:**
- NEVER write to `.gitctx` directory in gitctx repo itself
- All E2E tests use tmp_path (auto_isolate_e2e_working_directory)
- Process termination must complete within 10s timeout

## Dependencies

- STORY-0001.2.1 (CommitWalker) âœ…
- STORY-0001.2.2 (Blob Chunking) âœ…
- STORY-0001.2.3 (OpenAI Embeddings) âœ…
- STORY-0001.2.4 (LanceDB Storage) âœ…
- ProgressReporter (TASK-0001.2.5.2) âœ…
- CostEstimator (TASK-0001.2.5.3) âœ…

## Success Criteria

- âœ… Pipeline integration complete with progress reporting
- âœ… KeyboardInterrupt (SIGINT) handled gracefully â†’ exit 130
- âœ… Empty repository handled correctly â†’ exit 0
- âœ… BDD Scenarios 4-5 pass (cancellation, empty repo)
- âœ… 5/5 BDD scenarios passing âœ…
- âœ… Full test suite passes (no regressions)
- âœ… Code coverage >90%
- âœ… No mypy errors
- âœ… No ruff errors

## Notes

- **This task completes the story** - all acceptance criteria met
- **Full E2E pipeline working** with TUI_GUIDE-compliant progress reporting
- **Cost-effective testing**: mocked embedders, small repos
- **Fast CI execution**: no real API calls, <50KB repos
- **Graceful error handling**: SIGINT, empty repos
- **Production-ready**: terse by default, verbose on request

---

**Created**: 2025-10-11
**Last Updated**: 2025-10-11
