# TASK-0001.2.5.1: Write BDD Scenarios for Progress + Cost

**Parent Story**: [STORY-0001.2.5](README.md)
**Status**: ðŸ”µ Not Started
**Estimated Hours**: 2
**Actual Hours**: -

## Objective

Write all 5 E2E BDD scenarios for progress tracking and cost estimation per TUI_GUIDE.md patterns (terse vs verbose modes). Create stub step definitions that raise NotImplementedError. This defines behavior upfront before implementation.

## BDD Progress

**Before this task**: No scenarios exist
**After this task**: 0/5 scenarios passing (all stubbed, all failing with NotImplementedError)

**Scenarios for this task:**

1. Default terse output (TUI_GUIDE.md:208-209)
2. Verbose mode with phase progress (TUI_GUIDE.md:230-256)
3. Pre-indexing cost estimate with --dry-run
4. Graceful cancellation (TUI_GUIDE.md:377-387)
5. Empty repository handling

## Implementation Checklist

### Phase 1: Create Feature File

- [ ] Create `tests/e2e/features/progress_tracking.feature`
- [ ] Write Scenario 1: Default terse output
  - Given a repository with 10 files to index
  - When I run "gitctx index" with mocked embedder
  - Then I should see single-line output matching "Indexed \d+ commits"
  - And cost summary should show format "$\d+\.\d{4}"
- [ ] Write Scenario 2: Verbose mode with phase progress
  - Given a repository with 10 files to index
  - When I run "gitctx index --verbose" with mocked embedder
  - Then I should see phase markers: "â†’ Walking commit graph", "â†’ Generating embeddings"
  - And final summary should show detailed statistics table
- [ ] Write Scenario 3: Pre-indexing cost estimate
  - Given a repository with 5 files totaling 2KB
  - When I run "gitctx index --dry-run"
  - Then I should see estimated tokens
  - And estimated cost formatted as "$\d+\.\d{4}"
  - And confidence range: "Range: $\d+\.\d{4} - $\d+\.\d{4} \(Â±20%\)"
- [ ] Write Scenario 4: Graceful cancellation
  - Given indexing is in progress with 20 files
  - When I send SIGINT to the process
  - Then I should see "Interrupted" message
  - And partial stats with tokens and cost
  - And exit code should be 130
- [ ] Write Scenario 5: Empty repository handling
  - Given an empty repository with no indexable files
  - When I run "gitctx index"
  - Then I should see "No files to index"
  - And exit code should be 0
  - Note: "No indexable files" = zero files matching 60+ supported extensions

### Phase 2: Stub Step Definitions

- [ ] Create `tests/e2e/steps/progress_steps.py`
- [ ] Import required fixtures and modules
- [ ] Stub step: `@given('a repository with {n} files to index')`
- [ ] Stub step: `@when('I run "gitctx index" with mocked embedder')`
- [ ] Stub step: `@when('I run "gitctx index --verbose" with mocked embedder')`
- [ ] Stub step: `@when('I run "gitctx index --dry-run"')`
- [ ] Stub step: `@when('I send SIGINT to the process')`
- [ ] Stub step: `@then('I should see single-line output matching {pattern}')`
- [ ] Stub step: `@then('cost summary should show format {pattern}')`
- [ ] Stub step: `@then('I should see phase markers: {markers}')`
- [ ] Stub step: `@then('final summary should show detailed statistics table')`
- [ ] Stub step: `@then('I should see estimated tokens')`
- [ ] Stub step: `@then('estimated cost formatted as {pattern}')`
- [ ] Stub step: `@then('confidence range: {pattern}')`
- [ ] Stub step: `@then('I should see "Interrupted" message')`
- [ ] Stub step: `@then('partial stats with tokens and cost')`
- [ ] Stub step: `@then('exit code should be {code}')`
- [ ] Stub step: `@then('I should see "No files to index"')`
- [ ] Each stub raises NotImplementedError with descriptive message

### Phase 3: Verification

- [ ] Run `uv run pytest tests/e2e/features/progress_tracking.feature -v`
- [ ] Verify all 5 scenarios fail with NotImplementedError
- [ ] Verify 0/5 scenarios passing
- [ ] Verify no syntax errors in Gherkin
- [ ] Run ruff format on feature and step files

### Phase 4: Documentation

- [ ] Document mocked embedder pattern in step file comments (use existing `isolated_env` + `AsyncMock` pattern)
- [ ] Verify step definitions follow existing patterns from other step files
- [ ] Add references to TUI_GUIDE.md sections in feature file comments

## Files to Create

- CREATE: `tests/e2e/features/progress_tracking.feature` (~100 lines, 5 scenarios in Gherkin)
- CREATE: `tests/e2e/steps/progress_steps.py` (~100 lines, ~15 stubbed steps)

## Pattern Reuse

- **`e2e_git_repo_factory`** ([tests/e2e/conftest.py:254-356](../../../../tests/e2e/conftest.py#L254-L356)) - Create test repos
- **`e2e_git_isolation_env`** ([tests/e2e/conftest.py:40-132](../../../../tests/e2e/conftest.py#L40-L132)) - Secure subprocess environment
- **`context` fixture** ([tests/e2e/steps/cli_steps.py:12-15](../../../../tests/e2e/steps/cli_steps.py#L12-L15)) - Store state between BDD steps
- **Mocked embedder pattern** ([tests/unit/embeddings/test_openai_embedder.py:70-75](../../../../tests/unit/embeddings/test_openai_embedder.py#L70-L75)) - Use `isolated_env` + `AsyncMock`

## Testing Strategy

**E2E Testing Approach:**
- Use small test repos (5-20 files) for fast execution
- Use mocked embedders: `isolated_env` fixture + `AsyncMock` (no real API calls, zero cost)
- All tests run in `tmp_path` via `auto_isolate_e2e_working_directory`
- Parse CLI stdout/stderr for terse/verbose output patterns
- NEVER write to `.gitctx` directory in gitctx repo itself

**Key Design Decision:**
All 5 scenarios are E2E (CLI-based). Calculation logic (cost formulas, formatting) covered by unit tests in TASK-2 and TASK-3.

## Dependencies

- pytest-bdd installed and configured âœ…
- Existing E2E fixtures available âœ…
- No implementation dependencies (this is TASK-1, defines behavior)

## Success Criteria

- âœ… Feature file created with 5 complete scenarios
- âœ… Step file created with all step definitions stubbed
- âœ… All scenarios fail with NotImplementedError
- âœ… 0/5 scenarios passing (expected for TASK-1)
- âœ… Gherkin syntax valid (no parser errors)
- âœ… Code formatted with ruff

## Notes

- **BDD-First Pattern**: This task writes NO implementation code, only test scenarios
- **NotImplementedError is correct**: All steps should raise this until TASK-2+
- **TUI_GUIDE compliance**: Tests both default (terse) and verbose (-v) modes
- **Cost-effective**: E2E tests use mocked embedders, not real API calls
- **Fast CI**: Small repos ensure quick test execution
- Follow Gherkin best practices: clear Given/When/Then structure

---

**Created**: 2025-10-11
**Last Updated**: 2025-10-11
