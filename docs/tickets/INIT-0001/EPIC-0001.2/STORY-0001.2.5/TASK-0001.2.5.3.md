# TASK-0001.2.5.3: CostEstimator + BDD for Scenario 3

**Parent Story**: [STORY-0001.2.5](README.md)
**Status**: ðŸ”µ Not Started
**Estimated Hours**: 2
**Actual Hours**: -

## Objective

Implement `CostEstimator` class for pre-indexing cost estimates with concrete file walking algorithms. Follow TDD: write unit tests first, then implement. Add BDD steps for Scenario 3 (pre-indexing cost estimate).

## BDD Progress

**Before this task**: 2/5 scenarios passing (Scenarios 1-2)
**After this task**: 3/5 scenarios passing (Scenarios 1-3)

**Scenarios for this task:**

- Scenario 3: Pre-indexing cost estimate with --dry-run

## Implementation Checklist

### Phase 1: Unit Tests First (TDD - RED)

- [ ] Create `tests/unit/indexing/test_cost_estimator.py`
- [ ] Write failing test: `test_tokens_per_line_constant()`
  - Assert CostEstimator.TOKENS_PER_LINE == 5.0
  - Document rationale: conservative estimate per 16x Prompt study
- [ ] Write failing test: `test_cost_per_1k_tokens_constant()`
  - Assert CostEstimator.COST_PER_1K_TOKENS == 0.00013
  - Document: text-embedding-3-large pricing
- [ ] Write failing test: `test_estimate_repo_cost_basic()`
  - Create small test repo with known line count
  - Call estimate_repo_cost()
  - Assert estimated_tokens == lines * 5.0
  - Assert estimated_cost formula correct
- [ ] Write failing test: `test_confidence_range_calculation()`
  - Mock to get estimated_cost = 1.0
  - Assert min_cost == 0.8 (80%)
  - Assert max_cost == 1.2 (120%)
- [ ] Write failing test: `test_count_lines_excludes_git_dir()`
  - Create repo with .git/ directory
  - Assert _count_lines() excludes .git/ paths
- [ ] Write failing test: `test_count_lines_all_languages()`
  - Create repo with multiple language files (.py, .java, .rb, .php, .go, etc.)
  - Assert _count_lines() counts ALL supported extensions (60+)
- [ ] Run `uv run pytest tests/unit/indexing/test_cost_estimator.py`
  - Verify all tests fail âœ“

### Phase 2: Implementation - CostEstimator (GREEN)

- [ ] Open `src/gitctx/indexing/progress.py` (add to existing file)
- [ ] Add `CostEstimator` class after `ProgressReporter`
- [ ] Add imports: `from typing import TypedDict`, `from pathlib import Path`
- [ ] Define `CostEstimate` TypedDict:
  - total_files, total_lines, estimated_tokens, estimated_cost, min_cost, max_cost
- [ ] Add class constants with documentation:
  - `TOKENS_PER_LINE = 5.0` (conservative estimate from 16x Prompt study)
  - `COST_PER_1K_TOKENS = 0.00013` (text-embedding-3-large pricing)
- [ ] Implement `estimate_repo_cost(self, repo_path: Path) -> CostEstimate`:
  - Call `_count_lines(repo_path)` and `_count_files(repo_path)`
  - Calculate `estimated_tokens = int(total_lines * TOKENS_PER_LINE)`
  - Calculate `estimated_cost = (estimated_tokens / 1000) * COST_PER_1K_TOKENS`
  - Calculate `min_cost = estimated_cost * 0.8`
  - Calculate `max_cost = estimated_cost * 1.2`
  - Return dict with all values
- [ ] Implement `_count_lines(self, repo_path: Path) -> int`:
  - Walk working directory: `repo_path.rglob("*")`
  - Import EXTENSION_TO_LANGUAGE from language_detection
  - Count ALL files with extensions (60+ supported + unknown defaulting to markdown)
  - Exclude: `.git` in file.parts
  - For each file: `len(file.read_text().splitlines())`
  - Catch UnicodeDecodeError, PermissionError, OSError: continue (skip binary/inaccessible)
  - Return sum of lines across all text files
- [ ] Implement `_count_files(self, repo_path: Path) -> int`:
  - Same filtering as _count_lines() - count ALL text files
  - Return count of matched files
- [ ] Run unit tests - all CostEstimator tests pass âœ“

### Phase 3: BDD Implementation - Scenario 3 (Cost Estimate)

- [ ] Open `tests/e2e/steps/progress_steps.py`
- [ ] Implement `@given('a repository with {n} files totaling {size}')`:
  - Parse n (number of files) and size (e.g., "2KB")
  - Use `e2e_git_repo_factory` to create repo with n files
  - Distribute content to match target size within Â±10%:
    - bytes_per_file = target_bytes // n
    - Create files with ~bytes_per_file content each
  - Store repo path in context
- [ ] Implement `@when('I run "gitctx index --dry-run"')`:
  - Run subprocess: `gitctx index --dry-run`
  - Use `e2e_git_isolation_env` for isolation
  - Capture stdout, stderr, exit_code in context
- [ ] Implement `@then('I should see estimated tokens')`:
  - Parse stdout for token estimate line
  - Assert line matches pattern: "Est. tokens:  \d+,?\d*"
  - Store parsed value in context
- [ ] Implement `@then('estimated cost formatted as {pattern}')`:
  - Parse stdout for cost line
  - Assert format matches pattern: "Est. cost:    $\d+\.\d{4}"
  - Verify 4 decimal places
- [ ] Implement `@then('confidence range: {pattern}')`:
  - Parse stdout for range line
  - Assert format: "Range:        $\d+\.\d{4} - $\d+\.\d{4} \(Â±20%\)"
  - Verify min and max values present
- [ ] Run BDD test: `uv run pytest tests/e2e/features/progress_tracking.feature::test_pre_indexing_cost_estimate`
  - Verify Scenario 3 passes âœ“

### Phase 4: Verification

- [ ] Run all unit tests: `uv run pytest tests/unit/indexing/test_cost_estimator.py -v`
  - Assert all unit tests pass (5+ tests)
- [ ] Run BDD tests: `uv run pytest tests/e2e/features/progress_tracking.feature -v`
  - Assert 3/5 scenarios passing (Scenarios 1-3)
- [ ] Run type checking: `uv run mypy src/gitctx/indexing/progress.py`
- [ ] Run linting: `uv run ruff check src tests`
- [ ] Run formatting: `uv run ruff format src tests`
- [ ] Check code coverage: `uv run pytest --cov=src/gitctx/indexing tests/unit/indexing/`
  - Assert coverage >90% maintained

## Files to Create/Modify

- MODIFY: `src/gitctx/indexing/progress.py` (add CostEstimator class, ~100 lines)
- CREATE: `tests/unit/indexing/test_cost_estimator.py` (~80 lines, ~5 unit tests)
- MODIFY: `tests/e2e/steps/progress_steps.py` (implement ~5 steps for Scenario 3)

## Pattern Reuse

- **`e2e_git_repo_factory`** ([tests/e2e/conftest.py:254-356](../../../../tests/e2e/conftest.py#L254-L356)) - Create repos with specific sizes
- **`e2e_git_isolation_env`** ([tests/e2e/conftest.py:40-132](../../../../tests/e2e/conftest.py#L40-L132)) - Subprocess environment
- **String parsing patterns** from existing BDD steps - for extracting metrics from stdout

## Cost Calculation Constants

From story technical design and 16x Prompt study:

```python
# Average tokens per line of code (conservative estimate)
# Empirical data: Python ~10, JavaScript ~7, SQL ~11.5 tokens/line
# Conservative: 5.0 tokens/line (accounts for blank lines, comments)
# Expected to under-estimate by ~30-50% (safer for budget planning)
# Source: https://prompt.16x.engineer/blog/code-to-tokens-conversion
TOKENS_PER_LINE = 5.0

# text-embedding-3-large pricing
COST_PER_1K_TOKENS = 0.00013
```

**Confidence Range:**
- Â±20% range accounts for code density variability
- Conservative estimate errs on low side for budget planning
- Actual costs tracked precisely during indexing via tiktoken

## Testing Notes

**Unit Tests:**
- Test constants are correct values
- Test calculation formulas with various inputs
- Test file walking with real test repos (small)
- Test .git/ exclusion
- Test edge cases: empty repo, binary files

**E2E Tests:**
- Test with real (small) repos created by factory
- Parse stdout for all expected metrics
- Verify formatting: commas, decimal places
- Verify --dry-run doesn't actually index (fast execution, no API calls)

**Critical Constraint:**
- NEVER write to `.gitctx` directory in gitctx repo itself
- All test repos in tmp_path

## Dependencies

- No external dependencies (standard library: pathlib, typing)
- Existing E2E fixtures âœ…

## Success Criteria

- âœ… All unit tests pass (5+ tests covering CostEstimator)
- âœ… CostEstimator class implemented with accurate formulas
- âœ… _count_lines() and _count_files() implemented with concrete algorithms
- âœ… BDD Scenario 3 passes (pre-indexing estimate)
- âœ… 3/5 BDD scenarios passing
- âœ… Code coverage >90% maintained
- âœ… No mypy errors
- âœ… No ruff errors

## Notes

- **Concrete implementation**: No placeholders - full pathlib walking implemented
- **Working directory approximation**: Walks current working directory (not commit-aware yet)
- **TASK-4 will enhance**: Pipeline integration will use CommitWalker for commit-aware counting
- **Conservative estimates**: Protects users from cost overruns
- **Actual indexing uses tiktoken**: Precise token counting during real indexing

---

**Created**: 2025-10-11
**Last Updated**: 2025-10-11
