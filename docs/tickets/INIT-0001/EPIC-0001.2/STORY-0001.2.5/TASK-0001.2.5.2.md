# TASK-0001.2.5.2: ProgressReporter with Terse/Verbose Modes

**Parent Story**: [STORY-0001.2.5](README.md)
**Status**: ✅ Complete
**Estimated Hours**: 3
**Actual Hours**: 3

## Objective

Implement TUI_GUIDE-compliant `ProgressReporter` and `IndexingStats` per TUI_GUIDE.md patterns (terse by default, verbose with -v). Follow TDD: write comprehensive unit tests first, then implement to pass tests. Implement BDD steps for Scenarios 1-2.

## BDD Progress

**Before this task**: 0/5 scenarios passing (all stubbed)
**After this task**: 2/5 scenarios passing (Scenarios 1-2)

**Scenarios for this task:**

- Scenario 1: Default terse output (TUI_GUIDE.md:208-209)
- Scenario 2: Verbose mode with phase progress (TUI_GUIDE.md:230-256)

## Implementation Checklist

### Phase 1: Unit Tests First (TDD - RED)

- [ ] Create `tests/unit/indexing/test_progress_reporter.py`
- [ ] Write failing test: `test_indexing_stats_elapsed_seconds()`
  - Create IndexingStats with start_time
  - Mock time.time() to return deterministic value
  - Assert elapsed_seconds() returns correct delta
- [ ] Write failing test: `test_progress_reporter_terse_mode()`
  - Create ProgressReporter(verbose=False)
  - Call start(), update(), finish()
  - Capture stdout
  - Assert output matches: "Indexed N commits (M unique blobs) in X.Xs"
  - Assert output contains: "Tokens: N | Cost: $X.XXXX"
- [ ] Write failing test: `test_progress_reporter_verbose_mode()`
  - Create ProgressReporter(verbose=True)
  - Call start(), phase(), update(), finish()
  - Capture stderr (verbose uses stderr per TUI_GUIDE)
  - Assert phase markers: "→ Walking commit graph", "→ Generating embeddings"
  - Assert final summary contains: "✓ Indexing Complete", statistics table
- [ ] Write failing test: `test_progress_reporter_error_tracking()`
  - Call record_error() multiple times
  - Assert stats.errors increments correctly
  - Assert errors displayed in final summary
- [ ] Write failing test: `test_progress_reporter_empty_repo()`
  - Test with zero commits/blobs/chunks
  - Assert no division by zero
  - Assert graceful output: "Indexed 0 commits (0 unique blobs)"
- [ ] Run `uv run pytest tests/unit/indexing/test_progress_reporter.py`
  - Verify all tests fail with AttributeError or NameError ✓

### Phase 2: Implementation - IndexingStats (GREEN)

- [ ] Create `src/gitctx/indexing/progress.py`
- [ ] Add imports: `from dataclasses import dataclass`, `import time`, `import sys`
- [ ] Implement `IndexingStats` dataclass with fields:
  - `total_commits: int = 0`
  - `total_blobs: int = 0`
  - `total_chunks: int = 0`
  - `total_tokens: int = 0`
  - `total_cost_usd: float = 0.0`
  - `errors: int = 0`
  - `start_time: float = 0.0`
- [ ] Implement `elapsed_seconds() -> float`
  - Return `time.time() - self.start_time`
- [ ] Run unit tests - IndexingStats tests pass ✓

### Phase 3: Implementation - ProgressReporter (GREEN)

- [ ] Implement `ProgressReporter` class:
  - `__init__(self, verbose: bool = False)`
  - Initialize `self.verbose`, `self.stats`, `self.current_phase`
  - Initialize spinner: `self.spinner_frames = "⠋⠙⠹⠸⠼⠴⠦⠧⠇⠏"`, `self.spinner_active = False`
- [ ] Implement `start(self)`:
  - Set `stats.start_time = time.time()`
  - If verbose: print "→ Starting indexing..." to stderr
  - If not verbose: Initialize `self.spinner_start_time = None` (will be set on first update after 5s elapsed)
- [ ] Implement `phase(self, name: str)`:
  - Set `self.current_phase = name`
  - If verbose: print f"→ {name}" to stderr
- [ ] Implement `update(self, commits=0, blobs=0, chunks=0, tokens=0, cost=0.0)`:
  - Update stats fields (accumulate counts)
  - If not verbose and elapsed >5s:
    - Use `sys.stdout.write('\r...')` to overwrite line with spinner
    - Track `last_spinner_update` to throttle updates (update every 0.1s)
    - Show: "⠋ Indexing... 8.3s" (cycle through spinner_frames)
  - If verbose and milestone (blobs % 100 == 0): print progress to stderr
- [ ] Implement `record_error(self)`:
  - Increment `stats.errors`
- [ ] Implement `finish(self)`:
  - Calculate elapsed time
  - If verbose: call `_print_verbose_summary()`
  - Else: call `_print_terse_summary()`
- [ ] Implement `_print_terse_summary(self, elapsed: float)`:
  - Print to stdout: "Indexed N commits (M unique blobs) in X.Xs"
  - Print to stdout: "Tokens: N | Cost: $X.XXXX"
  - If errors > 0: print to stderr: "Errors: N"
- [ ] Implement `_print_verbose_summary(self, elapsed: float)`:
  - Print to stderr: "\n✓ Indexing Complete\n"
  - Print statistics table to stderr:
    - Commits, Unique blobs, Chunks, Tokens, Cost, Time
  - If errors > 0: print error count to stderr
- [ ] Run unit tests - all ProgressReporter tests pass ✓

### Phase 4: BDD Implementation - Scenario 1 (Terse Output)

- [ ] Open `tests/e2e/steps/progress_steps.py`
- [ ] Implement `@given('a repository with {n} files to index')`:
  - Use `e2e_git_repo_factory` to create repo with n Python files
  - Store repo path in context
- [ ] Implement `@when('I run "gitctx index" with mocked embedder')`:
  - Run subprocess with `e2e_git_isolation_env`
  - Use mocked embedder: `isolated_env` fixture (clears OPENAI_API_KEY)
  - Capture stdout, stderr, exit_code in context
- [ ] Implement `@then('I should see single-line output matching {pattern}')`:
  - Parse stdout with regex pattern
  - Assert match found: "Indexed \d+ commits \(\d+ unique blobs\) in \d+\.\d+s"
- [ ] Implement `@then('cost summary should show format {pattern}')`:
  - Parse stdout for cost line
  - Assert format matches: "$\d+\.\d{4}"
- [ ] Run BDD test: `uv run pytest tests/e2e/features/progress_tracking.feature::test_default_terse_output`
  - Verify Scenario 1 passes ✓

### Phase 5: BDD Implementation - Scenario 2 (Verbose Output)

- [ ] Implement `@when('I run "gitctx index --verbose" with mocked embedder')`:
  - Run subprocess with --verbose flag
  - Capture stdout, stderr (verbose uses stderr per TUI_GUIDE)
- [ ] Implement `@then(parsers.parse('I should see phase markers "{marker1}" and "{marker2}"'))`:
  - Import parsers from pytest_bdd
  - Parse stderr for phase markers (feature file line 18)
  - Assert marker1 in stderr (marker1 = "→ Walking commit graph")
  - Assert marker2 in stderr (marker2 = "→ Generating embeddings")
- [ ] Implement `@then('final summary should show statistics table with fields:')`:
  - Step accepts table parameter (feature file lines 19-26)
  - Parse stderr for "✓ Indexing Complete"
  - For each row in table.rows:
    - Extract field name and expected format pattern
    - Assert field present in stderr with matching format (regex)
  - Example: "Commits:" line should match "\d+" pattern
- [ ] Run BDD test: `uv run pytest tests/e2e/features/progress_tracking.feature::test_verbose_mode_with_phase_progress`
  - Verify Scenario 2 passes ✓

### Phase 6: Verification

- [ ] Run all unit tests: `uv run pytest tests/unit/indexing/test_progress_reporter.py -v`
  - Assert all unit tests pass (5+ tests)
- [ ] Run BDD tests: `uv run pytest tests/e2e/features/progress_tracking.feature -v`
  - Assert 2/5 scenarios passing (Scenarios 1-2 only)
- [ ] Run type checking: `uv run mypy src/gitctx/indexing/progress.py`
- [ ] Run linting: `uv run ruff check src tests`
- [ ] Run formatting: `uv run ruff format src tests`
- [ ] Check code coverage: `uv run pytest --cov=src/gitctx/indexing/progress tests/unit/indexing/test_progress_reporter.py`
  - Assert coverage >90%

## Files to Create/Modify

- CREATE: `src/gitctx/indexing/progress.py` (~150 lines, IndexingStats + ProgressReporter)
- CREATE: `tests/unit/indexing/test_progress_reporter.py` (~100 lines, ~5 unit tests)
- MODIFY: `tests/e2e/steps/progress_steps.py` (implement ~6 steps for Scenarios 1-2)

## Pattern Reuse

- **Mocked embedder** (existing pattern):
  - Use `isolated_env` fixture ([tests/unit/conftest.py:19-46](../../../../tests/unit/conftest.py#L19-L46))
  - Mock OpenAI API with `AsyncMock` ([tests/unit/embeddings/test_openai_embedder.py:70-75](../../../../tests/unit/embeddings/test_openai_embedder.py#L70-L75))
- **`e2e_git_repo_factory`** ([tests/e2e/conftest.py:254-356](../../../../tests/e2e/conftest.py#L254-L356)) - Create test repos
- **`e2e_git_isolation_env`** ([tests/e2e/conftest.py:40-132](../../../../tests/e2e/conftest.py#L40-L132)) - Subprocess environment
- **`context` fixture** ([tests/e2e/steps/cli_steps.py:12-15](../../../../tests/e2e/steps/cli_steps.py#L12-L15)) - BDD step state

## Testing Notes

**Unit Tests:**
- Test both terse and verbose modes separately
- Mock time.time() for deterministic elapsed time tests
- Test edge cases: zero values, empty repo
- Capture stdout/stderr for assertion

**E2E Tests:**
- Use mocked embedders (no real API calls)
- Small test repos (10 files) for fast execution
- All tests run in tmp_path (auto_isolate_e2e_working_directory fixture)
- Parse stdout for terse mode, stderr for verbose mode
- TUI_GUIDE sets NO_COLOR=1, so test text output (no ANSI codes)

**Critical Constraint:**
- NEVER write to `.gitctx` directory in gitctx repo itself
- All test outputs go to tmp_path

## Dependencies

- No external dependencies (standard library only: time, sys, dataclasses)
- Existing E2E fixtures ✅
- pytest-bdd configured ✅

## Success Criteria

- ✅ All unit tests pass (5+ tests covering IndexingStats and ProgressReporter)
- ✅ ProgressReporter implements terse and verbose modes per TUI_GUIDE.md
- ✅ BDD Scenarios 1-2 pass (terse output, verbose mode)
- ✅ 2/5 BDD scenarios passing
- ✅ Code coverage >90% for progress.py
- ✅ No mypy errors
- ✅ No ruff errors

## Notes

- **TUI_GUIDE compliant**: No Rich progress bars, simple print() statements
- **Default is terse**: Single-line output (git-like)
- **Verbose is detailed**: Phase markers, statistics table
- **Stderr for verbose**: Per TUI_GUIDE.md conventions
- **Stdout for results**: Final summary always goes to stdout
- **Fast and simple**: No complex rendering, <1ms overhead

---

**Created**: 2025-10-11
**Last Updated**: 2025-10-11
