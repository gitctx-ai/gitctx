# TASK-0001.2.3.1: Write BDD scenarios for embedding generation

**Parent**: [STORY-0001.2.3](README.md)
**Status**: ðŸ”µ Not Started
**Estimated Hours**: 2
**Actual Hours**: -

## Objective

Create complete BDD specification for embedding generation feature by writing all scenarios in Gherkin format and stubbing step definitions. This defines **WHAT** the system should do before implementing **HOW**.

## Implementation Checklist

### Create Feature File
- [ ] Create `tests/e2e/features/embedding.feature`
- [ ] Add Feature header with user story from parent story
- [ ] Add Background section (common setup: API key configured, test repo)
- [ ] Copy all 10 scenarios from story README with proper Gherkin syntax:
  - [ ] Scenario 1: Generate embedding for single chunk
  - [ ] Scenario 2: Batch process multiple chunks efficiently
  - [ ] Scenario 3: Handle rate limit errors with exponential backoff
  - [ ] Scenario 4: Handle network errors gracefully
  - [ ] Scenario 5: Cache embeddings by blob SHA
  - [ ] Scenario 6: Generate new embeddings for uncached blobs
  - [ ] Scenario 7: Validate embedding dimensions
  - [ ] Scenario 8: Track API costs accurately
  - [ ] Scenario 9: Log progress during batch processing
  - [ ] Scenario 10: Reject initialization without API key
- [ ] Verify Gherkin syntax: `uv run pytest --collect-only tests/e2e/features/embedding.feature`

### Create Step Definition Stubs
- [ ] Create `tests/e2e/steps/test_embedding.py`
- [ ] Add pytest-bdd imports (`@given`, `@when`, `@then`, `parsers`)
- [ ] Stub all unique steps with `NotImplementedError` and task reference:
  - [ ] "Given OpenAI API key is configured"
  - [ ] "Given a git repository with {n:d} code chunks"
  - [ ] "When I generate embeddings for the chunks"
  - [ ] "When I generate embeddings for {n:d} chunks"
  - [ ] "Then embeddings should have exactly 3072 dimensions"
  - [ ] "Then the cost should be approximately ${amount}"
  - [ ] "Then embeddings should be cached by blob SHA"
  - [ ] "Then progress should be logged"
  - [ ] "When OpenAI API returns rate limit error"
  - [ ] "Then retry with exponential backoff"
  - [ ] "When network error occurs"
  - [ ] "Then handle gracefully and retry"
  - [ ] "Given GitCtxSettings has no OpenAI API key configured"
  - [ ] "When I attempt to initialize the OpenAIEmbedder"
  - [ ] "Then a ConfigurationError should be raised"
- [ ] Each stub format:
  ```python
  @when(parsers.parse("I generate embeddings for {n:d} chunks"))
  def generate_embeddings(n: int):
      raise NotImplementedError("Implement in TASK-0001.2.3.3")
  ```

### Register with pytest-bdd
- [ ] Add `"tests.e2e.steps.test_embedding"` to `pytest_plugins` list in `tests/conftest.py`
- [ ] Run collection test: `uv run pytest tests/e2e/features/embedding.feature --collect-only`
- [ ] Verify all 10 scenarios discovered

### Verification
- [ ] Run BDD tests: `uv run pytest tests/e2e/features/embedding.feature -v`
- [ ] All 10 scenarios fail with `NotImplementedError` âœ“ (expected)
- [ ] No syntax errors in feature file
- [ ] No import errors in step definitions
- [ ] BDD Progress: 0/10 scenarios (all failing as expected)

## Pattern Reuse

**Existing Patterns to Follow:**
- Feature file structure: `tests/e2e/features/chunking.feature`
- Step definition stubs: `tests/e2e/steps/test_chunking.py`
- Gherkin guidelines: `tests/e2e/CLAUDE.md:124-149`

**Fixtures Available:**
- `e2e_git_isolation_env` (tests/e2e/conftest.py:41) - Subprocess-safe environment
- `e2e_git_repo_factory` (tests/e2e/conftest.py:254) - Custom test repos
- `e2e_cli_runner` (tests/e2e/conftest.py:135) - CLI execution

## Notes

- Scenarios define acceptance criteria upfront (BDD philosophy)
- Step stubs should raise NotImplementedError with task reference
- Use exact scenarios from story README (no changes unless approved)
- Security: Use `e2e_git_isolation_env` to prevent real git config access
- This task creates **failing tests** that drive implementation in later tasks

## Expected Outcome

**BDD Progress**: 0/10 scenarios (all failing)
**Result**: Complete BDD specification ready to drive TDD implementation

---

**Created**: 2025-10-07
**Last Updated**: 2025-10-07
