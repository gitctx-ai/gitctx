# TASK-0001.2.4.1: Write ALL 10 BDD Scenarios

**Parent**: [STORY-0001.2.4](README.md)
**Status**: âœ… Complete
**Estimated Hours**: 2
**Actual Hours**: 2

## Objective

Define complete user-facing behavior FIRST following incremental BDD pattern. Write all 10 BDD scenarios in Gherkin format with stubbed step definitions, establishing the acceptance criteria before any implementation begins.

## Acceptance Criteria

- [x] Feature file created at `tests/e2e/features/lancedb_storage.feature`
- [x] All 10 BDD scenarios written in Gherkin format with concrete Given/When/Then
- [x] Scenarios cover: denormalized storage, batch insertion, IVF-PQ indexing, incremental updates, index state tracking, schema validation, statistics, query with context, empty index, storage location
- [x] Step definitions file created at `tests/e2e/steps/lancedb_storage_steps.py`
- [x] All step definitions stubbed with `raise NotImplementedError("Step not implemented")`
- [x] Running BDD tests shows 0/10 scenarios passing (all fail with "Step not implemented")
- [x] Feature file includes Background section for common setup
- [x] All scenarios use concrete values (no "some", "several", "many")
- [x] Step definitions use `@given`, `@when`, `@then` decorators from pytest-bdd
- [x] Context fixture used to share state between steps
- [x] Test file created at `tests/e2e/test_lancedb_storage_features.py` to import scenarios

## Files to Create

1. **`tests/e2e/features/lancedb_storage.feature`**
   (Note: File name `lancedb_storage` matches module name for consistency)
   - Feature description with As/I want/So that format
   - Background section (common setup)
   - 10 scenarios from story README (concrete values)

2. **`tests/e2e/steps/lancedb_storage_steps.py`**
   - Import pytest-bdd decorators
   - Import context fixture from conftest
   - Stub all step definitions with NotImplementedError
   - Document which steps map to which tasks

## BDD Scenario List

All 10 scenarios stubbed (0/10 passing):

1. **Store embeddings with denormalized metadata** - Verify 100 embeddings from 10 blobs stored with complete BlobLocation metadata
2. **Batch insertion for efficiency** - Verify 5000 embeddings insert in <10 seconds
3. **Automatic IVF-PQ indexing** - Verify 300 vectors trigger IVF-PQ index creation
4. **Incremental updates** - Verify 50 new chunks added to 1000 existing chunks
5. **Index state tracking** - Verify metadata includes last_commit, indexed_blobs, timestamp
6. **Schema validation** - Verify dimension mismatch (3072 vs 1024) raises clear error
7. **Statistics reporting** - Verify 5000 chunks from 100 files produce accurate stats
8. **Query with blob location context** - Verify search results include complete context (file_path, line range, commit info)
9. **Empty index handling** - Verify newly initialized store returns zero counts
10. **Storage location** - Verify database created at `.gitctx/lancedb/` and gitignored

## Implementation Plan

### Step 1: Create Feature File (45 minutes)

Copy scenarios from story README into Gherkin format:

```gherkin
Feature: LanceDB Vector Storage
  As the indexing system
  I want to store embeddings with denormalized metadata in LanceDB
  So that semantic search can retrieve precise code locations with full git context in a single query

  Background:
    Given gitctx is installed
    And I am in an isolated test repository

  Scenario: Store embeddings with denormalized metadata
    Given 100 embeddings from 10 blobs
    And each embedding has associated BlobLocation metadata
    When I store embeddings in LanceDB
    Then each vector should be stored with denormalized metadata
    And metadata should include: blob_sha, chunk_index, file_path, line range, commit info
    And I should be able to query and get complete context in one operation

  # ... 9 more scenarios
```

### Step 2: Create Step Definitions (45 minutes)

Stub all steps with NotImplementedError:

```python
# tests/e2e/steps/lancedb_storage_steps.py

import pytest
from pytest_bdd import given, when, then, parsers


@pytest.fixture
def context() -> dict:
    """Shared context between steps."""
    return {}


# TASK-2 will implement these steps
@given(parsers.parse("{count:d} embeddings from {blob_count:d} blobs"))
def embeddings_from_blobs(count: int, blob_count: int, context: dict):
    raise NotImplementedError("Step not implemented - will complete in TASK-2")


# TASK-3 will implement these steps
@when("I store embeddings in LanceDB")
def store_embeddings(context: dict):
    raise NotImplementedError("Step not implemented - will complete in TASK-3")


# TASK-4 will implement these steps
@then("metadata should include: blob_sha, chunk_index, file_path, line range, commit info")
def verify_metadata_fields(context: dict):
    raise NotImplementedError("Step not implemented - will complete in TASK-4")

# ... stub all other steps similarly
```

### Step 3: Verify BDD Failures (15 minutes)

Run BDD tests to confirm all fail correctly:

```bash
uv run pytest tests/e2e/features/lancedb_storage.feature -v

# Expected output:
# 10 scenarios: 0 passed, 10 failed
# All fail with "NotImplementedError: Step not implemented"
```

### Step 4: Document Step-to-Task Mapping (15 minutes)

Add comments to step file showing which task implements each step:

```python
# Step Implementation Plan:
# TASK-2 (Foundation): @given steps for test data setup
# TASK-3 (Core Ops): @when steps for storage operations
# TASK-4 (Integration): @then steps for verification
```

## Testing

**BDD Test Command**:
```bash
uv run pytest tests/e2e/features/lancedb_storage.feature -v
```

**Expected Result**: 0/10 scenarios passing (all fail with NotImplementedError)

**Progress Tracking**:
```markdown
BDD Progress: 0/10 scenarios passing ðŸ”´
- All scenarios fail with "Step not implemented" âœ“
- Feature file follows Gherkin best practices âœ“
- Step definitions properly stubbed âœ“
```

## Dependencies

**Required**:
- pytest-bdd installed (already in pyproject.toml)
- `tests/e2e/conftest.py` with context fixture

**Blocks**:
- TASK-0001.2.4.2 (needs scenarios defined)
- TASK-0001.2.4.3 (needs scenarios defined)
- TASK-0001.2.4.4 (needs scenarios defined)

## Success Criteria

Task complete when:

- âœ… Feature file exists with 10 concrete Gherkin scenarios
- âœ… Step definitions file exists with all steps stubbed
- âœ… Running BDD tests shows 0/10 passing (all fail with NotImplementedError)
- âœ… No vague terms in scenarios (all use concrete numbers: "100 embeddings", "5000 chunks", "300 vectors")
- âœ… Background section defines common setup
- âœ… Step-to-task mapping documented in comments

## Notes

**Incremental BDD Pattern**: This task establishes the complete behavior specification before any implementation. Subsequent tasks will incrementally implement step definitions, progressing from 0/10 â†’ 2/10 â†’ 7/10 â†’ 10/10 scenarios passing.

**Why BDD First**: Writing scenarios first forces us to think from the user's perspective and prevents implementation-driven design. The scenarios become living documentation and acceptance tests.

**Concrete Values**: All scenarios use specific numbers (100 embeddings, 5000 chunks, 300 vectors) rather than vague terms ("some", "many", "several") to enable precise verification.

---

**Created**: 2025-10-08
**Last Updated**: 2025-10-08
