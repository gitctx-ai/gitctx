# TASK-0001.2.2.2: Define protocols, models, and language detection (with tests)

**Parent**: [STORY-0001.2.2](README.md)
**Status**: ✅ Complete
**Estimated Hours**: 3
**Actual Hours**: 3

## Implementation Checklist

### Define Interfaces

- [x] Create `CodeChunk` dataclass in `src/gitctx/core/models.py`
  - [x] Field: `content: str` - Chunk text content
  - [x] Field: `start_line: int` - Line number where chunk starts
  - [x] Field: `end_line: int` - Line number where chunk ends
  - [x] Field: `token_count: int` - Exact token count via tiktoken
  - [x] Field: `metadata: dict[str, Any]` - blob_sha, chunk_index, language, etc.
  - [x] All fields use primitive types (no Path objects for FFI compatibility)
  - [x] Add comprehensive docstring with examples
- [x] Create `ChunkerProtocol` in `src/gitctx/core/protocols.py`
  - [x] Method: `chunk_file(content: str, language: str, max_tokens: int) -> list[CodeChunk]`
  - [x] Method: `count_tokens(text: str) -> int`
  - [x] Add protocol docstring explaining future Rust optimization
- [x] Create language detection module `src/gitctx/core/language_detection.py`
  - [x] Define `EXTENSION_TO_LANGUAGE` dict with 60+ extensions covering all 27 LangChain-supported languages
  - [x] Define `LANGUAGE_TO_LANGCHAIN` dict mapping gitctx language names to LangChain codes
  - [x] Implement `detect_language_from_extension(file_path: str) -> str`
  - [x] Implement `get_langchain_language(language: str) -> str | None` for testable/replaceable mapping
  - [x] Default fallback to "markdown" for unknown extensions
  - [x] Add docstring with design rationale and LangChain source reference

### Unit Tests

- [x] Write unit tests for language detection (tests/unit/core/test_language_detection.py)
  - [x] Test common extensions (.py → python, .js → js, .go → go)
  - [x] Test ambiguous extensions (.h → cpp)
  - [x] Test unknown extensions → markdown fallback
  - [x] Test case insensitivity (.PY → python)
  - [x] Test edge cases (no extension, multiple dots, hidden files)
- [x] Write unit tests for models (tests/unit/core/test_models.py)
  - [x] Test CodeChunk creation with all fields
  - [x] Test CodeChunk with minimal metadata
  - [x] Verify all fields are primitive types

### BDD Implementation (Relevant Scenarios)

- [x] Implement BDD steps for language detection in `tests/e2e/steps/test_chunking.py`
  - [x] Scenario 6 partial: "Multiple language support" - language detection works (deferred to TASK-3)
  - [x] Scenario 7 partial: "Chunk metadata completeness" - metadata structure correct (deferred to TASK-4)
  - [x] Scenario 8 full: "Empty content handling" - can test with stub chunker

### Verification

- [x] All unit tests pass (100% coverage for language_detection.py)
- [x] Relevant BDD steps implemented (Scenario 8 complete)
- [x] Documentation updated

## Pattern Reuse

**Existing Patterns:**

- `BlobRecord` dataclass (src/gitctx/core/models.py) - Follow same primitive-types-only pattern
- `WalkerProtocol` (src/gitctx/core/protocols.py) - Follow same protocol structure

## Test Requirements

**Unit Tests:**

- Language detection: 5+ test cases
- CodeChunk model: 2+ test cases
- >95% coverage for language_detection.py

**BDD Steps (Partial Implementation):**

- Language detection works
- Metadata structure defined
- Empty content handling (can stub chunker)

## Verification Criteria

- CodeChunk dataclass exists with correct field types
- ChunkerProtocol defines required methods
- Language detection works for 20+ common extensions
- All types are FFI-friendly (primitives only)
- Unit tests pass
- Relevant BDD steps implemented

## Files to Create/Modify

- `src/gitctx/core/models.py` (modify - add CodeChunk)
- `src/gitctx/core/protocols.py` (modify - add ChunkerProtocol)
- `src/gitctx/core/language_detection.py` (new)
- `tests/unit/core/test_language_detection.py` (new)
- `tests/unit/core/test_models.py` (modify - add CodeChunk tests)
- `tests/e2e/steps/test_chunking.py` (modify - implement relevant steps)

## Dependencies

- TASK-0001.2.2.1 (BDD scenarios written)

## Notes

- This task creates the foundation interfaces
- BDD steps can use mocks/stubs for chunker if needed
- Focus on language detection and data structures
- Chunking logic comes in next task
- Some BDD scenarios will partially pass after this task
- **Language mapping design**: Extracted `get_langchain_language()` as separate function for independent testability and replaceability
- **Complete LangChain coverage**: All 27 supported languages mapped with 60+ file extensions
- **Source reference**: https://github.com/langchain-ai/langchain/blob/master/libs/text-splitters/langchain_text_splitters/base.py

---

**Created**: 2025-10-07
**Last Updated**: 2025-10-07
