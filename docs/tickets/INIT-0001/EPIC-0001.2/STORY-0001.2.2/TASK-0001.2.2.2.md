# TASK-0001.2.2.2: Define protocols, models, and language detection (with tests)

**Parent**: [STORY-0001.2.2](README.md)
**Status**: ðŸ”µ Not Started
**Estimated Hours**: 3
**Actual Hours**: _____

## Implementation Checklist

### Define Interfaces

- [ ] Create `CodeChunk` dataclass in `src/gitctx/core/models.py`
  - [ ] Field: `content: str` - Chunk text content
  - [ ] Field: `start_line: int` - Line number where chunk starts
  - [ ] Field: `end_line: int` - Line number where chunk ends
  - [ ] Field: `token_count: int` - Exact token count via tiktoken
  - [ ] Field: `metadata: dict[str, Any]` - blob_sha, chunk_index, language, etc.
  - [ ] All fields use primitive types (no Path objects for FFI compatibility)
  - [ ] Add comprehensive docstring with examples
- [ ] Create `ChunkerProtocol` in `src/gitctx/core/protocols.py`
  - [ ] Method: `chunk_file(content: str, language: str, max_tokens: int) -> list[CodeChunk]`
  - [ ] Method: `count_tokens(text: str) -> int`
  - [ ] Add protocol docstring explaining future Rust optimization
- [ ] Create language detection module `src/gitctx/core/language_detection.py`
  - [ ] Define `EXTENSION_TO_LANGUAGE` dict with ~20 common extensions
  - [ ] Implement `detect_language_from_extension(file_path: str) -> str`
  - [ ] Default fallback to "markdown" for unknown extensions
  - [ ] Add docstring with design rationale

### Unit Tests

- [ ] Write unit tests for language detection (tests/unit/core/test_language_detection.py)
  - [ ] Test common extensions (.py â†’ python, .js â†’ js, .go â†’ go)
  - [ ] Test ambiguous extensions (.h â†’ cpp)
  - [ ] Test unknown extensions â†’ markdown fallback
  - [ ] Test case insensitivity (.PY â†’ python)
  - [ ] Test edge cases (no extension, multiple dots, hidden files)
- [ ] Write unit tests for models (tests/unit/core/test_models.py)
  - [ ] Test CodeChunk creation with all fields
  - [ ] Test CodeChunk with minimal metadata
  - [ ] Verify all fields are primitive types

### BDD Implementation (Relevant Scenarios)

- [ ] Implement BDD steps for language detection in `tests/e2e/steps/test_chunking.py`
  - [ ] Scenario 6 partial: "Multiple language support" - language detection works
  - [ ] Scenario 7 partial: "Chunk metadata completeness" - metadata structure correct
  - [ ] Scenario 8 full: "Empty content handling" - can test with stub chunker

### Verification

- [ ] All unit tests pass (>95% coverage for language_detection.py)
- [ ] Relevant BDD steps implemented (may use mocks for chunker if needed)
- [ ] Documentation updated

## Pattern Reuse

**Existing Patterns:**
- `BlobRecord` dataclass (src/gitctx/core/models.py) - Follow same primitive-types-only pattern
- `WalkerProtocol` (src/gitctx/core/protocols.py) - Follow same protocol structure

## Test Requirements

**Unit Tests:**
- Language detection: 5+ test cases
- CodeChunk model: 2+ test cases
- >95% coverage for language_detection.py

**BDD Steps (Partial Implementation):**
- Language detection works
- Metadata structure defined
- Empty content handling (can stub chunker)

## Verification Criteria

- CodeChunk dataclass exists with correct field types
- ChunkerProtocol defines required methods
- Language detection works for 20+ common extensions
- All types are FFI-friendly (primitives only)
- Unit tests pass
- Relevant BDD steps implemented

## Files to Create/Modify

- `src/gitctx/core/models.py` (modify - add CodeChunk)
- `src/gitctx/core/protocols.py` (modify - add ChunkerProtocol)
- `src/gitctx/core/language_detection.py` (new)
- `tests/unit/core/test_language_detection.py` (new)
- `tests/unit/core/test_models.py` (modify - add CodeChunk tests)
- `tests/e2e/steps/test_chunking.py` (modify - implement relevant steps)

## Dependencies

- TASK-0001.2.2.1 (BDD scenarios written)

## Notes

- This task creates the foundation interfaces
- BDD steps can use mocks/stubs for chunker if needed
- Focus on language detection and data structures
- Chunking logic comes in next task
- Some BDD scenarios will partially pass after this task

---

**Created**: 2025-10-07
**Last Updated**: 2025-10-07
