# TASK-0001.2.2.4: Integration with CommitWalker, configuration, and final BDD scenario

**Parent**: [STORY-0001.2.2](README.md)
**Status**: âœ… Complete
**Estimated Hours**: 4
**Actual Hours**: 4

## Implementation Checklist

### Integration Tests First

- [x] Write integration tests in `tests/unit/core/test_chunker_integration.py`
  - [x] Test walker â†’ language detection â†’ chunker pipeline with real BlobRecord
  - [x] Test blob_sha injection into chunk metadata
  - [x] Test UTF-8 decode error handling (skip blob, continue processing)
  - [x] Test metadata completeness (blob_sha, chunk_index, language, etc.)
  - [x] Test configuration loading from settings
- [x] Run integration tests - should fail (implementation doesn't exist yet) ðŸ”´

### Configuration Implementation

- [x] Extend existing `IndexSettings` in `RepoConfig` with chunking configuration
  - [x] **Note**: `IndexSettings` already exists in `src/gitctx/core/repo_config.py` with `chunk_size` and `chunk_overlap` fields from prototype
  - [x] **Integration pattern**: IndexSettings is a field in RepoConfig, accessed via `settings.repo.index.*` or `settings.get("index.max_chunk_tokens")`
  - [x] **Key routing**: `index.*` keys automatically route to RepoConfig per GitCtxSettings router design (see `src/gitctx/core/config.py` line 18)
  - [x] Add new field: `max_chunk_tokens: int = 800` with validation (100 â‰¤ x â‰¤ 8191)
  - [x] Add new field: `chunk_overlap_ratio: float = 0.2` with validation (0.0 â‰¤ x â‰¤ 0.5)
  - [x] Add docstrings explaining model-specific token limits (text-embedding-3-large: 8191 max, conservative default: 800)
  - [x] **Validation consistency**: Use Pydantic `Field` validators with `ge`/`le` parameters, matching existing settings pattern (SearchSettings, ModelSettings)
- [x] Write config tests in `tests/unit/core/test_repo_config.py`
  - [x] Test new IndexSettings fields with default values (max_chunk_tokens=800, chunk_overlap_ratio=0.2)
  - [x] Test max_chunk_tokens validation (100 â‰¤ x â‰¤ 8191, reject values outside range)
  - [x] Test chunk_overlap_ratio validation (0.0 â‰¤ x â‰¤ 0.5, reject values outside range)
  - [x] Test IndexSettings accessible via RepoConfig and GitCtxSettings.get("index.max_chunk_tokens")

### Integration Implementation

- [x] Document chunking pipeline orchestration in story README
  - [x] Show: walker â†’ language detection â†’ chunker â†’ chunks with metadata
  - [x] Verify example code is correct
- [x] Implement blob_sha injection pattern
  - [x] After chunking: `chunk.metadata["blob_sha"] = blob_record.sha`
  - [x] Ensure chunk metadata complete before passing downstream
- [x] Implement UTF-8 error handling
  - [x] Wrap `blob_record.content.decode("utf-8")` in try/except
  - [x] Catch `UnicodeDecodeError` for invalid UTF-8 blobs
  - [x] Skip blob and log to WalkStats.errors with error_type: "invalid_encoding"
  - [x] Continue processing remaining blobs
- [x] Verify integration with existing CommitWalker
  - [x] Import BlobRecord from models
  - [x] Use detect_language_from_extension from language_detection
  - [x] Use create_chunker factory from chunker
  - [x] Chain components correctly
- [x] Integration tests pass ðŸŸ¢

### BDD Implementation (Final Scenario)

- [x] Implement final BDD scenario in `tests/e2e/steps/test_chunking.py`
  - [x] Scenario 7: "Chunk metadata completeness"
    - [x] @given: Blob chunked into 5 pieces (with blob_sha injection)
    - [x] @when: Examine metadata
    - [x] @then: Verify all fields (content, start_line, end_line, token_count, metadata dict with blob_sha)
- [x] Run ALL BDD scenarios - all 9 should pass ðŸŸ¢

### Verification

- [x] All integration tests pass
- [x] Configuration tests pass
- [x] UTF-8 errors handled gracefully (no crash)
- [x] Pipeline chains correctly
- [x] Metadata is complete (including blob_sha)
- [x] **ALL 9 BDD scenarios pass** âœ…
- [x] Documentation updated

## Pattern Reuse

**Existing Patterns:**

- `IndexSettings` in `RepoConfig` (src/gitctx/core/repo_config.py) - Extend existing class, don't create new
- `SearchSettings`, `ModelSettings` nested models - Follow same validation pattern
- GitCtxSettings router (src/gitctx/core/config.py) - `index.*` keys automatically route to RepoConfig
- Error handling in walker - Follow same try/except pattern

**Configuration Pattern (extend existing IndexSettings):**

```python
class IndexSettings(BaseModel):
    """Indexing configuration.

    Located in RepoConfig (.gitctx/config.yml).
    Accessed via settings.repo.index.* or settings.get("index.max_chunk_tokens").
    """
    # Existing fields (from prototype):
    chunk_size: int = Field(default=1000, gt=0)
    chunk_overlap: int = Field(default=200, ge=0)
    max_blob_size_mb: int = Field(default=5, gt=0, le=100)
    refs: list[str] = Field(default_factory=lambda: ["HEAD"])
    respect_gitignore: bool = True

    # NEW fields to add (this task):
    max_chunk_tokens: int = Field(
        default=800,
        ge=100,
        le=8191,
        description="Maximum tokens per chunk for embeddings (text-embedding-3-large limit: 8191, conservative default: 800)"
    )
    chunk_overlap_ratio: float = Field(
        default=0.2,
        ge=0.0,
        le=0.5,
        description="Overlap between consecutive chunks as a ratio (0.0-0.5). Default 0.2 = 20% overlap for semantic continuity."
    )
```

**Validation Pattern Consistency:**

- Use Pydantic `Field` with `ge` (greater-or-equal), `le` (less-or-equal), `gt` (greater-than) validators
- Matches existing patterns: SearchSettings.limit, IndexSettings.max_blob_size_mb
- Clear description strings explaining ranges and model-specific constraints

## Test Requirements

**Integration Tests:**

- Walker â†’ chunker pipeline with real BlobRecord
- Language detection from file paths
- blob_sha metadata injection
- UTF-8 decode error handling
- Configuration integration

**Config Tests:**

- Default values
- Validation ranges
- Integration with GitCtxSettings

**BDD Scenarios (9/9 passing):**

- âœ“ Scenario 1: Large file with overlap
- âœ“ Scenario 2: Small blob
- âœ“ Scenario 3: Function boundaries
- âœ“ Scenario 4: Long lines
- âœ“ Scenario 5: Unicode/emoji
- âœ“ Scenario 6: Multiple languages
- âœ“ Scenario 7: Metadata completeness (FINAL - implemented in this task)
- âœ“ Scenario 8: Empty content
- âœ“ Scenario 9: Token limits

## Verification Criteria

- IndexSettings exists in GitCtxSettings
- Configuration validates correctly (ranges enforced)
- Language detection works from BlobRecord.locations
- blob_sha added to every chunk's metadata
- Invalid UTF-8 blobs skipped gracefully
- Pipeline chains correctly
- Chunk metadata complete
- **ALL 9 BDD scenarios pass** (acceptance criteria met) âœ…

## Files to Create/Modify

- `src/gitctx/core/repo_config.py` (modify - extend existing IndexSettings class with new fields)
- `tests/unit/core/test_repo_config.py` (modify - add tests for new IndexSettings fields)
- `tests/unit/core/test_chunker_integration.py` (new - integration tests for walkerâ†’chunker pipeline)
- `tests/e2e/steps/test_chunking.py` (modify - implement final BDD Scenario 7)

## Dependencies

- TASK-0001.2.2.1 (BDD scenarios written)
- TASK-0001.2.2.2 (protocols, models, language detection)
- TASK-0001.2.2.3 (chunker implementation)
- STORY-0001.2.1 (CommitWalker and BlobRecord)

## Notes

- This task focuses on wiring existing components together
- No new chunking logic - just integration glue code
- UTF-8 error handling prevents crashes on binary files
- blob_sha injection at integration layer (separation of concerns)
- max_chunk_tokens=800 is conservative for text-embedding-3-large (8191 limit)
- **Final task completes the last BDD scenario**
- **After this task: ALL acceptance criteria verified** âœ…

---

**Created**: 2025-10-07
**Last Updated**: 2025-10-07
