# TASK-0001.2.6.3: Fix Dry-Run Cost Estimation

**Parent**: [STORY-0001.2.6](README.md)
**Status**: 🔵 Not Started
**Estimated Hours**: 2
**Actual Hours**: _TBD_

## Objective

Add exact blob counting to walker and update cost estimator to use actual git history instead of heuristic file counts.

**Root Cause**: `CostEstimator.estimate_repo_cost()` uses `_get_indexable_files()` which only sees working tree files. Never walks git history or checks `index_mode`.

**Solution**: Add fast `count_unique_blobs()` method to walker and use in estimator.

## Implementation Checklist

### 1. Add Fast Counting Method to Walker

**File**: `src/gitctx/git/walker.py` (after `walk_blobs()` method, around line 420)

- [ ] Add lightweight blob counting method:
  ```python
  def count_unique_blobs(self) -> int:
      """Count unique blobs without reading content (fast for dry-run).

      Uses same deduplication logic as walk_blobs() but skips expensive
      blob content reading (blob.data). Perfect for cost estimation.

      Returns:
          Exact number of unique blobs that would be indexed

      Performance:
          - Snapshot mode: <0.1s (single tree walk)
          - History mode: ~1s for 263 commits, ~3s for 5,000 commits
          - Memory: O(blobs) for SHA set, minimal
      """
      # Walk commits and deduplicate (same logic as walk_blobs)
      for commit_metadata in self._walk_commits():
          self.stats.commits_seen += 1
          commit = self.repo.get(commit_metadata.commit_sha)
          assert commit is not None
          self._accumulate_blob_locations(commit.tree, commit_metadata)

      # Return count WITHOUT reading blob.data (no I/O!)
      return len(self.blob_locations)  # Dict keys = unique blob SHAs
  ```

### 2. Update Cost Estimator to Accept Settings

**File**: `src/gitctx/indexing/progress.py` (line 221, method signature)

- [ ] Add settings parameter:
  ```python
  def estimate_repo_cost(
      self,
      repo_path: Path,
      settings: GitCtxSettings | None = None,  # NEW parameter
  ) -> CostEstimate:
      """Estimate cost using EXACT blob count from git (no heuristic!).

      Args:
          repo_path: Path to git repository
          settings: GitCtxSettings instance (uses default if None)

      Returns:
          Cost estimate with exact blob count
      """
  ```

### 3. Use Walker for Exact Count

**File**: `src/gitctx/indexing/progress.py` (inside `estimate_repo_cost()`)

- [ ] Replace heuristic file counting with walker:
  ```python
  from gitctx.git.walker import CommitWalker

  # Get EXACT blob count (fast: <1s even for large repos)
  if settings is None:
      settings = GitCtxSettings()

  walker = CommitWalker(str(repo_path), settings)
  unique_blob_count = walker.count_unique_blobs()  # Exact, mode-aware!

  if unique_blob_count == 0:
      return {
          "total_files": 0,
          "total_lines": 0,
          "estimated_tokens": 0,
          "estimated_cost": 0.0,
          "min_cost": 0.0,
          "max_cost": 0.0,
      }

  # Sample files for token ratio (existing logic)
  indexable_files = list(self._get_indexable_files(repo_path))
  # ... existing sampling code to calculate avg_chars_per_token ...

  # Apply to EXACT blob count (not guessed file count)
  estimated_tokens = int(total_chars * unique_blob_count / avg_chars_per_token)
  estimated_cost = estimated_tokens * self.COST_PER_1K_TOKENS / 1000

  return {
      "total_files": unique_blob_count,  # Exact from git!
      "total_lines": total_lines,
      "estimated_tokens": estimated_tokens,
      "estimated_cost": estimated_cost,
      "min_cost": estimated_cost * 0.9,
      "max_cost": estimated_cost * 1.1,
  }
  ```

### 4. Update CLI to Pass Settings

**File**: `src/gitctx/indexing/pipeline.py` (around line 36-46, dry-run block)

- [ ] Pass settings to estimator:
  ```python
  if dry_run:
      estimator = CostEstimator()
      estimate = estimator.estimate_repo_cost(repo_path, settings)  # Pass settings!

      # Show mode information
      mode = settings.repo.index.index_mode
      mode_desc = "snapshot (HEAD only)" if mode == "snapshot" else "history (full git)"
      print(f"Mode:         {mode_desc}")
      print(f"Blobs:        {format_number(estimate['total_files'])}")
      print(f"Lines:        {format_number(estimate['total_lines'])}")
      print(f"Est. tokens:  {format_number(estimate['estimated_tokens'])}")
      print(f"Est. cost:    ${estimate['estimated_cost']:.2f}")
      print(f"Range:        ${estimate['min_cost']:.2f} - ${estimate['max_cost']:.2f} (±10%)")
      return
  ```

### 5. Unit Tests

**File**: `tests/unit/git/test_walker.py`

- [ ] Test count matches walk:
  ```python
  def test_count_unique_blobs_matches_walk_blobs_count(simple_git_repo: Path):
      """count_unique_blobs() should equal len(list(walk_blobs()))."""
      config = GitCtxSettings()
      walker = CommitWalker(str(simple_git_repo), config)

      # Count method (fast)
      counted = walker.count_unique_blobs()

      # Walk method (full iteration)
      walker2 = CommitWalker(str(simple_git_repo), config)
      walked = len(list(walker2.walk_blobs()))

      assert counted == walked
  ```

- [ ] Test performance:
  ```python
  def test_count_unique_blobs_is_fast(multi_commit_repo: Path):
      """count_unique_blobs() should be <1s for 100 commits."""
      import time

      config = GitCtxSettings()
      config.repo.index.index_mode = "history"
      walker = CommitWalker(str(multi_commit_repo), config)

      start = time.time()
      count = walker.count_unique_blobs()
      duration = time.time() - start

      assert count > 0
      assert duration < 1.0  # Should be fast!
  ```

**File**: `tests/unit/indexing/test_cost_estimator.py`

- [ ] Test estimator uses exact count:
  ```python
  def test_estimate_uses_exact_git_blob_count(tmp_git_repo: Path):
      """Estimator should use walker.count_unique_blobs(), not heuristic."""
      estimator = CostEstimator()
      settings = GitCtxSettings()

      estimate = estimator.estimate_repo_cost(tmp_git_repo, settings)

      # Should return exact count from git (not file count)
      assert estimate["total_files"] > 0
      # Verify it's using git (create file in working dir, shouldn't count)
      (tmp_git_repo / "uncommitted.py").write_text("print('test')")
      estimate2 = estimator.estimate_repo_cost(tmp_git_repo, settings)
      assert estimate2["total_files"] == estimate["total_files"]  # Unchanged!
  ```

- [ ] Test snapshot vs history differ:
  ```python
  def test_snapshot_vs_history_estimates_differ(multi_commit_repo: Path):
      """History mode should estimate higher cost than snapshot."""
      estimator = CostEstimator()

      # Snapshot mode
      snapshot_config = GitCtxSettings()
      snapshot_config.repo.index.index_mode = "snapshot"
      snapshot_est = estimator.estimate_repo_cost(multi_commit_repo, snapshot_config)

      # History mode
      history_config = GitCtxSettings()
      history_config.repo.index.index_mode = "history"
      history_est = estimator.estimate_repo_cost(multi_commit_repo, history_config)

      # History should be higher (more blobs)
      assert history_est["total_files"] > snapshot_est["total_files"]
      assert history_est["estimated_cost"] > snapshot_est["estimated_cost"]
  ```

### E2E Integration Test

**File**: `tests/e2e/test_cost_accuracy.py` (new file)

- [ ] Test dry-run estimate matches actual cost:
  ```python
  async def test_dry_run_estimate_matches_actual_cost(
      e2e_indexed_repo_factory,
      e2e_cli_runner,
      context,
      e2e_session_api_key,
      monkeypatch
  ):
      """Dry-run estimate should match actual cost within ±10%.

      Uses VCR cassette with small test repo (~$0.08 one-time recording cost).
      Subsequent runs replay cassette for $0.00 cost.
      """
      from gitctx.cli.main import app
      import re

      # Create small test repo (5 commits, 3 files = 8 unique blobs)
      repo_path = e2e_indexed_repo_factory(
          files={"file1.py": "def test1(): pass",
                 "file2.py": "def test2(): pass",
                 "file3.py": "def test3(): pass"},
          num_commits=5,
          add_gitignore=True
      )

      monkeypatch.chdir(repo_path)
      context["custom_env"] = {"OPENAI_API_KEY": e2e_session_api_key}

      # Get dry-run estimate
      result_dryrun = e2e_cli_runner.invoke(app, ["index", "--dry-run"])
      assert result_dryrun.exit_code == 0

      # Extract estimated cost from output
      match = re.search(r"Est\. cost:\s+\$(\d+\.\d+)", result_dryrun.stdout)
      assert match, f"Could not find estimate in output: {result_dryrun.stdout}"
      estimated_cost = float(match.group(1))

      # Run actual indexing
      result_actual = e2e_cli_runner.invoke(app, ["index"])
      assert result_actual.exit_code == 0

      # Extract actual cost from output
      match = re.search(r"Cost:\s+\$(\d+\.\d+)", result_actual.stdout)
      assert match, f"Could not find actual cost in output: {result_actual.stdout}"
      actual_cost = float(match.group(1))

      # Verify within ±10%
      percent_error = abs(actual_cost - estimated_cost) / estimated_cost
      assert percent_error < 0.10, (
          f"Estimate ${estimated_cost:.2f} vs actual ${actual_cost:.2f} "
          f"({percent_error * 100:.1f}% error, expected <10%)"
      )
  ```

**VCR Recording** (one-time):
```bash
direnv exec . uv run pytest tests/e2e/test_cost_accuracy.py::test_dry_run_estimate_matches_actual_cost --vcr-record=once
# Cost: ~$0.08 one time
# Creates cassette: tests/e2e/cassettes/test_dry_run_estimate_matches_actual_cost.yaml
```

## Verification

### Run Tests
```bash
# Unit tests
uv run pytest tests/unit/git/test_walker.py::test_count_unique_blobs_matches_walk_blobs_count -v
uv run pytest tests/unit/git/test_walker.py::test_count_unique_blobs_is_fast -v
uv run pytest tests/unit/indexing/test_cost_estimator.py::test_estimate_uses_exact_git_blob_count -v
uv run pytest tests/unit/indexing/test_cost_estimator.py::test_snapshot_vs_history_estimates_differ -v

# All tests
uv run pytest
```

### Manual Testing
```bash
# Clean slate
rm -rf .gitctx/

# Test snapshot mode dry-run
gitctx index --dry-run
# Expected:
#   Mode: snapshot (HEAD only)
#   Blobs: ~314
#   Est. cost: ~$3.27

# Test history mode dry-run
echo "index:\n  index_mode: history" > .gitctx/config.yml
gitctx index --dry-run
# Expected:
#   Mode: history (full git)
#   Blobs: ~1,158 (3-4x more)
#   Est. cost: ~$40

# Verify accuracy: run actual index and compare
gitctx index
# Actual cost should match estimate ±10%
```

### Expected Output

**Before (broken):**
```bash
$ gitctx index --dry-run
Files:        314        # ❌ Only counts working tree
Est. cost:    $3.27      # ❌ LIE! Actually $42
```

**After (fixed):**
```bash
$ gitctx index --dry-run
Mode:         snapshot (HEAD only)
Blobs:        314        # ✅ Exact from git
Est. cost:    $3.27      # ✅ Accurate
Range:        $2.94 - $3.60 (±10%)

$ gitctx index
✓ Cost: $3.24           # ✅ Matches estimate!
```

## Files Modified

| File | Lines Added | Lines Removed | Purpose |
|------|-------------|---------------|---------|
| `src/gitctx/git/walker.py` | +20 | 0 | Add count_unique_blobs() |
| `src/gitctx/indexing/progress.py` | +20 | -5 | Use exact count |
| `src/gitctx/indexing/pipeline.py` | +5 | -2 | Pass settings, show mode |
| `tests/unit/git/test_walker.py` | +25 | 0 | Count tests |
| `tests/unit/indexing/test_cost_estimator.py` | +30 | 0 | Estimator tests |

**Total**: ~100 lines added, ~7 removed

## Success Criteria

- [ ] `count_unique_blobs()` method added to walker
- [ ] Count matches full walk but runs <1s
- [ ] Estimator accepts `settings` parameter
- [ ] Estimator uses walker for exact count (not heuristic)
- [ ] Dry-run output shows mode (snapshot/history)
- [ ] Snapshot estimate ~$3, history estimate ~$42
- [ ] Actual cost matches estimate within ±10%
- [ ] All unit tests pass
- [ ] Type checking passes (`uv run mypy src`)
- [ ] Linting passes (`uv run ruff check src tests`)

## Benefits

**Accuracy:**
- **Before**: $3 estimate, $42 actual (14x error!)
- **After**: $40 estimate, $42 actual (5% error) ✅

**Performance:**
- Fast counting: <1s even for large repos
- No blob content reading (only metadata)
- Same dedup logic as actual indexing

**User Trust:**
- Accurate estimates prevent surprises
- Mode-aware (snapshot vs history)
- Clear range indication (±10%)

## Related Tasks

- **TASK-0001.2.6.1**: Uses snapshot mode for accurate count
- **TASK-0001.2.6.2**: Future: could estimate cache hit rate
- **TASK-0001.2.6.4**: Warning shows this estimate before expensive operations

## Notes

- **Breaking API**: `estimate_repo_cost()` now requires `settings` param (optional, defaults to `GitCtxSettings()`)
- Count is exact but estimate is still approximate (token ratio varies)
- ±10% range accounts for file size variation
- Fast enough for interactive CLI use (<1s response)

---

**Created**: 2025-10-15
