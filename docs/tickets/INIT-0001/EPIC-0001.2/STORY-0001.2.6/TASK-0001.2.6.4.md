# TASK-0001.2.6.4: Add History Mode Warning

**Parent**: [STORY-0001.2.6](README.md)
**Status**: ✅ Complete
**Estimated Hours**: 1
**Actual Hours**: 1.5

## Objective

Add interactive warning prompt before indexing in history mode to prevent accidental high-cost operations.

**Root Cause**: Users don't realize history mode walks entire git graph, causing 10-50x higher costs than expected.

**Solution**: Show clear warning with cost implications and require explicit confirmation.

## Implementation Checklist

### 1. Add Warning Prompt

**File**: `src/gitctx/cli/index.py` (around line 35, after dry-run check, before indexing)

- [x] Add history mode confirmation:
  ```python
  # After dry-run check, before calling index_repository()
  if not dry_run and settings.repo.index.index_mode == "history":
      from rich.console import Console
      import typer

      console = Console(stderr=True)
      console.print("\n[yellow]⚠️  History Mode Enabled[/yellow]")
      console.print("  Indexing ALL versions across full git history.")
      console.print("  Cost/time may be 10-50x higher than snapshot mode.\n")

      if not typer.confirm("Continue?", default=False):
          console.print("[dim]Cancelled.[/dim]")
          raise typer.Exit(0)
  ```

### 2. Add Bypass Flag (Optional)

**File**: `src/gitctx/cli/index.py` (command parameters)

- [x] Add `--yes` flag to skip confirmation:
  ```python
  @app.command()
  def index(
      dry_run: bool = typer.Option(False, "--dry-run"),
      verbose: bool = typer.Option(False, "--verbose", "-v"),
      yes: bool = typer.Option(False, "--yes", "-y", help="Skip confirmation prompts"),
  ):
      # ... existing code ...

      # Skip warning if --yes provided
      if not dry_run and settings.repo.index.index_mode == "history" and not yes:
          # ... show warning ...
  ```

### 3. Update Help Text

**File**: `src/gitctx/cli/index.py`

- [x] Add note to command docstring:
  ```python
  def index(...):
      """Index repository for semantic search.

      By default, indexes only the current HEAD tree (snapshot mode).
      For full history indexing, set index.index_mode to "history" in config.

      History mode requires confirmation due to higher costs (10-50x).
      Use --yes to skip confirmation prompts.
      """
  ```

### 4. Unit Tests

**File**: `tests/unit/cli/test_index.py`

- [x] Test warning shows in history mode:
  ```python
  def test_history_mode_shows_warning(
      tmp_git_repo: Path,
      cli_runner: CliRunner
  ):
      """History mode should show warning before indexing."""
      # Set history mode
      config_path = tmp_git_repo / ".gitctx" / "config.yml"
      config_path.write_text("index:\n  index_mode: history\n")

      # Run without --yes (will prompt)
      result = cli_runner.invoke(app, ["index"], input="n\n")

      # Should show warning
      assert "⚠️  History Mode Enabled" in result.output or "History Mode Enabled" in result.output
      assert "full git history" in result.output.lower()
      assert result.exit_code == 0  # Cancelled
  ```

- [x] Test --yes skips warning:
  ```python
  def test_yes_flag_skips_warning(
      tmp_git_repo: Path,
      cli_runner: CliRunner,
      mock_embedder: MockEmbedder
  ):
      """--yes flag should skip confirmation."""
      # Set history mode
      config_path = tmp_git_repo / ".gitctx" / "config.yml"
      config_path.write_text("index:\n  index_mode: history\n")

      # Run with --yes
      result = cli_runner.invoke(app, ["index", "--yes"])

      # Should NOT prompt, should proceed
      assert "Continue?" not in result.output
      # Should complete (mocked embedder returns success)
  ```

- [x] Test snapshot mode has no warning:
  ```python
  def test_snapshot_mode_no_warning(
      tmp_git_repo: Path,
      cli_runner: CliRunner,
      mock_embedder: MockEmbedder
  ):
      """Snapshot mode should not show warning."""
      # Default config (snapshot mode)
      result = cli_runner.invoke(app, ["index"])

      # Should NOT show warning
      assert "History Mode" not in result.output
      assert "Continue?" not in result.output
  ```

### 5. Integration Test

**File**: `tests/e2e/features/indexing.feature` (optional - if you want BDD coverage)

- [ ] Add scenario for history mode warning (skipped - unit tests provide sufficient coverage):
  ```gherkin
  Scenario: History mode requires confirmation
    Given a repository with history mode enabled
    When I run "gitctx index" interactively
    Then I should see warning "History Mode Enabled"
    And I should be prompted to continue
    When I answer "no"
    Then the command should exit without indexing
  ```

## Verification

### Run Tests
```bash
# Unit tests
uv run pytest tests/unit/cli/test_index_command.py::test_history_mode_shows_warning -v
uv run pytest tests/unit/cli/test_index_command.py::test_yes_flag_skips_warning -v
uv run pytest tests/unit/cli/test_index_command.py::test_snapshot_mode_no_warning -v

# All CLI tests
uv run pytest tests/unit/cli/test_index_command.py -v
```

### Manual Testing
```bash
# Test 1: Snapshot mode (no warning)
rm -rf .gitctx/
gitctx index
# Expected: No warning, proceeds normally

# Test 2: History mode with cancellation
echo "index:\n  index_mode: history" > .gitctx/config.yml
gitctx index
# Expected:
#   ⚠️  History Mode Enabled
#   Indexing ALL versions across full git history.
#   Cost/time may be 10-50x higher than snapshot mode.
#
#   Continue? [y/N]:
# Type: n
# Expected: "Cancelled." and exits

# Test 3: History mode with confirmation
gitctx index
# Type: y
# Expected: Proceeds with indexing

# Test 4: Skip warning with --yes
gitctx index --yes
# Expected: No prompt, proceeds directly
```

### Expected Output

**Snapshot mode (default):**
```bash
$ gitctx index
Indexing... ━━━━━━━━━━━━━━━━━━━━ 100%
✓ Indexing Complete
```

**History mode (interactive):**
```bash
$ gitctx index

⚠️  History Mode Enabled
  Indexing ALL versions across full git history.
  Cost/time may be 10-50x higher than snapshot mode.

Continue? [y/N]: n
Cancelled.
```

**History mode (with --yes):**
```bash
$ gitctx index --yes
Indexing... ━━━━━━━━━━━━━━━━━━━━ 100%
✓ Indexing Complete
  Cost: $41.93
```

## Files Modified

| File | Lines Added | Lines Removed | Purpose |
|------|-------------|---------------|---------|
| `src/gitctx/cli/index.py` | +15 | 0 | Add warning prompt |
| `tests/unit/cli/test_index_command.py` | +40 | 0 | Unit tests |

**Total**: ~55 lines added

## Success Criteria

- [x] History mode shows warning before indexing
- [x] Warning includes cost implications (10-50x)
- [x] Confirmation defaults to No (safe default)
- [x] Answering No cancels without indexing
- [x] Answering Yes proceeds normally
- [x] `--yes` flag skips prompt
- [x] Snapshot mode has no warning
- [x] All unit tests pass
- [x] Type checking passes (`uv run mypy src`)
- [x] Linting passes (`uv run ruff check src tests`)

## Benefits

**User Safety:**
- Prevents accidental expensive operations
- Clear cost implications upfront
- Safe default (No)

**User Experience:**
- Non-blocking for automation (`--yes` flag)
- Clear messaging (yellow warning, not error)
- Only shows when needed (history mode only)

**Developer Confidence:**
- Informed consent before high-cost operations
- Aligns with dry-run philosophy (show before execute)
- Consistent with git confirmation patterns

## Related Tasks

- **TASK-0001.2.6.1**: Snapshot mode makes this warning rare (most users won't see it)
- **TASK-0001.2.6.3**: Dry-run shows accurate estimate before this prompt
- **TASK-0001.2.6.2**: Cache makes second run free even in history mode

## UX Flow

```
User: gitctx index
↓
Check mode
├─ Snapshot → Proceed (no warning)
└─ History  → Show warning
             ↓
             Confirm?
             ├─ No  → Exit (safe default)
             └─ Yes → Proceed
```

## Notes

- **Only shows for history mode** (snapshot mode is silent)
- **Default is No** (user must explicitly type "y")
- **`--yes` bypasses** (for CI/automation)
- **Printed to stderr** (doesn't pollute stdout)
- **Yellow color** (warning, not error)
- **Dry-run skips warning** (already in dry-run mode)

## Implementation Notes

**Actual Implementation (Completed 2025-10-15):**

### Files Modified

| File | Changes | Notes |
|------|---------|-------|
| `src/gitctx/cli/index.py` | Added history mode warning logic (lines 77-95) | TTY detection + interactive prompt |
| `src/gitctx/cli/main.py` | Added `skip_confirmation` parameter to wrapper | Critical fix - was missing parameter propagation |
| `tests/unit/cli/test_index.py` | Added 3 new tests (lines 279-409) | Non-TTY error path, --yes flag, snapshot mode |

### Key Implementation Details

1. **TTY Detection**: Used `sys.stdout.isatty()` to detect non-interactive environments (CI/CD)
   - Non-TTY environments require `--yes` flag (prevents hanging in automated pipelines)
   - Interactive terminals show warning and `typer.confirm()` prompt

2. **Parameter Naming**: Internal parameter named `skip_confirmation` (clearer intent) while CLI flag remains `--yes`/-y`

3. **Testing Strategy**: Tests validate non-TTY error path instead of mocking TTY
   - More reliable than mocking `isatty()` in CliRunner's isolated context
   - Covers both error path (requires --yes) and bypass path (--yes works)
   - Validates snapshot mode has no warning

4. **Bug Fix**: Wrapper function in `main.py` was missing `skip_confirmation` parameter
   - Root cause: Lazy loading pattern requires parameter propagation through wrapper
   - Symptom: Parameter showed as `<typer.models.OptionInfo object>` instead of boolean
   - Fix: Added parameter to both wrapper signature and call to `index_command()`

### Test Results

All 12 index tests pass including 3 new tests:
- `test_history_mode_requires_confirmation_non_tty` - Validates error in non-TTY environments
- `test_yes_flag_skips_confirmation` - Validates --yes bypasses warning
- `test_snapshot_mode_no_warning` - Validates default mode shows no warning

Quality gates: ✅ ruff check, ✅ ruff format, ✅ mypy, ✅ pytest

---

**Created**: 2025-10-15
**Completed**: 2025-10-15
