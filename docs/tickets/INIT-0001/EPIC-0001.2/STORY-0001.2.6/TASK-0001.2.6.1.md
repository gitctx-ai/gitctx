# TASK-0001.2.6.1: Add Snapshot Mode to Walker

**Parent**: [STORY-0001.2.6](README.md)
**Status**: âœ… Complete
**Estimated Hours**: 2
**Actual Hours**: 2

## Objective

Add `index_mode` configuration field and implement snapshot mode in CommitWalker to only process HEAD commit tree instead of walking full git history.

**Root Cause**: Current implementation walks all commits reachable from refs, causing 12.8x cost overrun when user expects only current files.

**Solution**: Add mode selection with snapshot as safe default.

## Implementation Checklist

### 1. Add Configuration Field

**File**: `src/gitctx/config/settings.py` (around line 204)

- [ ] Add `index_mode` field to `IndexSettings` class:
  ```python
  class IndexSettings(BaseModel):
      """Indexing configuration."""

      index_mode: Literal["snapshot", "history"] = Field(
          default="snapshot",
          description="snapshot=HEAD tree only, history=full git graph"
      )

      # ... existing fields (refs, exclude_patterns, etc.)
  ```

### 2. Implement Snapshot Mode in Walker

**File**: `src/gitctx/git/walker.py` (line 216, in `_walk_commits()` method)

- [ ] Add snapshot mode check at start of `_walk_commits()`:
  ```python
  def _walk_commits(self) -> Iterator[CommitMetadata]:
      """Walk commits from configured refs in reverse chronological order."""

      # NEW: Snapshot mode - only yield HEAD
      if self.config.repo.index.index_mode == "snapshot":
          try:
              head = self.repo.revparse_single("HEAD")
              yield CommitMetadata(
                  commit_sha=str(head.id),
                  author_name=head.author.name,
                  author_email=head.author.email,
                  commit_date=head.commit_time,
                  commit_message=head.message,
                  is_merge=len(head.parent_ids) > 1,
              )
          except KeyError:
              pass  # Empty repo, no commits
          return  # Early exit for snapshot mode

      # EXISTING: History mode unchanged (lines 222-259)
      for ref in self.refs:
          # ... existing history walking code
  ```

### 3. Unit Tests

**File**: `tests/unit/git/test_walker.py`

- [ ] Test snapshot mode only walks HEAD:
  ```python
  def test_snapshot_mode_only_walks_head_commit(
      simple_git_repo: Path,
      config_snapshot_mode: GitCtxSettings
  ):
      """Snapshot mode should process only HEAD, not history."""
      walker = CommitWalker(str(simple_git_repo), config_snapshot_mode)

      commits = list(walker._walk_commits())

      # Should yield exactly 1 commit (HEAD)
      assert len(commits) == 1
      assert commits[0].commit_sha == walker.repo.head.target.hex
  ```

- [ ] Test history mode walks all commits:
  ```python
  def test_history_mode_walks_all_commits(
      simple_git_repo: Path,
      config_history_mode: GitCtxSettings
  ):
      """History mode should walk full commit graph."""
      walker = CommitWalker(str(simple_git_repo), config_history_mode)

      commits = list(walker._walk_commits())

      # Should walk multiple commits
      assert len(commits) > 1
  ```

- [ ] Test default mode is snapshot:
  ```python
  def test_default_mode_is_snapshot(simple_git_repo: Path):
      """Default config should use snapshot mode."""
      config = GitCtxSettings()
      assert config.repo.index.index_mode == "snapshot"
  ```

### 4. Add Test Fixtures

**File**: `tests/unit/git/test_walker.py` or `conftest.py`

- [ ] Create snapshot mode config fixture:
  ```python
  @pytest.fixture
  def config_snapshot_mode() -> GitCtxSettings:
      """Config with snapshot mode."""
      config = GitCtxSettings()
      config.repo.index.index_mode = "snapshot"
      return config
  ```

- [ ] Create history mode config fixture:
  ```python
  @pytest.fixture
  def config_history_mode() -> GitCtxSettings:
      """Config with history mode."""
      config = GitCtxSettings()
      config.repo.index.index_mode = "history"
      return config
  ```

## Verification

### Run Tests
```bash
# Unit tests
uv run pytest tests/unit/git/test_walker.py::test_snapshot_mode_only_walks_head_commit -v
uv run pytest tests/unit/git/test_walker.py::test_history_mode_walks_all_commits -v
uv run pytest tests/unit/git/test_walker.py::test_default_mode_is_snapshot -v

# All walker tests
uv run pytest tests/unit/git/test_walker.py -v
```

### Manual Testing
```bash
# Clean slate
rm -rf .gitctx/

# Default (snapshot) should walk only HEAD
gitctx index --verbose
# Expected: "Walking 1 commit" or similar

# History mode should walk all commits
echo "index:\n  index_mode: history" > .gitctx/config.yml
gitctx index --verbose
# Expected: "Walking N commits" where N > 1
```

### Expected Behavior

**Snapshot Mode (default):**
- Walks only HEAD commit
- Processes only files in current tree
- ~314 blobs for typical repo

**History Mode (explicit):**
- Walks all commits from refs
- Processes all blob versions across history
- ~1,158 blobs for same repo (3.7x more)

## Files Modified

| File | Lines Added | Lines Removed | Purpose |
|------|-------------|---------------|---------|
| `src/gitctx/config/settings.py` | +5 | 0 | Add index_mode field |
| `src/gitctx/git/walker.py` | +15 | 0 | Implement snapshot mode |
| `tests/unit/git/test_walker.py` | +40 | 0 | Unit tests + fixtures |

**Total**: ~60 lines added, 0 removed

## Success Criteria

- [ ] Config field `index_mode` added with default "snapshot"
- [ ] Snapshot mode processes only HEAD commit
- [ ] History mode preserves existing behavior (walks all commits)
- [ ] All unit tests pass
- [ ] Manual testing confirms blob count difference
- [ ] Type checking passes (`uv run mypy src`)
- [ ] Linting passes (`uv run ruff check src tests`)

## Related Tasks

- **TASK-0001.2.6.2**: Will use this mode to determine caching strategy
- **TASK-0001.2.6.3**: Will use this mode for accurate dry-run estimation
- **TASK-0001.2.6.4**: Will warn users when history mode enabled

## Notes

- **Breaking Change**: Default changes from history to snapshot
- Users wanting old behavior: `gitctx config set index.index_mode history`
- No changes to blob deduplication logic (handled by existing walker)
- Early return in snapshot mode prevents full history walk

---

**Created**: 2025-10-15
