# TASK-0001.2.1.4: Blob Filtering

**Parent**: [STORY-0001.2.1](README.md)
**Status**: âœ… Complete
**Estimated Hours**: 7
**Actual Hours**: 7

## Implementation Checklist

- [x] Parse .gitignore from HEAD tree using pathspec library
- [x] Create pathspec.PathSpec from .gitignore patterns
- [x] Always exclude .git/ and .gitctx/ directories
- [x] Implement binary detection (null byte check)
  - [x] `is_binary = b'\0' in blob_data[:8192]`
  - [x] Fast, git-compatible heuristic
- [x] Implement Git LFS pointer detection
  - [x] Check for `version https://git-lfs.github.com/spec` header
  - [x] Skip with warning if LFS pointer found (deferred logging to TASK-0001.2.1.5)
- [x] Implement size limit filtering
  - [x] Skip blobs > max_blob_size_mb * 1024 * 1024
  - [x] Log warning to WalkStats.errors (deferred to TASK-0001.2.1.5)
- [x] All filtering happens before yielding BlobRecord
- [x] Tests pass
- [x] Documentation updated

## Pattern Reuse

**Existing Fixtures:**
- `git_repo_factory` (tests/unit/conftest.py) - Create repos with binary files, large files, gitignore
- `git_isolation_base` (tests/conftest.py) - Secure git operations
- `isolated_env` (tests/unit/conftest.py) - Environment isolation

**New Fixtures Needed:**
- None - all required fixtures exist

## Test Requirements

**Unit Tests** (tests/unit/core/test_commit_walker.py - TestBlobFiltering class):
- .gitignore patterns respected (*.pyc, node_modules/)
- Binary files skipped (null byte detection)
- Git LFS pointers detected and skipped
- Large files skipped (size limit)
- .git/ and .gitctx/ always excluded
- Text files pass filter
- Edge cases: null byte at 8192 boundary, empty files, size limits

## Verification Criteria

- Gitignore rules applied to all commits (historical and current)
- Binary files reliably detected (null byte heuristic)
- LFS pointer files skipped with warning
- Oversized blobs skipped with error logged
- Security: .git/ and .gitctx/ never indexed

## Files to Create/Modify

- `src/gitctx/core/blob_filter.py` (new)
- `src/gitctx/core/commit_walker.py` (extend - integrate filtering)
- `tests/unit/core/test_commit_walker.py` (extend - add TestBlobFiltering class)
- `pyproject.toml` (add pathspec>=0.11.0 dependency)

## Edge Cases Deferred

**Binary detection edge cases** (defer to future if users report issues):
- UTF-16 files with BOM (may have null bytes but are text)
- Complex encodings (EBCDIC, etc.)
- MVP uses null byte heuristic (same as git) - covers 99% of cases

## Dependencies

- pathspec>=0.11.0 (gitignore pattern matching)
- TASK-0001.2.1.2 complete (blob deduplication provides blobs to filter)

---

**Created**: 2025-10-06
**Last Updated**: 2025-10-06
