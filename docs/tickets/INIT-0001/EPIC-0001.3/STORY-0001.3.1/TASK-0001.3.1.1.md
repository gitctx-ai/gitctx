# TASK-0001.3.1.1: Write BDD Scenarios for Query Embedding

**Parent Story**: [STORY-0001.3.1](./README.md)
**Status**: âœ… Complete
**Estimated Hours**: 3
**Actual Hours**: 3

## Deliverable

Complete BDD test suite with 5 scenarios in `search.feature` plus stubbed step definitions. All tests failing with `NotImplementedError` (0/5 passing).

**Rationale**: BDD-first development - define expected behavior before implementation. Ensures all acceptance criteria captured as executable specifications.

## Prerequisites

- [ ] TASK-0001.3.1.0 completed (architecture refactor)
- [ ] New module structure exists with `src/gitctx/search/`

## Implementation Checklist

### Phase 1: Copy BDD Scenarios (30 min)

- [ ] Read story README scenarios (lines 44-83):
  ```bash
  cat docs/tickets/INIT-0001/EPIC-0001.3/STORY-0001.3.1/README.md | sed -n '44,83p'
  ```

- [ ] Open `tests/e2e/features/search.feature`

- [ ] Add 5 new scenarios to search.feature:
  - [ ] Scenario: Query embedding generated successfully
  - [ ] Scenario: Cached query embedding reused (no API call)
  - [ ] Scenario: Missing API key (exit code 4)
  - [ ] Scenario: Empty query validation (exit code 2)
  - [ ] Scenario: Query exceeds token limit (exit code 2)

- [ ] Create fixture file for token limit test:
  ```bash
  # Create 9000-token query fixture (approximately 36KB of text)
  python -c "print('authentication middleware security ' * 1500)" > tests/fixtures/long_query_9000_tokens.txt
  ```

- [ ] Verify Gherkin syntax:
  ```bash
  uv run pytest tests/e2e/features/search.feature --collect-only
  ```

### Phase 2: Add VCR Markers (15 min)

- [ ] Open `tests/e2e/test_search.py`

- [ ] Add VCR decorator for API recording:
  ```python
  @pytest.mark.vcr()
  def test_search_scenarios(pytestbdd_feature):
      """Search scenarios with VCR cassette recording."""
      pass  # Scenarios auto-discovered by pytest-bdd
  ```

- [ ] Verify VCR configuration in conftest:
  ```bash
  grep -A 10 "vcr_config" tests/e2e/conftest.py
  ```

- [ ] Understand VCR cassette directory structure:
  ```bash
  ls -la tests/e2e/cassettes/
  ```

### Phase 3: Create Stubbed Step Definitions (1.5 hours)

- [ ] Create `tests/e2e/steps/search_steps.py`

- [ ] Add file header and imports:
  ```python
  """Step definitions for search command E2E tests."""

  import subprocess
  from pytest_bdd import given, when, then, parsers
  ```

- [ ] Stub Given steps:
  - [ ] `@given('an indexed repository')`
    ```python
    def indexed_repository(e2e_git_isolation_env):
        raise NotImplementedError("Implement in TASK-0001.3.1.3")
    ```

  - [ ] `@given('environment variable "..." is "$ENV"')`
    ```python
    def env_var_from_real(e2e_git_isolation_env, var: str):
        raise NotImplementedError("Implement in TASK-0001.3.1.4")
    ```

  - [ ] `@given('environment variable "..." is ""')`
    ```python
    def env_var_empty(e2e_git_isolation_env, var: str):
        raise NotImplementedError("Implement in TASK-0001.3.1.4")
    ```

  - [ ] `@given('query "..." was previously searched')`
    ```python
    def query_previously_searched(e2e_git_isolation_env, query: str):
        raise NotImplementedError("Implement in TASK-0001.3.1.4")
    ```

  - [ ] `@given('a query with ... tokens')`
    ```python
    def query_with_tokens(context, token_count: int):
        raise NotImplementedError("Implement in TASK-0001.3.1.3")
    ```

- [ ] Stub When steps:
  - [ ] `@when('I run "gitctx search ..."')`
    ```python
    def run_search_command(e2e_git_isolation_env, query: str):
        raise NotImplementedError("Implement in TASK-0001.3.1.3")
    ```

- [ ] Stub Then steps:
  - [ ] `@then('the exit code should be ...')`
    ```python
    def verify_exit_code(e2e_git_isolation_env, code: int):
        raise NotImplementedError("Implement in TASK-0001.3.1.4")
    ```

  - [ ] `@then('results should be displayed')`
    ```python
    def verify_results_displayed(e2e_git_isolation_env):
        raise NotImplementedError("Implement in TASK-0001.3.1.4")
    ```

  - [ ] `@then('cached embedding should be used')`
    ```python
    def verify_cached_embedding():
        raise NotImplementedError("Implement in TASK-0001.3.1.4")
    ```

  - [ ] `@then('the output should contain "..."')`
    ```python
    def output_contains(e2e_git_isolation_env, text: str):
        raise NotImplementedError("Implement in TASK-0001.3.1.3")
    ```

- [ ] Verify all steps discovered:
  ```bash
  uv run pytest tests/e2e/features/search.feature --collect-only -v
  ```

### Phase 4: Run Tests - Verify All Fail (30 min)

- [ ] Run BDD scenarios:
  ```bash
  uv run pytest tests/e2e/features/search.feature -v
  ```

- [ ] Verify all 5 scenarios fail with `NotImplementedError`

- [ ] Check failure messages are clear:
  - Each should indicate which task will implement it
  - "Implement in TASK-0001.3.1.X"

- [ ] Document BDD progress in story:
  - Current: 0/5 scenarios passing
  - All scenarios defined âœ“
  - All steps stubbed âœ“

### Phase 5: Documentation (30 min)

- [ ] Update `tests/e2e/README.md` or `tests/e2e/CLAUDE.md` if needed:
  - Document search.feature scenarios
  - Note VCR usage for OpenAI API recording

- [ ] Add comments to search.feature explaining scenario purpose:
  ```gherkin
  # This scenario verifies query embedding generation via OpenAI API
  # VCR cassette records API response for deterministic replay
  Scenario: Query embedding generated successfully
    Given an indexed repository
    ...
  ```

- [ ] Document in story README:
  - 5 scenarios added to search.feature
  - Step definitions in search_steps.py (stubbed)
  - All tests failing as expected (BDD red phase)

### Final Verification

- [ ] All scenarios visible in test collection:
  ```bash
  uv run pytest tests/e2e/features/search.feature --collect-only | grep "Scenario"
  # Should show 5 scenarios
  ```

- [ ] All steps have stub implementations:
  ```bash
  grep -c "NotImplementedError" tests/e2e/steps/search_steps.py
  # Should show ~10 (one per step)
  ```

- [ ] No syntax errors:
  ```bash
  uv run ruff check tests/e2e/
  uv run mypy tests/e2e/steps/search_steps.py
  ```

- [ ] File structure correct:
  ```bash
  ls -la tests/e2e/features/search.feature
  ls -la tests/e2e/steps/search_steps.py
  ls -la tests/e2e/test_search.py
  ```

## Success Criteria

- [ ] 5 BDD scenarios added to search.feature
- [ ] All scenarios use proper Gherkin syntax
- [ ] VCR decorator added to test_search.py
- [ ] ~10 step definitions stubbed in search_steps.py
- [ ] All steps raise NotImplementedError with helpful message
- [ ] All 5 scenarios fail when run (expected - BDD red phase)
- [ ] No syntax errors (ruff, mypy pass)
- [ ] Documentation updated

## Pattern Reuse

- **VCR Cassettes** (`tests/e2e/conftest.py:370`): `@pytest.mark.vcr()` decorator for API recording
- **e2e_git_isolation_env** (`tests/e2e/conftest.py:41`): Isolated subprocess testing fixture
- **Step File Pattern** (existing `cli_steps.py`, `lancedb_storage_steps.py`): Organize by feature
- **Gherkin Format** (existing `.feature` files): Given-When-Then structure

## BDD Progress

**Before**: 0/5 scenarios exist
**After**: 0/5 scenarios passing (all failing with NotImplementedError)

This is expected and correct - BDD red phase. Implementation tasks will make scenarios pass incrementally.

## Files Changed

**Created**:
- `tests/e2e/steps/search_steps.py` (~100 lines, stubbed)

**Modified**:
- `tests/e2e/features/search.feature` (+50 lines, 5 scenarios)
- `tests/e2e/test_search.py` (+10 lines, VCR decorator)

**Total**: 3 files, ~160 lines

## Commit Message

```
test(TASK-0001.3.1.1): Add 5 BDD scenarios for query embedding with stubbed steps

- Add scenarios to search.feature:
  1. Query embedding generated successfully
  2. Cached query embedding reused (no API call)
  3. Missing API key (exit code 4)
  4. Empty query validation (exit code 2)
  5. Query exceeds token limit (exit code 2)

- Stub ~10 step definitions in search_steps.py
- Add @pytest.mark.vcr() for API response recording
- All tests fail with NotImplementedError (BDD red phase)

BDD Progress: 0/5 scenarios passing (all defined, ready for implementation)

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

---

**Created**: 2025-10-12
**Status**: Ready for implementation
