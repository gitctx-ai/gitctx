# TASK-0001.3.1.4: Integration and E2E Verification

**Parent Story**: [STORY-0001.3.1](./README.md)
**Status**: ðŸ”µ Not Started
**Estimated Hours**: 2
**Actual Hours**: _[To be filled on completion]_

## Deliverable

Complete query embedding feature fully integrated and tested. All 5 BDD scenarios passing (5/5). Documentation updated. Story complete and ready for PR.

**Rationale**: Final integration task ensures all components work together E2E with proper user experience, error messages, and documentation.

## Prerequisites

- [ ] TASK-0001.3.1.0 completed (architecture refactor)
- [ ] TASK-0001.3.1.1 completed (BDD scenarios defined)
- [ ] TASK-0001.3.1.2 completed (model infrastructure)
- [ ] TASK-0001.3.1.3 completed (core implementation, 4/5 scenarios passing)

- [ ] Verify module structure from TASK-0001.3.1.0:
  ```bash
  for module in search models storage config; do
    [ -d "src/gitctx/$module" ] || { echo "Error: $module/ module missing"; exit 1; }
  done
  echo "âœ“ All required modules exist"
  ```

## Implementation Checklist

### Phase 1: Complete Remaining BDD Steps (30 min)

- [ ] Open `tests/e2e/steps/search_steps.py`

- [ ] Implement `query_previously_searched` step:
  ```python
  @given('query "{query}" was previously searched')
  def query_previously_searched(e2e_git_isolation_env, query: str):
      """Pre-populate query cache by running search once."""
      # Run search once to populate cache via VCR
      result = subprocess.run(
          ["gitctx", "search", query],
          cwd=e2e_git_isolation_env["repo_path"],
          env=e2e_git_isolation_env["env"],
          capture_output=True,
          text=True
      )
      # First search should succeed
      assert result.returncode == 0, f"Initial search failed: {result.stderr}"
      # Store that we've cached this query
      e2e_git_isolation_env.setdefault("cached_queries", set()).add(query)
  ```

- [ ] Implement `verify_cached_embedding` step:
  ```python
  @then('cached embedding should be used')
  def verify_cached_embedding(e2e_git_isolation_env):
      """Verify cache was used (no new API call).

      VCR automatically verifies this - if cache wasn't used,
      it would try to make a new API call and VCR would complain
      about an unexpected request.
      """
      # If we got here without VCR error, cache was used âœ“
      pass
  ```

- [ ] Implement `verify_results_displayed` step:
  ```python
  @then('results should be displayed')
  def verify_results_displayed(e2e_git_isolation_env):
      """Verify search results shown (or success message for now)."""
      output = e2e_git_isolation_env.get("last_output", "")
      result = e2e_git_isolation_env.get("last_result")

      # For STORY-0001.3.1, we just generate embeddings
      # Full search results come in STORY-0001.3.2
      # So verify no error occurred
      assert result.returncode == 0, f"Search failed: {output}"

      # Verify success indicator
      assert ("âœ“" in output or "success" in output.lower()), \
          f"No success indicator in output: {output}"
  ```

- [ ] Verify all step implementations complete:
  ```bash
  grep -c "NotImplementedError" tests/e2e/steps/search_steps.py
  # Should show 0
  ```

### Phase 2: Run All BDD Scenarios (30 min)

- [ ] Ensure OPENAI_API_KEY set for VCR recording (first run):
  ```bash
  export OPENAI_API_KEY=sk-...  # Real key
  ```

- [ ] Run all search scenarios individually:
  ```bash
  # Scenario 1: Query embedding generated successfully
  uv run pytest tests/e2e/features/search.feature -k "query-embedding-generated-successfully" -v

  # Scenario 2: Cached query embedding reused
  uv run pytest tests/e2e/features/search.feature -k "cached-query-embedding-reused" -v

  # Scenario 3: Missing API key
  uv run pytest tests/e2e/features/search.feature -k "missing-api-key" -v

  # Scenario 4: Empty query validation
  uv run pytest tests/e2e/features/search.feature -k "empty-query-validation" -v

  # Scenario 5: Query exceeds token limit
  uv run pytest tests/e2e/features/search.feature -k "query-exceeds-token-limit" -v
  ```

- [ ] Run all scenarios together:
  ```bash
  uv run pytest tests/e2e/features/search.feature -v
  # Should show 5/5 passed
  ```

- [ ] Verify VCR cassettes created:
  ```bash
  ls -la tests/e2e/cassettes/
  # Should contain cassette files for scenarios that make API calls
  ```

- [ ] Document BDD progress:
  - Current: 5/5 scenarios passing âœ…
  - All acceptance criteria met âœ“

### Phase 3: Enhance CLI User Experience (30 min)

- [ ] Open `src/gitctx/cli/search.py`

- [ ] Improve progress indicator messaging:
  ```python
  with Progress(
      SpinnerColumn(),
      TextColumn("[progress.description]{task.description}"),
      console=console,
  ) as progress:
      # Phase 1: Generate query embedding
      embed_task = progress.add_task(
          "[cyan]Generating query embedding...[/cyan]",
          total=None
      )
      embedder = QueryEmbedder(settings, store)
      query_vector = embedder.embed_query(query)
      progress.update(embed_task, description="[green]âœ“[/green] Query embedding generated")
  ```

- [ ] Enhance success message:
  ```python
  # Success message
  console.print(
      f"[green]âœ“[/green] Query embedded successfully "
      f"({query_vector.shape[0]} dimensions)"
  )
  console.print(
      "[dim]Note: Full search coming in STORY-0001.3.2[/dim]"
  )
  ```

- [ ] Verify error messages match story requirements exactly:
  - ValidationError (exit 2): "Error: Query cannot be empty" / "whitespace only" / "exceeds 8191 tokens (got X)"
  - ConfigurationError (exit 4): "Error: OpenAI API key not configured\nSet with: export OPENAI_API_KEY=sk-...\nOr run: gitctx config set api_keys.openai sk-..."
  - EmbeddingError (exit 5): "Error: API rate limit exceeded" / "OpenAI API unavailable" / "Request timeout" / "Cannot connect"

- [ ] Test CLI manually:
  ```bash
  # Success case
  gitctx search "authentication logic"

  # Empty query
  gitctx search ""  # Should show exact error from story

  # Missing key
  OPENAI_API_KEY="" gitctx search "test"  # Should show multi-line error

  # Cached query (run twice)
  gitctx search "database setup"
  gitctx search "database setup"  # Should be faster
  ```

### Phase 4: Documentation Updates (30 min)

#### Update Module READMEs

- [ ] Update `src/gitctx/search/README.md`:
  ```markdown
  # search/

  Search pipeline for semantic code search.

  ## Current Implementation (STORY-0001.3.1)

  - **embeddings.py** - `QueryEmbedder` generates query embeddings with caching
  - **query.py** - `QueryProcessor` orchestrates query processing (placeholder)
  - **errors.py** - Search-specific exceptions

  ## Usage

  ```python
  from gitctx.search.embeddings import QueryEmbedder
  from gitctx.config.settings import load_settings
  from gitctx.storage.lancedb_store import get_store

  settings = load_settings()
  store = get_store(settings)

  embedder = QueryEmbedder(settings, store)
  query_vector = embedder.embed_query("authentication logic")
  # Returns: np.ndarray with shape (3072,)
  ```

  ## Error Handling

  - `ValidationError` (exit 2): Empty query, whitespace-only, token limit exceeded
  - `ConfigurationError` (exit 4): Missing API key
  - `EmbeddingError` (exit 5): API errors (rate limit, timeout, connection)

  ## Caching

  Query embeddings cached in LanceDB `query_embeddings` table:
  - Cache key: SHA256(query_text + model_name)
  - No TTL (cache indefinitely until `gitctx clear`)
  - Concurrent writes: last-write-wins (no locking)

  ## Future (STORY-0001.3.2)

  - **retriever.py** - Vector search execution
  - **ranking.py** - Result ranking strategies
  - **reranking.py** - LLM-based reranking (INIT-0002)
  ```

- [ ] Update `src/gitctx/models/README.md`:
  ```markdown
  # models/

  Model infrastructure layer providing API clients to all features.

  ## Current Implementation

  - **registry.py** - Model metadata (token limits, dimensions)
  - **protocols.py** - ModelProvider protocol
  - **base.py** - BaseProvider abstract class
  - **factory.py** - Provider selection and instantiation
  - **errors.py** - Model-specific errors
  - **providers/openai.py** - OpenAI implementation

  ## Usage Example

  ```python
  from gitctx.models.factory import get_embedder
  from gitctx.config.settings import load_settings

  settings = load_settings()
  embedder = get_embedder("text-embedding-3-large", settings)

  # Single query
  vector = embedder.embed_query("test query")

  # Batch documents
  vectors = embedder.embed_documents(["doc1", "doc2", "doc3"])
  ```

  ## Supported Models

  - `text-embedding-3-large` - 3072 dimensions, 8191 max tokens
  - `text-embedding-3-small` - 1536 dimensions, 8191 max tokens

  ## Adding New Providers (INIT-0004)

  1. Create `providers/anthropic.py`
  2. Implement `ModelProvider` protocol
  3. Register in `factory.py`
  4. Add model specs to `registry.py`
  ```

- [ ] Update `src/gitctx/storage/README.md` with cache info:
  ```markdown
  ## Cache Tables

  ### query_embeddings
  Caches query embeddings to minimize API calls.

  Schema:
  - `cache_key` (string): SHA256(query_text + model_name)
  - `query_text` (string): Original query (for debugging)
  - `embedding` (vector[3072]): Embedding vector
  - `model_name` (string): Model used
  - `created_at` (float64): Unix timestamp

  Cleared by: `gitctx clear` command
  ```

#### Update CLAUDE.md Files

- [ ] Verify `src/gitctx/search/CLAUDE.md` references @README.md
- [ ] Verify `src/gitctx/models/CLAUDE.md` references @README.md
- [ ] Verify `src/gitctx/storage/CLAUDE.md` references @README.md

### Phase 5: Final Verification (30 min)

#### Run Complete Test Suite

- [ ] Run all unit tests with coverage:
  ```bash
  uv run pytest tests/unit/ -v --cov=src/gitctx --cov-report=term-missing
  ```

- [ ] Verify coverage targets met:
  - Overall: >90%
  - search/embeddings.py: >95%
  - models/: >90%
  - storage/ (cache methods): >90%

- [ ] Run all E2E tests:
  ```bash
  uv run pytest tests/e2e/ -v
  ```

- [ ] Verify all 5 search scenarios pass:
  ```bash
  uv run pytest tests/e2e/features/search.feature -v
  # Should show 5/5 passed âœ…
  ```

#### Run Quality Gates

- [ ] Ruff check:
  ```bash
  uv run ruff check src tests
  ```

- [ ] Ruff format:
  ```bash
  uv run ruff format src tests
  ```

- [ ] Mypy:
  ```bash
  uv run mypy src
  ```

- [ ] All gates must pass âœ…

#### Manual Testing

- [ ] Test each error case manually:
  ```bash
  # Empty query (exit 2)
  gitctx search ""
  echo $?  # Should be 2

  # Whitespace query (exit 2)
  gitctx search "   "
  echo $?  # Should be 2

  # Missing API key (exit 4)
  OPENAI_API_KEY="" gitctx search "test"
  echo $?  # Should be 4

  # Success case (exit 0)
  gitctx search "authentication logic"
  echo $?  # Should be 0

  # Cached query (exit 0, faster)
  time gitctx search "authentication logic"
  time gitctx search "authentication logic"  # Should be faster
  ```

- [ ] Verify error messages are user-friendly and match story exactly

- [ ] Verify progress indicators work correctly

- [ ] Test with different query lengths

#### Documentation Completeness

- [ ] All module READMEs updated
- [ ] All CLAUDE.md files reference READMEs
- [ ] Code examples in READMEs are accurate
- [ ] Error handling documented
- [ ] Caching strategy documented

## Success Criteria

- [ ] All 5 BDD scenarios passing (5/5) âœ…
- [ ] All unit tests passing (>90% coverage)
- [ ] All quality gates pass (ruff, mypy)
- [ ] CLI shows proper progress indicators
- [ ] Error messages match story requirements exactly
- [ ] Exit codes correct (0, 2, 4, 5)
- [ ] Documentation updated and accurate
- [ ] Manual testing successful
- [ ] VCR cassettes recorded for API scenarios
- [ ] Cache behavior verified (second query faster)

## Pattern Reuse

- **Rich Progress Indicators**: Same pattern as indexing progress
- **Exit Code Mapping**: Consistent with existing CLI commands
- **VCR Testing**: `@pytest.mark.vcr()` for deterministic API tests
- **Error Hierarchy**: Consistent with existing error handling
- **Documentation Pattern**: README.md + CLAUDE.md with @ references

## BDD Progress

**Before**: 4/5 scenarios passing
**After**: 5/5 scenarios passing âœ…

Story complete!

## Files Changed

**Modified**:
- `src/gitctx/cli/search.py` (~20 lines - polish UX)
- `tests/e2e/steps/search_steps.py` (~30 lines - complete remaining steps)
- `src/gitctx/search/README.md` (~80 lines)
- `src/gitctx/models/README.md` (~50 lines)
- `src/gitctx/storage/README.md` (~30 lines)

**Total**: 5 files, ~210 lines

## Commit Message

```
feat(TASK-0001.3.1.4): Complete query embedding integration and E2E verification

- Complete remaining BDD step implementations
- Polish CLI user experience with better progress indicators
- Update all module documentation (README.md files)
- Verify all 5 BDD scenarios passing with VCR cassettes
- Manual testing confirms proper error handling and caching

Story STORY-0001.3.1 complete - all acceptance criteria met.
BDD Progress: 5/5 scenarios passing âœ…

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

---

**Created**: 2025-10-12
**Status**: Ready for implementation
