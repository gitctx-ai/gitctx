# TASK-0001.3.1.0: Architecture Refactor for Clean Module Boundaries

**Parent Story**: [STORY-0001.3.1](./README.md)
**Status**: âœ… Complete
**Estimated Hours**: 5-6
**Actual Hours**: 6

## Deliverable

Refactored `src/gitctx/` structure with 8 well-defined modules, each with README.md + CLAUDE.md documentation. All files moved from `core/` dumping ground to appropriate modules. All tests passing, no behavior changes.

**Rationale**: Last epic of MVP - final window for clean refactor before v0.1.0. Prevents "big ball of mud" and enables INIT-0002 (Context Assembly), INIT-0003 (Production Hardening), INIT-0004 (Multi-model Support) without future refactors. Without this, `search/` and `models/` logic would accumulate in `core/` dumping ground, making future features harder to scope and test.

## Implementation Checklist

### Phase 1: Create Module Structure (30 min)

- [ ] Create new module directories:
  ```bash
  mkdir -p src/gitctx/{config,models/providers,search,context,git}
  ```

- [ ] Create `src/gitctx/exceptions.py` with base `GitCtxError`:
  ```python
  """Base exceptions for gitctx."""

  class GitCtxError(Exception):
      """Base exception for all gitctx errors."""
  ```

- [ ] Create README.md files for all modules (9 total):
  - [ ] `src/gitctx/cli/README.md`
  - [ ] `src/gitctx/config/README.md`
  - [ ] `src/gitctx/models/README.md`
  - [ ] `src/gitctx/models/providers/README.md`
  - [ ] `src/gitctx/indexing/README.md`
  - [ ] `src/gitctx/search/README.md`
  - [ ] `src/gitctx/context/README.md`
  - [ ] `src/gitctx/storage/README.md`
  - [ ] `src/gitctx/git/README.md`

- [ ] Create CLAUDE.md files for all modules (9 total, same locations as README.md)
  - Each should start with: `For complete module documentation, see @README.md`

- [ ] Verify all README.md files follow template:
  - Purpose section
  - What Belongs Here section
  - What Does NOT Belong Here section
  - Future Additions section
  - Dependencies section
  - Example Usage section

- [ ] Verify all CLAUDE.md files follow template:
  - `@README.md` reference
  - AI Development Rules section
  - Common Mistakes section
  - Key Files section with `@` references

### Phase 2: Move Files (1 hour)

- [ ] Map current file locations to understand what exists:
  ```bash
  ls -la src/gitctx/core/
  ls -la src/gitctx/embeddings/ 2>/dev/null || echo "No embeddings dir"
  ```

- [ ] Relocate TUI_GUIDE.md to docs/ for better organization:
  ```bash
  git mv TUI_GUIDE.md docs/TUI_GUIDE.md
  ```

- [ ] Update all references from old to new location:
  ```bash
  # Find and update references (manual verification recommended)
  grep -r "TUI_GUIDE.md" docs/tickets/ --exclude-dir=.git
  # Update any references from TUI_GUIDE.md to docs/TUI_GUIDE.md
  ```

- [ ] Move files from core/ to config/:
  - [ ] `git mv src/gitctx/core/config.py src/gitctx/config/settings.py`

- [ ] Move files from core/ to indexing/:
  - [ ] `git mv src/gitctx/core/scanner.py src/gitctx/indexing/scanner.py` (if exists)
  - [ ] `git mv src/gitctx/core/chunker.py src/gitctx/indexing/chunker.py` (if exists)

- [ ] Move embedding-related files to indexing/:
  - [ ] Check if `src/gitctx/core/embedding.py` exists â†’ move to `src/gitctx/indexing/embeddings.py`
  - [ ] Check if `src/gitctx/embeddings/openai_embedder.py` exists â†’ move to `src/gitctx/indexing/embeddings.py`
  - [ ] Remove empty `src/gitctx/embeddings/` directory if it exists

- [ ] Move files from core/ to git/:
  - [ ] `git mv src/gitctx/core/commit_walker.py src/gitctx/git/walker.py` (if exists)
  - [ ] `git mv src/gitctx/core/diff.py src/gitctx/git/diff.py` (if exists)
  - [ ] `git mv src/gitctx/core/ignore.py src/gitctx/git/ignore.py` (if exists)

- [ ] Create new essential files:
  - [ ] `config/errors.py` - ConfigurationError, ValidationError
  - [ ] `config/__init__.py` - Empty or exports
  - [ ] `models/protocols.py` - ModelProvider protocol
  - [ ] `models/registry.py` - Model metadata registry
  - [ ] `models/__init__.py` - Empty or exports
  - [ ] `models/providers/__init__.py` - Empty
  - [ ] `indexing/protocols.py` - Empty placeholder for future Chunker/Scanner protocols
  - [ ] `search/protocols.py` - Empty placeholder for future Retriever/Ranker protocols
  - [ ] `search/__init__.py` - Empty or exports
  - [ ] `context/protocols.py` - Empty placeholder for future Assembler/Budget protocols
  - [ ] `context/__init__.py` - Empty or exports
  - [ ] `git/types.py` - Empty placeholder for future Commit, DiffResult types
  - [ ] `git/errors.py` - Empty placeholder for future GitError
  - [ ] `git/__init__.py` - Empty or exports

- [ ] Verify old core/ directory state:
  ```bash
  ls -la src/gitctx/core/
  # Should have much fewer files now
  ```

### Phase 3: Update Imports (2-3 hours)

- [ ] Map all imports of moved files:
  ```bash
  grep -rn "from gitctx.core.config import" src/ tests/ > /tmp/imports_config.txt
  grep -rn "from gitctx.core.scanner import" src/ tests/ > /tmp/imports_scanner.txt
  grep -rn "from gitctx.core.chunker import" src/ tests/ > /tmp/imports_chunker.txt
  grep -rn "from gitctx.core.commit_walker import" src/ tests/ > /tmp/imports_walker.txt
  grep -rn "from gitctx.core.diff import" src/ tests/ > /tmp/imports_diff.txt
  grep -rn "from gitctx.core.ignore import" src/ tests/ > /tmp/imports_ignore.txt
  grep -rn "from gitctx.core.embedding import" src/ tests/ > /tmp/imports_embedding.txt
  grep -rn "from gitctx.embeddings" src/ tests/ > /tmp/imports_embeddings_module.txt
  cat /tmp/imports_*.txt
  ```

- [ ] Update imports in moved files themselves (internal references):
  - [ ] `config/settings.py` - Update any internal imports
  - [ ] `indexing/scanner.py` - Update imports
  - [ ] `indexing/chunker.py` - Update imports
  - [ ] `indexing/embeddings.py` - Update imports
  - [ ] `git/walker.py` - Update imports
  - [ ] `git/diff.py` - Update imports
  - [ ] `git/ignore.py` - Update imports

- [ ] Update imports in git/ module:
  - [ ] Update any files in `git/` that import moved files

- [ ] Update imports in indexing/ module:
  - [ ] `indexing/pipeline.py`
  - [ ] `indexing/progress.py`
  - [ ] `indexing/formatting.py`
  - [ ] `indexing/batch.py` (if exists)
  - [ ] Any other indexing files

- [ ] Update imports in storage/ module:
  - [ ] `storage/lancedb_store.py`
  - [ ] `storage/schema.py`
  - [ ] Any other storage files

- [ ] Update imports in cli/ module:
  - [ ] `cli/main.py`
  - [ ] `cli/index.py`
  - [ ] `cli/search.py`
  - [ ] `cli/config.py`
  - [ ] `cli/clear.py`
  - [ ] Any other cli files

- [ ] Run basic import check:
  ```bash
  uv run python -c "from gitctx.config.settings import GitCtxSettings; print('âœ“ config.settings')"
  uv run python -c "from gitctx.indexing.scanner import Scanner; print('âœ“ indexing.scanner')" || echo "Skip if doesn't exist"
  uv run python -c "from gitctx.git.walker import CommitWalker; print('âœ“ git.walker')" || echo "Skip if doesn't exist"
  ```

### Phase 4: Update Tests (30 min)

- [ ] Create new test module directories:
  ```bash
  mkdir -p tests/unit/{config,models,git}
  ```

- [ ] Move test files if they exist:
  - [ ] Check `tests/unit/core/test_config.py` â†’ move to `tests/unit/config/test_settings.py`
  - [ ] Check `tests/unit/core/test_scanner.py` â†’ move to `tests/unit/indexing/test_scanner.py`
  - [ ] Check other core test files and move appropriately

- [ ] Update test imports:
  ```bash
  grep -rn "from gitctx.core" tests/ > /tmp/test_imports.txt
  grep -rn "from gitctx.embeddings" tests/ >> /tmp/test_imports.txt
  cat /tmp/test_imports.txt
  ```

- [ ] Update imports in unit tests:
  - [ ] `tests/unit/config/` - All test files
  - [ ] `tests/unit/indexing/` - All test files
  - [ ] `tests/unit/storage/` - All test files
  - [ ] `tests/unit/git/` - All test files
  - [ ] `tests/unit/cli/` - All test files

- [ ] Update imports in e2e tests:
  - [ ] `tests/e2e/` - All step definition files
  - [ ] `tests/e2e/conftest.py`

- [ ] Update conftest.py fixtures:
  - [ ] `tests/conftest.py` - Root fixtures
  - [ ] `tests/unit/conftest.py` - Unit test fixtures
  - [ ] `tests/e2e/conftest.py` - E2E test fixtures

### Phase 5: Verification & Cleanup (1 hour)

- [ ] Verify no old imports remain:
  ```bash
  ! grep -r "from gitctx.core.config" src/ tests/
  ! grep -r "from gitctx.core.scanner" src/ tests/
  ! grep -r "from gitctx.core.chunker" src/ tests/
  ! grep -r "from gitctx.core.commit_walker" src/ tests/
  ! grep -r "from gitctx.core.embedding" src/ tests/
  ! grep -r "from gitctx.embeddings" src/ tests/
  echo "âœ“ No old imports found"
  ```

- [ ] Run Ruff checks:
  ```bash
  uv run ruff check src tests
  uv run ruff format src tests
  ```

- [ ] Run Mypy:
  ```bash
  uv run mypy src
  ```

- [ ] Run all unit tests:
  ```bash
  uv run pytest tests/unit/ -v
  ```

- [ ] Run all e2e tests:
  ```bash
  uv run pytest tests/e2e/ -v
  ```

- [ ] Verify CLI still works:
  ```bash
  uv run gitctx --help
  uv run gitctx index --help
  uv run gitctx search --help
  uv run gitctx config --help
  uv run gitctx clear --help
  ```

- [ ] Clean up cache directories:
  ```bash
  find src/ -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
  find tests/ -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
  ```

- [ ] Remove old directories if empty:
  ```bash
  [ -d src/gitctx/embeddings ] && [ -z "$(ls -A src/gitctx/embeddings)" ] && rmdir src/gitctx/embeddings/ || true
  [ -d src/gitctx/core ] && [ -z "$(ls -A src/gitctx/core)" ] && rmdir src/gitctx/core/ || true
  ```

### Phase 6: Documentation Review (30 min)

- [ ] Review each README.md for accuracy:
  - [ ] `cli/README.md` - Purpose clear, files documented, dependencies correct
  - [ ] `config/README.md` - Purpose clear, files documented, dependencies correct
  - [ ] `models/README.md` - Purpose clear, files documented, dependencies correct
  - [ ] `models/providers/README.md` - Purpose clear, future additions listed
  - [ ] `indexing/README.md` - Purpose clear, files documented, dependencies correct
  - [ ] `search/README.md` - Purpose clear, future files listed (embeddings.py, reranking.py)
  - [ ] `context/README.md` - Purpose clear, future files listed (INIT-0002)
  - [ ] `storage/README.md` - Purpose clear, files documented, dependencies correct
  - [ ] `git/README.md` - Purpose clear, files documented, dependencies correct

- [ ] Review each CLAUDE.md for clarity:
  - [ ] All have `@README.md` reference at top
  - [ ] AI Development Rules are actionable
  - [ ] Common Mistakes section has examples (if applicable)
  - [ ] Key files referenced with `@` syntax

- [ ] Create or update root src documentation:
  - [ ] Create/update `src/gitctx/README.md` with module overview
  - [ ] Each module linked with `@` syntax

- [ ] Verify documentation is accurate:
  - [ ] No references to files that don't exist
  - [ ] No missing files from "What Belongs Here" sections
  - [ ] Dependencies reflect actual imports

### Final Verification

- [ ] All quality gates pass:
  - [ ] `uv run ruff check src tests` âœ…
  - [ ] `uv run ruff format src tests` âœ…
  - [ ] `uv run mypy src` âœ…
  - [ ] `uv run pytest` âœ… (100% pass rate)

- [ ] Directory structure correct:
  ```bash
  tree -L 2 src/gitctx/
  # Should show:
  # src/gitctx/
  # â”œâ”€â”€ cli/
  # â”œâ”€â”€ config/
  # â”œâ”€â”€ models/
  # â”‚   â””â”€â”€ providers/
  # â”œâ”€â”€ indexing/
  # â”œâ”€â”€ search/
  # â”œâ”€â”€ context/
  # â”œâ”€â”€ storage/
  # â”œâ”€â”€ git/
  # â”œâ”€â”€ exceptions.py
  # â””â”€â”€ __init__.py
  ```

- [ ] All modules have documentation:
  ```bash
  for dir in cli config models models/providers indexing search context storage git; do
    [ -f "src/gitctx/$dir/README.md" ] && echo "âœ“ $dir/README.md" || echo "âœ— Missing $dir/README.md"
    [ -f "src/gitctx/$dir/CLAUDE.md" ] && echo "âœ“ $dir/CLAUDE.md" || echo "âœ— Missing $dir/CLAUDE.md"
  done
  ```

- [ ] No old module structure remains:
  - [ ] `src/gitctx/embeddings/` removed (if it existed)
  - [ ] `src/gitctx/core/` removed or only contains essential shared utilities

## Success Criteria

- [ ] 8 new module directories exist (cli, config, models, indexing, search, context, storage, git)
- [ ] All modules have README.md + CLAUDE.md documentation
- [ ] All files from `core/` moved to appropriate modules
- [ ] All imports updated across src/ and tests/
- [ ] All quality gates pass (ruff, mypy, pytest)
- [ ] CLI commands functional
- [ ] No old import patterns remain
- [ ] Test structure mirrors src/ structure

## Pattern Reuse

- **Documentation Pattern**: README.md (canonical) + CLAUDE.md (AI loader with `@` references)
- **Module Structure**: Each module has clear boundaries documented upfront
- **Import Strategy**: Update in dependency order (leaves â†’ roots) to avoid circular imports
- **Git Strategy**: Use `git mv` to preserve file history

## Files Changed

**New files**: ~20
- 9 README.md files (one per module/submodule)
- 9 CLAUDE.md files (one per module/submodule)
- `exceptions.py` (base error)
- `models/registry.py` (model specs)
- `models/protocols.py` (ModelProvider)
- Protocol placeholders (indexing, search, context)

**Moved files**: ~8
- `config.py` â†’ `config/settings.py`
- `scanner.py` â†’ `indexing/scanner.py`
- `chunker.py` â†’ `indexing/chunker.py`
- `embedding*.py` â†’ `indexing/embeddings.py`
- `commit_walker.py` â†’ `git/walker.py`
- `diff.py` â†’ `git/diff.py`
- `ignore.py` â†’ `git/ignore.py`

**Modified files**: ~25-30
- All files with imports to moved files (~20-25 in src/)
- Test files (~5-10 in tests/)

**Total impact**: ~50-60 files

## Risks & Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Circular import dependencies | Medium | High | Update in dependency order (leaves â†’ roots); mypy catches cycles |
| Tests break during refactor | Medium | Medium | Run pytest after each phase; git commits enable rollback |
| Missing imports in edge cases | Low | Medium | Grep for all old patterns before declaring complete |
| Documentation becomes stale | Low | Low | Create docs during refactor, review before commit |

## Commit Strategy

**Option A: One commit per phase** (6 commits total)
```
refactor(TASK-0001.3.1.0): Create module structure with documentation
refactor(TASK-0001.3.1.0): Move files to new module locations
refactor(TASK-0001.3.1.0): Update imports across src/
refactor(TASK-0001.3.1.0): Update imports across tests/
refactor(TASK-0001.3.1.0): Verify quality gates and cleanup
refactor(TASK-0001.3.1.0): Finalize documentation
```

**Option B: Single commit after all phases** (recommended if confident)
```
refactor(TASK-0001.3.1.0): Restructure src/ into 8 clean modules

- Extract config/ from core/ for configuration management
- Extract git/ from core/ for git operations
- Move embeddings to indexing/ (chunk embeddings)
- Create models/ for model infrastructure
- Create search/ for search pipeline (will hold query embeddings)
- Create context/ for LLM context management (INIT-0002 prep)
- Add README.md + CLAUDE.md to all modules
- Create base GitCtxError in exceptions.py
- Update all imports across src/ and tests/

All tests pass. No behavior changes. Clean foundation for INIT-0002.

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

---

**Created**: 2025-10-12
**Status**: Ready for implementation
