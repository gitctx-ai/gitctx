# TASK-0001.3.2.3: LanceDB Integration + Error Handling (TDD)

**Parent Story**: [STORY-0001.3.2](README.md)
**Status**: ðŸ”µ Not Started
**Estimated Hours**: 6
**Actual Hours**: -

## Objective

â›” **BLOCKED by STORY-0001.3.1** - Requires `generate_query_embedding()` for real query vectors. This task integrates with LanceDBStore.search(), adds comprehensive error handling, and processes denormalized results.

Implement core search integration with LanceDBStore.search(), error handling for missing/corrupted index, query embedding generation, and result processing. Implements BDD scenarios 4-11 + unit test for corrupted DB.

## BDD Progress

**Before this task**: 3/12 E2E scenarios passing
**After this task**: 10/12 E2E + 1/1 unit scenarios passing

**Scenarios for this task:**
- Scenario 4: Results sorted by similarity (ascending _distance)
- Scenario 5: Result limit (--limit flag)
- Scenario 6: No results (empty result set, exit 0)
- Scenario 7: Search before indexing (missing index, exit 8)
- Scenario 8: Empty stdin with no args (exit 2) - already passing from TASK-2
- Scenario 9: Invalid limit too low (exit 2)
- Scenario 10: Invalid limit too high (exit 2)
- Scenario 11: Corrupted index unit test (TableNotFoundError, exit 1)

## Implementation Checklist

### Unit Tests First (TDD - RED)
- [ ] Create `tests/unit/cli/test_search_integration.py`
- [ ] Write `test_search_missing_index_directory()` - Exit 8 when .gitctx/db/lancedb/ missing
- [ ] Write `test_search_empty_index()` - Exit 8 when store.count() == 0
- [ ] Write `test_search_corrupted_index_missing_table()` - Exit 1, mock TableNotFoundError
- [ ] Write `test_search_returns_sorted_results()` - Mock store.search(), verify sorting
- [ ] Write `test_search_respects_limit()` - Verify limit passed to store.search()
- [ ] Write `test_search_result_has_all_fields()` - Verify 11 denormalized fields present
- [ ] Write `test_search_limit_validation()` - Test --limit 0 and --limit 101
- [ ] Run: `pytest tests/unit/cli/test_search_integration.py` - all 8+ tests fail âœ“

### Implementation (GREEN)
- [ ] MODIFY: `src/gitctx/cli/search.py` - Add LanceDB integration:
  ```python
  def search(...) -> None:
      query_text = _get_query_text(query)

      # 1. Check index exists
      db_path = Path(".gitctx/db/lancedb")
      if not db_path.exists():
          console_err.print(f"Error: No index found\nRun: gitctx index")
          raise typer.Exit(8)

      settings = GitCtxSettings()

      # 2. Initialize LanceDBStore with error handling
      try:
          store = LanceDBStore(
              db_path=db_path,
              embedding_model=settings.repo.model.embedding,
              embedding_dimensions=settings.repo.model.embedding_dimensions
          )
          if store.count() == 0:
              console_err.print(f"Error: No index found\nRun: gitctx index")
              raise typer.Exit(8)
      except lancedb.TableNotFoundError:
          console_err.print(
              f"Error: Index corrupted (missing code_chunks table)\n"
              f"Fix with: gitctx clear && gitctx index"
          )
          raise typer.Exit(1)

      # 3. Generate query embedding (from STORY-0001.3.1)
      start_time = time.time()
      query_vector = generate_query_embedding(query_text, settings, store)

      # 4. Search LanceDB
      results = store.search(
          query_vector=query_vector,
          limit=limit,
          filter_head_only=False
      )

      duration = time.time() - start_time

      # 5. Display results (basic for now, STORY-0001.3.3 for formatting)
      console.print(f"\n{len(results)} results in {duration:.2f}s")
  ```
- [ ] Run: `pytest tests/unit/cli/test_search_integration.py` - all tests pass âœ“

### BDD Implementation
- [ ] MODIFY: `tests/e2e/steps/search_steps.py` - Implement 4 new assertion steps:
  ```python
  @then('results should be sorted by _distance ascending (0.0 = best match first)')
  def check_results_sorted(context):
      # Parse results from output, verify ascending order
      # Basic check for now - full formatting in STORY-0001.3.3
      assert context['result'].exit_code == 0

  @then(parsers.parse('each result should show cosine similarity score between {min:f} and {max:f}'))
  def check_similarity_scores(min: float, max: float, context):
      # Verify scores in range [0.0, 1.0]
      assert context['result'].exit_code == 0

  @then(parsers.parse('exactly {n:d} results should be shown'))
  def check_result_count(n: int, context):
      # Parse output for result count
      output = context['result'].stdout
      assert f"{n} results" in output

  @then(parsers.parse('the output should contain "{text}"'))
  def check_output_contains(text: str, context):
      output = context['result'].stdout + context['result'].stderr
      assert text in output
  ```
- [ ] MODIFY: `tests/unit/cli/test_search.py` - Unskip corrupted index test:
  ```python
  def test_corrupted_index_missing_table(cli_runner):
      """Test search with missing code_chunks table."""
      with patch('lancedb.connect') as mock_connect:
          mock_db = Mock()
          mock_db.open_table.side_effect = lancedb.TableNotFoundError("code_chunks")
          mock_connect.return_value = mock_db

          result = cli_runner.invoke(app, ["search", "test"])

          assert result.exit_code == 1
          assert "Error: Index corrupted" in result.output
          assert "gitctx clear && gitctx index" in result.output
  ```
- [ ] Run: `pytest tests/e2e/features/search.feature` - 10/12 scenarios pass âœ“
- [ ] Run: `pytest tests/unit/cli/test_search.py` - 1/1 pass âœ“

### Verification
- [ ] All unit tests pass (test_search_integration.py + test_search.py)
- [ ] BDD scenarios 4-10 now pass (7 additional scenarios)
- [ ] BDD scenario 11 (corrupted index) passes as unit test
- [ ] BDD scenarios 12 still fail (performance - pending TASK-4)
- [ ] Code coverage >90% for src/gitctx/cli/search.py

## Files to Create/Modify

- CREATE: `tests/unit/cli/test_search_integration.py` (~150 lines, 8+ tests)
- MODIFY: `src/gitctx/cli/search.py` (add LanceDB integration + error handling, ~120 lines total)
- MODIFY: `tests/e2e/steps/search_steps.py` (implement 4 assertion steps, ~80 lines total)
- MODIFY: `tests/unit/cli/test_search.py` (unskip corrupted index test, implement with mocks)

## Pattern Reuse

- `LanceDBStore` initialization (src/gitctx/storage/lancedb_store.py:40-70)
- `store.search()` method (src/gitctx/storage/lancedb_store.py:287-307)
- Exit code pattern (src/gitctx/cli/index.py:66-68) - typer.Exit(code=N)
- `lancedb_store` fixture (tests/unit/storage/conftest.py:12) - For unit tests
- Console error output (src/gitctx/cli/config.py:13-14) - Console(stderr=True)

## Performance Targets

Not applicable for this task - performance validation in TASK-4.

## Dependencies

- â›” **BLOCKED by STORY-0001.3.1** - Must complete first for `generate_query_embedding()` function
- LanceDBStore.search() method already exists (EPIC-0001.2)
- GitCtxSettings already exists (STORY-0001.1.0)

## Notes

- Exit code 8 for missing/empty index (TUI_GUIDE.md)
- Exit code 1 for corrupted index (general error)
- Exit code 2 for usage errors (invalid limit)
- `lancedb.TableNotFoundError` requires mocking in unit tests
- Result formatting (terse/verbose/MCP) deferred to STORY-0001.3.3
