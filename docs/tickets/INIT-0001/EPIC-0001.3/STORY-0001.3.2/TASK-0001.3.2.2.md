# TASK-0001.3.2.2: Variadic Args + stdin Support (TDD)

**Parent Story**: [STORY-0001.3.2](README.md)
**Status**: ðŸ”µ Not Started
**Estimated Hours**: 4
**Actual Hours**: -

## Objective

â›” **BLOCKED by STORY-0001.3.1** - This task calls `generate_query_embedding(query_text: str, settings: GitCtxSettings, store: LanceDBStore) -> list[float]` which is implemented in STORY-0001.3.1. This task focuses on CLI input handling only - the embedding generation is mocked in tests.

Implement CLI command with variadic query arguments, stdin detection, and query text assembly. Implements BDD scenarios 1-3 (unquoted multi-word, flags before args, stdin pipeline).

## BDD Progress

**Before this task**: 0/12 E2E scenarios passing
**After this task**: 3/12 E2E scenarios passing

**Scenarios for this task:**
- Scenario 1: Unquoted multi-word query (variadic args)
- Scenario 2: Flags before query terms (Typer parsing)
- Scenario 3: stdin pipeline (sys.stdin detection)

## Implementation Checklist

### Unit Tests First (TDD - RED)
- [ ] Create `tests/unit/cli/test_search_args.py`
- [ ] Write `test_search_variadic_args_joined()` - "auth middleware" â†’ "auth middleware"
- [ ] Write `test_search_flags_before_args()` - "--limit 5 auth" parses correctly
- [ ] Write `test_search_stdin_pipe()` - Mock stdin.read() with query text
- [ ] Write `test_search_empty_stdin_non_interactive()` - Exit 2 when empty
- [ ] Write `test_search_no_args_interactive()` - Exit 2 when interactive terminal
- [ ] Run: `pytest tests/unit/cli/test_search_args.py` - all 5+ tests fail âœ“

### Implementation (GREEN)
- [ ] MODIFY: `src/gitctx/cli/search.py`
- [ ] Implement `search()` command signature:
  ```python
  @app.command()
  def search(
      query: Optional[list[str]] = typer.Argument(None, help="Search query"),
      limit: int = typer.Option(10, "--limit", "-n", min=1, max=100),
      format: str = typer.Option("terse", "--format"),
      verbose: bool = typer.Option(False, "--verbose", "-v"),
      mcp: bool = typer.Option(False, "--mcp"),
  ) -> None:
  ```
- [ ] Implement `_get_query_text(query: Optional[list[str]]) -> str` helper:
  ```python
  def _get_query_text(query: Optional[list[str]]) -> str:
      """Extract query text from CLI args or stdin.

      Args:
          query: CLI arguments after 'gitctx search' (e.g., ['auth', 'middleware'])

      Returns:
          str: Query text joined with spaces (e.g., 'auth middleware')

      Raises:
          typer.Exit(2): If no query provided (neither args nor stdin)
      """
      # If query provided as args, join and return early
      if query:
          return " ".join(query)

      # No args provided - check stdin
      if sys.stdin.isatty():
          # Interactive terminal with no piped input
          console_err.print(
              f"[red]{SYMBOLS['error']}[/red] Error: Query required (from args or stdin)"
          )
          raise typer.Exit(2)

      # Read from piped stdin
      query_text = sys.stdin.read().strip()
      if not query_text:
          console_err.print(
              f"[red]{SYMBOLS['error']}[/red] Error: Query required (from args or stdin)"
          )
          raise typer.Exit(2)

      return query_text
  ```
- [ ] Run: `pytest tests/unit/cli/test_search_args.py` - all tests pass âœ“

### BDD Implementation
- [ ] MODIFY: `tests/e2e/steps/search_steps.py`
- [ ] Implement step: `@then('results should match query "{query}"')`
  ```python
  @then(parsers.parse('results should match query "{query}"'))
  def check_results_match_query(query: str, context):
      # Basic verification - just check command succeeded
      # Full result verification in TASK-0001.3.2.3
      assert context['result'].exit_code == 0
  ```
- [ ] Implement step: `@when('I pipe "{text}" to "{command}"')`
  ```python
  @when(parsers.parse('I pipe "{text}" to "{command}"'))
  def pipe_to_command(text: str, command: str, e2e_cli_runner, context):
      # Use subprocess for stdin piping
      import subprocess
      result = subprocess.run(
          ['gitctx'] + command.split(),
          input=text,
          text=True,
          capture_output=True,
          env=e2e_git_isolation_env
      )
      context['result'] = result
  ```
- [ ] Run: `pytest tests/e2e/features/search.feature::scenario_1_2_3` - 3/12 pass âœ“

### Verification
- [ ] All unit tests pass (`test_search_args.py`)
- [ ] BDD scenarios 1-3 pass (variadic, flags, stdin)
- [ ] BDD scenarios 4-12 still fail (expected - pending TASK-3,4,5)
- [ ] Mock `generate_query_embedding()` in all tests with `[0.1] * 3072`

## Files to Create/Modify

- CREATE: `tests/unit/cli/test_search_args.py` (~120 lines, 5+ tests)
- MODIFY: `src/gitctx/cli/search.py` (add search() function + _get_query_text() helper, ~80 lines)
- MODIFY: `tests/e2e/steps/search_steps.py` (implement 2 new steps, ~40 lines)

## Pattern Reuse

- `cli_runner` (tests/conftest.py:190) - For unit tests with filesystem isolation
- `e2e_cli_runner` (tests/e2e/conftest.py:135) - For BDD tests with full isolation
- `e2e_git_isolation_env` (tests/e2e/conftest.py:41) - For subprocess stdin testing

## Mock Approach

**Mock generate_query_embedding in tests:**
```python
from unittest.mock import patch

@patch('gitctx.cli.search.generate_query_embedding')
def test_search_with_query(mock_embed, cli_runner):
    mock_embed.return_value = [0.1] * 3072  # Dummy 3072-dim vector
    result = cli_runner.invoke(app, ['search', 'test'])
    assert result.exit_code == 0
```

## Dependencies

- â›” **BLOCKED by STORY-0001.3.1** - Cannot implement real `generate_query_embedding()` call until STORY-0001.3.1 completes. Use mocks for all tests in this task.

## Notes

- Typer handles `min=1, max=100` validation automatically for `--limit`
- `sys.stdin.isatty()` returns False when piped, True when interactive
- Error messages follow TUI_GUIDE.md exit code standards (exit 2 = usage error)
