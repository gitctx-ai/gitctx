# TASK-0001.3.2.2: Variadic Args + stdin Support (TDD)

**Parent Story**: [STORY-0001.3.2](README.md)
**Status**: ✅ Complete
**Estimated Hours**: 4
**Actual Hours**: 3

## Objective

⛔ **BLOCKED by STORY-0001.3.1** - This task calls `generate_query_embedding(query_text: str, settings: GitCtxSettings, store: LanceDBStore) -> list[float]` which is implemented in STORY-0001.3.1. This task focuses on CLI input handling only - the embedding generation is mocked in tests.

Implement CLI command with variadic query arguments, stdin detection, and query text assembly. Implements BDD scenarios 1-3 (unquoted multi-word, flags before args, stdin pipeline).

## BDD Progress

**Before this task**: 0/12 E2E scenarios passing
**After this task**: 3/12 E2E scenarios passing

**Scenarios for this task:**
- Scenario 1: Unquoted multi-word query (variadic args)
- Scenario 2: Flags before query terms (Typer parsing)
- Scenario 3: stdin pipeline (sys.stdin detection)

## Implementation Checklist

### Unit Tests First (TDD - RED)
- [x] Create `tests/unit/cli/test_search_args.py`
- [x] Write `test_search_variadic_args_joined()` - "auth middleware" → "auth middleware"
- [x] Write `test_search_flags_before_args()` - "--limit 5 auth" parses correctly
- [x] Write `test_search_stdin_pipe()` - Use `isolated_cli_runner.invoke(app, ["search"], input="query\n")`
- [x] Write `test_search_empty_stdin_non_interactive()` - Exit 2 when empty, use `monkeypatch.setattr(sys.stdin, 'isatty', lambda: False)`
- [x] Write `test_search_no_args_interactive()` - Exit 2 when interactive terminal, use `monkeypatch.setattr(sys.stdin, 'isatty', lambda: True)`
- [x] Run: `pytest tests/unit/cli/test_search_args.py` - all 6 tests pass ✓

### Implementation (GREEN)
- [x] MODIFY: `src/gitctx/cli/search.py`
- [x] Make query parameter Optional: `Optional[list[str]] = None`
- [x] Implement `_get_query_text(query: Optional[list[str]]) -> str` helper (lines 27-59)
- [x] Replace `query_text = " ".join(query)` with `query_text = _get_query_text(query)` (line 108)
- [x] Remove duplicate `console_err = Console(stderr=True)` (already at module level)
- [x] Run: `pytest tests/unit/cli/test_search_args.py` - all 6 tests pass ✓

### BDD Implementation
- [x] MODIFY: `tests/e2e/steps/search_steps.py`
- [x] Implement step: `@then('results should match query "{query}"')` (lines 290-299)
- [x] Implement step: `@when('I pipe "{text}" to "{command}"')` (lines 308-333)
- [x] Run: `pytest tests/e2e/test_search_features.py` - scenarios 1 and 3 pass ✓

### Verification
- [x] All unit tests pass (`test_search_args.py`) - 6/6 passing
- [x] BDD scenarios 1 and 3 pass (variadic, stdin pipeline)
- [x] Scenario 2 partially works: flags parse correctly, but "exactly N results" step pending TASK-3
- [x] BDD scenarios 4-11 still fail (expected):
  - Scenario 4: Results sorted by similarity (needs LanceDB search in TASK-3)
  - Scenario 5: Result limit (needs LanceDB search in TASK-3)
  - Scenario 6: No results handling (needs LanceDB search in TASK-3)
  - Scenario 7: Search before indexing (needs index detection in TASK-3)
  - Scenario 8: Empty stdin with no args (needs error handling in TASK-3)
  - Scenarios 9-10: Invalid limit validation (needs Typer validation in TASK-3)
  - Scenario 11: Performance test (needs infrastructure in TASK-4)
- [x] Unit test: Corrupted index (needs TableNotFoundError handling in TASK-3)
- [x] Mock `QueryEmbedder` in all tests with `np.random.rand(3072)`

## Files to Create/Modify

- CREATE: `tests/unit/cli/test_search_args.py` (~120 lines, 5+ tests)
- MODIFY: `src/gitctx/cli/search.py` (add search() function + _get_query_text() helper, ~80 lines)
- MODIFY: `tests/e2e/steps/search_steps.py` (implement 2 new steps, ~40 lines)

## Pattern Reuse

- `isolated_cli_runner` (tests/conftest.py:190) - For unit tests with filesystem isolation and HOME isolation
- `e2e_cli_runner` (tests/e2e/conftest.py:135) - For BDD tests with full git isolation and automatic env merging
- `monkeypatch.setattr(sys.stdin, 'isatty', ...)` - Control TTY vs pipe behavior in tests (from Click's test suite)

## Mock Approach

**Mock QueryEmbedder in tests:**
```python
from unittest.mock import Mock, patch
import numpy as np

@patch('gitctx.cli.search.QueryEmbedder')
def test_search_with_query(mock_embedder_class, isolated_cli_runner):
    """Test search with mocked embedding generation."""
    # Mock the QueryEmbedder class and its embed_query method
    mock_embedder = Mock()
    mock_embedder.embed_query.return_value = np.random.rand(3072)  # 3072-dim vector
    mock_embedder_class.return_value = mock_embedder

    result = isolated_cli_runner.invoke(app, ['search', 'test'])
    assert result.exit_code == 0
```

**Test stdin with CliRunner:**
```python
def test_search_stdin_pipe(isolated_cli_runner, monkeypatch):
    """Test search reads from stdin when no args provided."""
    # Simulate piped input (non-TTY)
    monkeypatch.setattr('sys.stdin.isatty', lambda: False)

    # Use CliRunner's native input= parameter
    result = isolated_cli_runner.invoke(app, ['search'], input='query text\n')

    assert result.exit_code == 0
    assert 'query text' in result.stdout
```

**Test interactive terminal detection:**
```python
def test_search_no_args_interactive(isolated_cli_runner, monkeypatch):
    """Test search exits with error when interactive and no args."""
    # Simulate interactive terminal (TTY)
    monkeypatch.setattr('sys.stdin.isatty', lambda: True)

    result = isolated_cli_runner.invoke(app, ['search'])

    assert result.exit_code == 2
    assert 'Error: Query required' in result.output
```

## Dependencies

- ⛔ **BLOCKED by STORY-0001.3.1** - Cannot implement real `generate_query_embedding()` call until STORY-0001.3.1 completes. Use mocks for all tests in this task.

## Notes

- Typer handles `min=1, max=100` validation automatically for `--limit`
- `sys.stdin.isatty()` returns False when piped, True when interactive
- Error messages follow TUI_GUIDE.md exit code standards (exit 2 = usage error)
- **Testing stdin:** Use `CliRunner.invoke(app, [...], input="text\n")` instead of subprocess (Typer/Click best practice)
- **Testing isatty():** Use `monkeypatch.setattr('sys.stdin.isatty', lambda: True/False)` to simulate TTY vs pipe
- Pattern adapted from Click's own test suite (tests/test_utils.py)
