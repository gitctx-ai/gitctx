# TASK-0001.3.2.2: Variadic Args + stdin Support (TDD)

**Parent Story**: [STORY-0001.3.2](README.md)
**Status**: ðŸ”µ Not Started
**Estimated Hours**: 4
**Actual Hours**: -

## Objective

â›” **BLOCKED by STORY-0001.3.1** - This task calls `generate_query_embedding(query_text: str, settings: GitCtxSettings, store: LanceDBStore) -> list[float]` which is implemented in STORY-0001.3.1. This task focuses on CLI input handling only - the embedding generation is mocked in tests.

Implement CLI command with variadic query arguments, stdin detection, and query text assembly. Implements BDD scenarios 1-3 (unquoted multi-word, flags before args, stdin pipeline).

## BDD Progress

**Before this task**: 0/12 E2E scenarios passing
**After this task**: 3/12 E2E scenarios passing

**Scenarios for this task:**
- Scenario 1: Unquoted multi-word query (variadic args)
- Scenario 2: Flags before query terms (Typer parsing)
- Scenario 3: stdin pipeline (sys.stdin detection)

## Implementation Checklist

### Unit Tests First (TDD - RED)
- [ ] Create `tests/unit/cli/test_search_args.py`
- [ ] Write `test_search_variadic_args_joined()` - "auth middleware" â†’ "auth middleware"
- [ ] Write `test_search_flags_before_args()` - "--limit 5 auth" parses correctly
- [ ] Write `test_search_stdin_pipe()` - Use `isolated_cli_runner.invoke(app, ["search"], input="query\n")`
- [ ] Write `test_search_empty_stdin_non_interactive()` - Exit 2 when empty, use `monkeypatch.setattr(sys.stdin, 'isatty', lambda: False)`
- [ ] Write `test_search_no_args_interactive()` - Exit 2 when interactive terminal, use `monkeypatch.setattr(sys.stdin, 'isatty', lambda: True)`
- [ ] Run: `pytest tests/unit/cli/test_search_args.py` - all 5+ tests fail âœ“

### Implementation (GREEN)
- [ ] MODIFY: `src/gitctx/cli/search.py`
- [ ] Implement `search()` command signature:
  ```python
  @app.command()
  def search(
      query: Optional[list[str]] = typer.Argument(None, help="Search query"),
      limit: int = typer.Option(10, "--limit", "-n", min=1, max=100),
      format: str = typer.Option("terse", "--format"),
      verbose: bool = typer.Option(False, "--verbose", "-v"),
      mcp: bool = typer.Option(False, "--mcp"),
  ) -> None:
  ```
- [ ] Implement `_get_query_text(query: Optional[list[str]]) -> str` helper:
  ```python
  def _get_query_text(query: Optional[list[str]]) -> str:
      """Extract query text from CLI args or stdin.

      Args:
          query: CLI arguments after 'gitctx search' (e.g., ['auth', 'middleware'])

      Returns:
          str: Query text joined with spaces (e.g., 'auth middleware')

      Raises:
          typer.Exit(2): If no query provided (neither args nor stdin)
      """
      # If query provided as args, join and return early
      if query:
          return " ".join(query)

      # No args provided - check stdin
      if sys.stdin.isatty():
          # Interactive terminal with no piped input
          console_err.print(
              f"[red]{SYMBOLS['error']}[/red] Error: Query required (from args or stdin)"
          )
          raise typer.Exit(2)

      # Read from piped stdin
      query_text = sys.stdin.read().strip()
      if not query_text:
          console_err.print(
              f"[red]{SYMBOLS['error']}[/red] Error: Query required (from args or stdin)"
          )
          raise typer.Exit(2)

      return query_text
  ```
- [ ] Run: `pytest tests/unit/cli/test_search_args.py` - all tests pass âœ“

### BDD Implementation
- [ ] MODIFY: `tests/e2e/steps/search_steps.py`
- [ ] Implement step: `@then('results should match query "{query}"')`
  ```python
  @then(parsers.parse('results should match query "{query}"'))
  def check_results_match_query(query: str, context: dict[str, Any]) -> None:
      # Basic verification - just check command succeeded
      # Full result verification in TASK-0001.3.2.3
      assert context['result'].exit_code == 0
  ```
- [ ] Implement step: `@when('I pipe "{text}" to "{command}"')`
  ```python
  @when(parsers.parse('I pipe "{text}" to "{command}"'))
  def pipe_to_command(
      text: str,
      command: str,
      e2e_cli_runner: CliRunner,
      context: dict[str, Any],
      monkeypatch: pytest.MonkeyPatch,
  ) -> None:
      """Pipe text to command via stdin using CliRunner.

      CliRunner natively supports stdin via input= parameter.
      No subprocess needed - uses in-process Typer testing.
      """
      from gitctx.cli.main import app

      # Change to repo directory if needed
      if repo_path := context.get("repo_path"):
          monkeypatch.chdir(repo_path)

      # CliRunner handles stdin via input= parameter
      result = e2e_cli_runner.invoke(app, ["search"], input=text)

      # Store results for subsequent Then steps
      context["result"] = result
      context["stdout"] = result.stdout
      context["exit_code"] = result.exit_code
  ```
- [ ] Run: `pytest tests/e2e/test_search_features.py -k "unquoted or flags_before or stdin"` - 3 scenarios pass âœ“

### Verification
- [ ] All unit tests pass (`test_search_args.py`)
- [ ] BDD scenarios 1-3 pass (variadic, flags, stdin)
- [ ] BDD scenarios 4-11 still fail (expected):
  - Scenario 4: Results sorted by similarity (needs LanceDB search in TASK-3)
  - Scenario 5: Result limit (needs LanceDB search in TASK-3)
  - Scenario 6: No results handling (needs LanceDB search in TASK-3)
  - Scenario 7: Search before indexing (needs index detection in TASK-3)
  - Scenario 8: Empty stdin with no args (needs error handling in TASK-3)
  - Scenarios 9-10: Invalid limit validation (needs Typer validation in TASK-3)
  - Scenario 11: Performance test (needs infrastructure in TASK-4)
- [ ] Unit test: Corrupted index (needs TableNotFoundError handling in TASK-3)
- [ ] Mock `QueryEmbedder.embed_query()` in all tests to return `np.random.rand(3072)` or use `test_embedding_vector()` fixture

## Files to Create/Modify

- CREATE: `tests/unit/cli/test_search_args.py` (~120 lines, 5+ tests)
- MODIFY: `src/gitctx/cli/search.py` (add search() function + _get_query_text() helper, ~80 lines)
- MODIFY: `tests/e2e/steps/search_steps.py` (implement 2 new steps, ~40 lines)

## Pattern Reuse

- `isolated_cli_runner` (tests/conftest.py:190) - For unit tests with filesystem isolation and HOME isolation
- `e2e_cli_runner` (tests/e2e/conftest.py:135) - For BDD tests with full git isolation and automatic env merging
- `monkeypatch.setattr(sys.stdin, 'isatty', ...)` - Control TTY vs pipe behavior in tests (from Click's test suite)

## Mock Approach

**Mock QueryEmbedder in tests:**
```python
from unittest.mock import Mock, patch
import numpy as np

@patch('gitctx.cli.search.QueryEmbedder')
def test_search_with_query(mock_embedder_class, isolated_cli_runner):
    """Test search with mocked embedding generation."""
    # Mock the QueryEmbedder class and its embed_query method
    mock_embedder = Mock()
    mock_embedder.embed_query.return_value = np.random.rand(3072)  # 3072-dim vector
    mock_embedder_class.return_value = mock_embedder

    result = isolated_cli_runner.invoke(app, ['search', 'test'])
    assert result.exit_code == 0
```

**Test stdin with CliRunner:**
```python
def test_search_stdin_pipe(isolated_cli_runner, monkeypatch):
    """Test search reads from stdin when no args provided."""
    # Simulate piped input (non-TTY)
    monkeypatch.setattr('sys.stdin.isatty', lambda: False)

    # Use CliRunner's native input= parameter
    result = isolated_cli_runner.invoke(app, ['search'], input='query text\n')

    assert result.exit_code == 0
    assert 'query text' in result.stdout
```

**Test interactive terminal detection:**
```python
def test_search_no_args_interactive(isolated_cli_runner, monkeypatch):
    """Test search exits with error when interactive and no args."""
    # Simulate interactive terminal (TTY)
    monkeypatch.setattr('sys.stdin.isatty', lambda: True)

    result = isolated_cli_runner.invoke(app, ['search'])

    assert result.exit_code == 2
    assert 'Error: Query required' in result.output
```

## Dependencies

- â›” **BLOCKED by STORY-0001.3.1** - Cannot implement real `generate_query_embedding()` call until STORY-0001.3.1 completes. Use mocks for all tests in this task.

## Notes

- Typer handles `min=1, max=100` validation automatically for `--limit`
- `sys.stdin.isatty()` returns False when piped, True when interactive
- Error messages follow TUI_GUIDE.md exit code standards (exit 2 = usage error)
- **Testing stdin:** Use `CliRunner.invoke(app, [...], input="text\n")` instead of subprocess (Typer/Click best practice)
- **Testing isatty():** Use `monkeypatch.setattr('sys.stdin.isatty', lambda: True/False)` to simulate TTY vs pipe
- Pattern adapted from Click's own test suite (tests/test_utils.py)
