# TASK-0001.3.2.5: Final Integration + Complete BDD Suite

**Parent Story**: [STORY-0001.3.2](README.md)
**Status**: ðŸ”µ Not Started
**Estimated Hours**: 3
**Actual Hours**: -

## Objective

Complete final E2E integration test (index â†’ search), verify all 11 denormalized result fields, complete all 12 E2E BDD scenarios. Verify all acceptance criteria are met and story is complete.

## BDD Progress

**Before this task**: 11/12 E2E scenarios passing
**After this task**: 12/12 E2E scenarios passing âœ… (ALL scenarios complete)

**Scenarios for this task:**
- All 12 E2E scenarios should pass after integration verification
- 1 unit test scenario (corrupted index) already passing from TASK-3

## Implementation Checklist

### Integration Tests
- [ ] CREATE: `tests/e2e/test_search_integration.py`:
  ```python
  import pytest
  import os
  from pathlib import Path
  from gitctx.cli import app

  @pytest.mark.vcr()
  def test_full_pipeline_index_then_search(e2e_git_repo, e2e_cli_runner):
      """Test complete pipeline: index â†’ search with real results."""
      os.chdir(e2e_git_repo)

      # Index the repository
      result = e2e_cli_runner.invoke(app, ['index'])
      assert result.exit_code == 0, f"Index failed: {result.output}"

      # Verify index created
      assert Path('.gitctx/db/lancedb').exists()

      # Search for content
      result = e2e_cli_runner.invoke(app, ['search', 'function', 'definition'])
      assert result.exit_code == 0, f"Search failed: {result.output}"

      # Verify result format: "{count} results in {duration:.2f}s"
      # Example: "5 results in 1.23s" or "0 results in 0.42s"
      import re
      pattern = r'\d+ results in \d+\.\d{2}s'
      assert re.search(pattern, result.stdout), f"Expected format '{pattern}' in: {result.stdout}"

  def test_search_empty_result_set_exit_zero(e2e_git_repo, e2e_cli_runner):
      """Test that empty results return exit 0 (not an error)."""
      os.chdir(e2e_git_repo)

      # Index first
      result = e2e_cli_runner.invoke(app, ['index'])
      assert result.exit_code == 0

      # Search for non-existent content
      result = e2e_cli_runner.invoke(app, ['search', 'nonexistent_function_xyz_123'])
      assert result.exit_code == 0  # Success, just no results
      assert '0 results in' in result.stdout
  ```

### Result Field Verification (Unit Test)
- [ ] MODIFY: `tests/unit/cli/test_search_integration.py`:
  ```python
  def test_search_results_include_all_metadata_fields(cli_runner):
      """Verify store.search() returns all 11 denormalized fields."""
      from unittest.mock import patch, Mock

      with patch('gitctx.cli.search.LanceDBStore') as MockStore:
          mock_store = MockStore.return_value
          mock_store.search.return_value = [{
              'file_path': 'src/test.py',
              'start_line': 10,
              'end_line': 20,
              '_distance': 0.85,
              'commit_sha': 'abc123',
              'commit_message': 'Test commit',
              'commit_date': '2025-10-12',
              'author_name': 'Test Author',
              'is_head': True,
              'language': 'python',
              'chunk_content': 'def test(): pass'
          }]
          mock_store.count.return_value = 100

          with patch('gitctx.cli.search.generate_query_embedding') as mock_embed:
              mock_embed.return_value = [0.1] * 3072

              result = cli_runner.invoke(app, ['search', 'test'])

              # Verify store.search was called with correct params
              mock_store.search.assert_called_once()
              call_kwargs = mock_store.search.call_args.kwargs
              assert 'query_vector' in call_kwargs
              assert 'limit' in call_kwargs
              assert call_kwargs['filter_head_only'] is False

              # Verify command succeeded
              assert result.exit_code == 0
  ```

### Final BDD Verification
- [ ] Run: `pytest tests/e2e/features/search.feature -v`
- [ ] Verify: 12/12 scenarios pass âœ…
- [ ] Run: `pytest tests/unit/cli/test_search.py -v`
- [ ] Verify: 1/1 scenario pass (corrupted index)

### Acceptance Criteria Checklist
- [ ] âœ… Query accepts variadic arguments (no quotes needed) - tests/e2e/features/search.feature::test_search_with_unquoted_multiword_query
- [ ] âœ… Query from stdin when no args provided - tests/e2e/features/search.feature::test_search_from_stdin_pipeline
- [ ] âœ… Search returns denormalized result metadata (11 fields) - tests/unit/cli/test_search_integration.py::test_search_results_include_all_metadata_fields
- [ ] âœ… Results sorted by `_distance` ascending (0.0 = perfect match first) - tests/e2e/features/search.feature::test_search_returns_results_sorted_by_similarity_score
- [ ] âœ… Configurable result limit (default 10, range 1-100) - tests/e2e/features/search.feature::test_search_with_result_limit
- [ ] âœ… Missing index detection (exit code 8) - tests/e2e/features/search.feature::test_search_before_indexing_exit_code_8 (STORY-0001.3.2)
- [ ] âœ… Corrupted index detection (exit code 1) - tests/unit/cli/test_search.py::test_corrupted_index_missing_table
- [ ] âœ… Empty result set (exit code 0) - tests/e2e/test_search_integration.py::test_search_empty_result_set_exit_zero
- [ ] âœ… Search performance (p95 <2.0s for 10K vectors) - tests/e2e/test_search_performance.py::test_search_p95_latency_under_2_seconds

### Quality Gates
- [ ] Run full test suite: `uv run pytest`
- [ ] Run linter: `uv run ruff check src tests`
- [ ] Run formatter: `uv run ruff format src tests`
- [ ] Run type checker: `uv run mypy src`
- [ ] Check coverage: `uv run pytest --cov=src/gitctx --cov-report=term`
- [ ] Coverage â‰¥90% for `src/gitctx/cli/search.py`
- [ ] All quality gates pass âœ“

## Files to Create/Modify

- CREATE: `tests/e2e/test_search_integration.py` (~60 lines, 2 E2E tests)
- MODIFY: `tests/unit/cli/test_search_integration.py` (add metadata field verification, ~40 lines)

## Pattern Reuse

- `e2e_git_repo` (tests/e2e/conftest.py:162) - For basic repo with Python file
- `@pytest.mark.vcr()` (tests/e2e/conftest.py:370) - For API recording in E2E
- `cli_runner` (tests/conftest.py:190) - For unit tests with mocks
- Full pipeline pattern from existing E2E tests

## Performance Targets

Not applicable - performance validated in TASK-4.

## Dependencies

None - all prerequisites complete by TASK-4

## Notes

- This task completes 12/12 E2E BDD scenarios (no network error BDD - that's unit-tested)
- Network/API errors remain unit-tested only (from TASK-3) per design decision
- Result formatting (terse/verbose/MCP) deferred to STORY-0001.3.3
- Output format: `"{count} results in {duration:.2f}s"` (e.g., "5 results in 1.23s")
- Format validation: Regex pattern `r'\d+ results in \d+\.\d{2}s'`
- All 11 denormalized fields verified via unit test (display format in next story)

## Story Completion Verification

After this task:
- âœ… All 9 acceptance criteria met
- âœ… 12/12 E2E BDD scenarios passing
- âœ… 1/1 unit test scenario passing
- âœ… All quality gates passing
- âœ… Coverage â‰¥90%
- âœ… Story ready for PR
