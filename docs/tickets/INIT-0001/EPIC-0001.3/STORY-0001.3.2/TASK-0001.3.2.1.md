# TASK-0001.3.2.1: Write ALL BDD Scenarios (13 total)

**Parent Story**: [STORY-0001.3.2](README.md)
**Status**: âœ… Complete
**Estimated Hours**: 3
**Actual Hours**: 2

## Objective

Write all 13 BDD scenarios upfront following incremental BDD pattern (TASK-1 = define all behavior). This includes 12 E2E scenarios in Gherkin format and 1 unit test for corrupted database mocking. All scenarios must fail with NotImplementedError after this task.

## BDD Progress

**Before this task**: 0/13 scenarios (none exist)
**After this task**: 0/13 passing (all failing with NotImplementedError)

**Scenarios for this task:**

**E2E Scenarios (12 total):**
1. Unquoted multi-word query
2. Flags before query terms
3. stdin pipeline
4. Results sorted by similarity
5. Result limit
6. No results (empty result set)
7. Search before indexing (exit 8)
8. Empty stdin with no args (exit 2)
9. Invalid limit too low (exit 2)
10. Invalid limit too high (exit 2)
11. Performance p95 latency (<2.0s)

**Unit Test Scenario (1 total):**
12. Corrupted index with TableNotFoundError (requires mocking)

## Implementation Checklist

### Create Feature File
- [x] Modify `tests/e2e/features/search.feature` (already existed from STORY-0001.3.1)
- [x] Add 11 E2E scenarios from story README (lines 57-135)
- [x] Ensure concrete Given/When/Then steps (no vague assertions)
- [x] Verify @performance marker on scenario 16 (performance test)
- [x] Register `performance` marker in pyproject.toml (required for --strict-markers)

### Create Step Definition Stubs
- [x] Modify `tests/e2e/steps/search_steps.py` (already existed from STORY-0001.3.1)
- [x] Stub: `@then('results should match query {query}')` (line 290)
- [x] Stub: `@when('I pipe {text} to {command}')` (line 302)
- [x] Stub: `@then('exactly {n:d} results should be shown')` (line 296)
- [x] Stub: `@then('results should be sorted by _distance ascending')` (line 310)
- [x] Stub: `@then('each result should show cosine similarity score between {min} and {max}')` (line 316)
- [x] Stub: `@given('an indexed repository with 20+ chunks containing {keyword}')` (line 322)
- [x] Stub: `@given('no index exists at .gitctx/db/lancedb/')` (line 334)
- [x] Stub: `@when('I run {command} with empty stdin in non-interactive terminal')` (line 340)
- [x] Stub: `@given('an indexed repository with {chunk_count:d} chunks')` (line 346)
- [x] Stub: `@when('I run search {count:d} times with query {query}')` (line 358)
- [x] Stub: `@then('p95 response time should be under {threshold:f} seconds')` (line 364)
- [x] Stub: `@then('all requests should complete within {max_time:f} seconds')` (line 370)
- [x] All stubs raise `NotImplementedError("Pending TASK-X")` with proper task references

### Create Unit Test for Corrupted Index
- [x] Modify `tests/unit/cli/test_search.py` (already existed from STORY-0001.3.1)
- [x] Write `test_corrupted_index_missing_table()` (line 356-417)
- [x] Mock `lancedb.connect()` to raise `TableNotFoundError`
- [x] Test marked with `@pytest.mark.skip(reason="Pending TASK-0001.3.2.3")`

### Verification
- [x] Run: `pytest tests/e2e/test_search_features.py -v`
- [x] Output shows: 16 scenarios total, 5 passing (STORY-0001.3.1), 11 failing (new scenarios)
- [x] 8 scenarios fail with NotImplementedError (stubs working correctly)
- [x] 3 scenarios fail with AssertionError (missing functionality for later tasks)
- [x] Run: `pytest tests/unit/cli/test_search.py::test_corrupted_index_missing_table -v`
- [x] Output shows: 1 skipped ("Pending TASK-0001.3.2.3")
- [x] All scenarios present in feature file match story README

## Files to Create/Modify

- MODIFY: `tests/e2e/features/search.feature` (added 11 scenarios, lines 57-135)
- MODIFY: `tests/e2e/steps/search_steps.py` (added 13 stub step definitions, lines 287-374)
- MODIFY: `tests/unit/cli/test_search.py` (added 1 skipped test, lines 356-417)
- MODIFY: `pyproject.toml` (registered `performance` marker, line 225)

## Pattern Reuse

- `context` fixture (tests/e2e/steps/cli_steps.py:14) - Store BDD state between steps
- Existing `@when('I run "{command}"')` step (tests/e2e/steps/cli_steps.py:27) - Reuse for CLI invocation
- `@pytest.mark.skip` pattern for pending tests

## Dependencies

None - this task only writes test specifications, no implementation

## Notes

This is TASK-1 in incremental BDD pattern:
- Defines WHAT the system should do (all 13 scenarios)
- Does NOT implement HOW it does it (all stubs fail)
- Subsequent tasks will progressively implement steps to pass scenarios
