# TASK-0001.3.3.3: Implement TerseFormatter (TDD)

**Parent Story**: [STORY-0001.3.3](README.md)
**Status**: ✅ Complete
**Estimated Hours**: 4
**Actual Hours**: 3

## Objective

Implement TerseFormatter with single-line output format, using SYMBOLS dict for platform-aware HEAD markers. This is the default formatter for all search commands.

## BDD Progress

**Before this task**: 1/7 scenarios passing
**After this task**: 4/7 scenarios passing

**Scenarios for this task:**
- Scenario 1: Default terse output format
- Scenario 2: HEAD commit marked with symbol
- Scenario 5: Zero results display (already passing, ensure it stays green)
- Scenario 6: Conflicting output flags rejected

## Implementation Checklist

### Unit Tests First (TDD - RED)
- [ ] Create `tests/unit/formatters/test_terse.py`
- [ ] Write test: `test_terse_formatter_has_name_and_description`
- [ ] Write test: `test_terse_formatter_single_line_format`
- [ ] Write test: `test_terse_formatter_includes_file_path`
- [ ] Write test: `test_terse_formatter_includes_line_number`
- [ ] Write test: `test_terse_formatter_includes_score_two_decimals`
- [ ] Write test: `test_terse_formatter_includes_commit_sha_short`
- [ ] Write test: `test_terse_formatter_includes_commit_date`
- [ ] Write test: `test_terse_formatter_includes_author_name`
- [ ] Write test: `test_terse_formatter_includes_commit_message_truncated`
- [ ] Write test: `test_terse_formatter_head_marker_modern_terminal`
- [ ] Write test: `test_terse_formatter_head_marker_legacy_windows`
- [ ] Write test: `test_terse_formatter_historic_no_marker`
- [ ] Write test: `test_terse_formatter_message_truncated_at_50_chars`
- [ ] Write test: `test_terse_formatter_zero_results_empty_output`
- [ ] Run tests - all fail ✓

### Implementation (GREEN)
- [ ] Create `src/gitctx/formatters/terse.py`
- [ ] Import SYMBOLS from `gitctx.cli.symbols`
- [ ] Import Console from `rich.console`
- [ ] Create TerseFormatter class
  - Set `name = "terse"`
  - Set `description = "Terse single-line format (default)"`
- [ ] Implement `format(results: list[dict], console: Console) -> None`
  - Iterate over results
  - Extract values: file_path, start_line, _distance, is_head, commit_sha, commit_date, author_name, commit_message
  - Format HEAD marker: `SYMBOLS['head']` if is_head, else space
  - Truncate commit_message to 50 chars
  - Format line: `{file}:{line}:{score:.2f}{marker} {sha[:7]} ({date}, {author}) "{msg[:50]}"`
  - Print to console
- [ ] Register in `src/gitctx/formatters/__init__.py`
  - Import TerseFormatter
  - Add to FORMATTERS dict: `"terse": TerseFormatter()`
- [ ] Run tests - all pass ✓

### Refactor
- [ ] Add docstrings with format example
- [ ] Add type hints to all parameters
- [ ] Extract format string to constant if it improves readability
- [ ] Run mypy - no errors

### BDD Implementation
- [ ] Implement step: `@then("each line should match pattern: {pattern}")`
  - Use regex to validate line format
- [ ] Implement step: `@then("output should contain commit SHA")`
- [ ] Implement step: `@then("output should contain author name")`
- [ ] Implement step: `@then("output should contain commit date")`
- [ ] Implement step: `@then('output should contain results summary: "{pattern}"')`
- [ ] Implement step: `@then('HEAD results should show "●" or "[HEAD]" marker')`
- [ ] Implement step: `@then("historic results should have no marker")`
- [ ] Implement step: `@then('the output should contain "Error"')`
- [ ] Implement step: `@then('the output should contain "mutually exclusive"')`
- [ ] Run BDD tests - Scenarios 1, 2, 5, 6 pass (4/7) ✓

### Verification
- [ ] All unit tests pass (15+ tests)
- [ ] Mypy passes
- [ ] Ruff check passes
- [ ] Code coverage >90% for terse formatter
- [ ] BDD: 4/7 scenarios passing
- [ ] Manual test: Run `gitctx search test` and verify output format

## Files to Create/Modify

- **CREATE**: `src/gitctx/formatters/terse.py` (~60 lines, formatter class)
- **CREATE**: `tests/unit/formatters/test_terse.py` (~200 lines, 15+ tests)
- **MODIFY**: `src/gitctx/formatters/__init__.py` (register TerseFormatter)
- **MODIFY**: `tests/e2e/steps/test_formatting_steps.py` (implement 9 steps)

## Pattern Reuse

- **SYMBOLS dict** (`src/gitctx/cli/symbols.py`) - Platform-aware symbols
- **Rich Console** - Output mechanism
- **String formatting** - Python f-strings for format

## Format Example

```
src/auth.py:45:0.92 ● f9e8d7c (2025-10-02, Alice) "Add OAuth support"
src/login.py:23:0.76   abc1234 (2025-09-15, Bob) "Initial login implementation with basic validat"
```

## Success Criteria

- [ ] TerseFormatter class implemented and registered
- [ ] Single-line format matches specification exactly
- [ ] HEAD marker shows ● or [HEAD] based on terminal type
- [ ] Historic commits show no marker (space character)
- [ ] Commit message truncated to 50 chars
- [ ] 15+ unit tests passing
- [ ] 4/7 BDD scenarios passing
- [ ] Code coverage >90%
- [ ] Commit: `feat(TASK-0001.3.3.3): Implement TerseFormatter with TDD (4/7 BDD passing)`
