# TASK-0001.3.3.4: Implement VerboseFormatter + MCPFormatter (TDD)

**Parent Story**: [STORY-0001.3.3](README.md)
**Status**: ✅ Complete
**Estimated Hours**: 5
**Actual Hours**: 5

## Objective

Implement VerboseFormatter with syntax-highlighted code blocks and MCPFormatter with YAML frontmatter. Both optimized for their respective use cases (human review vs AI consumption).

## BDD Progress

**Before this task**: 4/7 scenarios passing
**After this task**: 6/7 scenarios passing

**Scenarios for this task:**
- Scenario 3: Verbose output with syntax highlighting
- Scenario 4: MCP output with structured markdown

## Implementation Checklist

### VerboseFormatter - Unit Tests First (TDD - RED)
- [x] Create `tests/unit/formatters/test_verbose.py`
- [x] Write test: `test_verbose_formatter_has_name_and_description`
- [x] Write test: `test_verbose_formatter_multiline_format`
- [x] Write test: `test_verbose_formatter_header_with_line_range`
- [x] Write test: `test_verbose_formatter_score_in_header`
- [x] Write test: `test_verbose_formatter_head_marker_in_header`
- [x] Write test: `test_verbose_formatter_commit_sha_in_header`
- [x] Write test: `test_verbose_formatter_metadata_line_dimmed`
- [x] Write test: `test_verbose_formatter_syntax_highlighting`
- [x] Write test: `test_verbose_formatter_line_numbers_enabled`
- [x] Write test: `test_verbose_formatter_start_line_offset`
- [x] Write test: `test_verbose_formatter_theme_monokai`
- [x] Write test: `test_verbose_formatter_language_from_result`
- [x] Write test: `test_verbose_formatter_language_fallback_markdown`
- [x] Write test: `test_verbose_formatter_blank_line_separator`
- [x] Run tests - all fail ✓

### VerboseFormatter - Implementation (GREEN)
- [x] Create `src/gitctx/formatters/verbose.py`
- [x] Import SYMBOLS, Console, Syntax
- [x] Create VerboseFormatter class
  - Set `name = "verbose"`
  - Set `description = "Verbose output with code context"`
- [x] Implement `format(results: list[dict], console: Console) -> None`
  - For each result:
    - Print header: `{file}:{start}-{end} ({score:.2f}) {marker} {sha[:7]}`
    - Print metadata (dimmed): `[dim]{commit_message}[/dim]`
    - Get language from result (fallback to "markdown")
    - Create Syntax object with line_numbers=True, start_line={start}, theme="monokai"
    - Print syntax-highlighted code
    - Print blank line separator
- [x] Register in `__init__.py`: `"verbose": VerboseFormatter()`
- [x] Run tests - all pass ✓

### MCPFormatter - Unit Tests First (TDD - RED)
- [x] Create `tests/unit/formatters/test_mcp.py`
- [x] Write test: `test_mcp_formatter_has_name_and_description`
- [x] Write test: `test_mcp_formatter_starts_with_yaml_delimiter`
- [x] Write test: `test_mcp_formatter_yaml_has_results_key`
- [x] Write test: `test_mcp_formatter_yaml_array_structure`
- [x] Write test: `test_mcp_formatter_yaml_has_file_path`
- [x] Write test: `test_mcp_formatter_yaml_has_line_numbers`
- [x] Write test: `test_mcp_formatter_yaml_has_score_three_decimals`
- [x] Write test: `test_mcp_formatter_yaml_has_commit_sha`
- [x] Write test: `test_mcp_formatter_yaml_parses_successfully` (use pyyaml)
- [x] Write test: `test_mcp_formatter_markdown_headers`
- [x] Write test: `test_mcp_formatter_metadata_line`
- [x] Write test: `test_mcp_formatter_code_blocks_with_language`
- [x] Write test: `test_mcp_formatter_language_fallback_markdown`
- [x] Run tests - all fail ✓

### MCPFormatter - Implementation (GREEN)
- [x] Create `src/gitctx/formatters/mcp.py`
- [x] Import Console
- [x] Create MCPFormatter class
  - Set `name = "mcp"`
  - Set `description = "Structured markdown for AI tools"`
- [x] Implement `format(results: list[dict], console: Console) -> None`
  - Print YAML frontmatter:
    - Print `---`
    - Print `results:`
    - For each result:
      - Print `  - file_path: {path}`
      - Print `    line_numbers: {start}-{end}`
      - Print `    score: {score:.3f}`
      - Print `    commit_sha: {sha}`
    - Print `---\n`
  - Print Markdown body:
    - For each result:
      - Print `## {file}:{start}-{end}`
      - Print `**Score:** {score:.3f} | **Commit:** {sha[:7]}`
      - Get language (fallback to "markdown")
      - Print code block: ` ```{language}`
      - Print chunk_content
      - Print ` ```\n`
- [x] Register in `__init__.py`: `"mcp": MCPFormatter()`
- [x] Run tests - all pass ✓

### Refactor
- [x] Add comprehensive docstrings with examples
- [x] Add type hints to all parameters
- [x] Run mypy - no errors
- [x] DRY: Extract language fallback logic if duplicated

### BDD Implementation
- [x] Implement step: `@given("an indexed repository with HEAD and historic commits")`
- [x] Implement step: `@given("an indexed repository with unknown file type (.xyz)")`
- [x] Implement step: `@then("output should contain syntax-highlighted code blocks")`
  - Check for ANSI color codes (Rich.Syntax adds them)
- [x] Implement step: `@then("code blocks should show line numbers")`
- [x] Implement step: `@then("output should contain file paths with line ranges")`
- [x] Implement step: `@then('output should start with "---"')`
- [x] Implement step: `@then('output should contain "results:"')`
- [x] Implement step: `@then("YAML frontmatter should parse successfully")`
  - Use pyyaml to parse the frontmatter
- [x] Run BDD tests - Scenarios 3, 4 pass (6/7 total) ✓

### Verification
- [x] All unit tests pass (56 tests total)
- [x] Mypy passes
- [x] Ruff check passes
- [x] Code coverage >90% for both formatters
- [x] BDD: 6/7 scenarios passing
- [ ] Manual test: Run `gitctx search test --verbose` and verify output
- [ ] Manual test: Run `gitctx search test --mcp` and verify YAML parses

## Files to Create/Modify

- **CREATE**: `src/gitctx/formatters/verbose.py` (~70 lines, formatter class)
- **CREATE**: `src/gitctx/formatters/mcp.py` (~80 lines, formatter class)
- **CREATE**: `tests/unit/formatters/test_verbose.py` (~220 lines, 14+ tests)
- **CREATE**: `tests/unit/formatters/test_mcp.py` (~180 lines, 13+ tests)
- **MODIFY**: `src/gitctx/formatters/__init__.py` (register both formatters)
- **MODIFY**: `tests/e2e/steps/test_formatting_steps.py` (implement 8 steps)

## Pattern Reuse

- **Rich.Syntax** - Syntax highlighting with line numbers
- **Rich Console** - Output mechanism
- **SYMBOLS dict** - HEAD markers (VerboseFormatter)
- **YAML validation** - pyyaml in tests

## Format Examples

### VerboseFormatter Output
```
src/auth.py:45-52 (0.92) ● f9e8d7c
Add OAuth support

  45 def authenticate(user, password):
  46     """Authenticate a user against the database."""
  47     if not user:
  48         raise ValueError("User required")
  49     # Check password...
  50     return auth_token
  51
  52 # End of function
```

### MCPFormatter Output
```yaml
---
results:
  - file_path: src/auth.py
    line_numbers: 45-52
    score: 0.920
    commit_sha: f9e8d7c1234567890abcdef
---

## src/auth.py:45-52
**Score:** 0.920 | **Commit:** f9e8d7c
```python
def authenticate(user, password):
    """Authenticate a user against the database."""
    if not user:
        raise ValueError("User required")
    # Check password...
    return auth_token
```
```

## Success Criteria

- [ ] VerboseFormatter implemented with Rich.Syntax
- [ ] MCPFormatter implemented with valid YAML frontmatter
- [ ] Both formatters registered in FORMATTERS dict
- [ ] Language fallback to "markdown" (never plain text)
- [ ] 25+ unit tests passing
- [ ] 6/7 BDD scenarios passing
- [ ] Code coverage >90%
- [ ] YAML parses successfully with pyyaml
- [ ] Commit: `feat(TASK-0001.3.3.4): Implement VerboseFormatter and MCPFormatter (6/7 BDD passing)`
