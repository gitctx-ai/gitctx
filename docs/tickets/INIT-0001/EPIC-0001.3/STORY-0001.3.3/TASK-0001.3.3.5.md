# TASK-0001.3.3.5: CLI Integration + Final BDD Scenario

**Parent Story**: [STORY-0001.3.3](README.md)
**Status**: 🔵 Not Started
**Estimated Hours**: 4
**Actual Hours**: -

## Objective

Integrate formatters into the search CLI with --format, --verbose, --mcp flags and mutual exclusivity validation. Implement final BDD scenario for language fallback. Add results summary line.

## BDD Progress

**Before this task**: 6/7 scenarios passing
**After this task**: 7/7 scenarios passing ✅

**Scenarios for this task:**
- Scenario 7: Unknown language fallback to markdown (final scenario)

## Implementation Checklist

### CLI Integration Tests (TDD - RED)
- [ ] Create `tests/unit/cli/test_search_formatting.py`
- [ ] Write test: `test_search_default_format_terse`
- [ ] Write test: `test_search_format_verbose_flag`
- [ ] Write test: `test_search_format_mcp_flag`
- [ ] Write test: `test_search_verbose_flag_sets_format`
- [ ] Write test: `test_search_mcp_flag_sets_format`
- [ ] Write test: `test_search_mcp_and_verbose_mutually_exclusive`
- [ ] Write test: `test_search_format_mcp_and_verbose_mutually_exclusive`
- [ ] Write test: `test_search_results_summary_line`
- [ ] Write test: `test_search_zero_results_summary`
- [ ] Write test: `test_search_unknown_formatter_error`
- [ ] Run tests - all fail ✓

### CLI Implementation (GREEN)
- [ ] Open `src/gitctx/cli/search.py` (from STORY-0001.3.2)
- [ ] Import `get_formatter` from `gitctx.formatters`
- [ ] Add CLI parameters to `search()` function:
  - `format: str = typer.Option("terse", "--format", help="Output format")`
  - `verbose: bool = typer.Option(False, "--verbose", "-v", help="Verbose output")`
  - `mcp: bool = typer.Option(False, "--mcp", help="MCP output")`
- [ ] Add flag validation logic:
  ```python
  if verbose and mcp:
      console.print(
          f"[red]{SYMBOLS['error']}[/red] Error: --mcp and --verbose are mutually exclusive",
          file=sys.stderr
      )
      raise typer.Exit(2)
  ```
- [ ] Add format resolution:
  ```python
  if verbose:
      format = "verbose"
  elif mcp:
      format = "mcp"
  ```
- [ ] Replace result printing with formatter:
  ```python
  formatter = get_formatter(format)
  formatter.format(results, console)
  ```
- [ ] Add results summary line:
  ```python
  console.print(f"\n{len(results)} results in {duration:.2f}s")
  ```
- [ ] Run tests - all pass ✓

### Refactor
- [ ] Add docstring updates for new parameters
- [ ] Ensure error messages use SYMBOLS['error']
- [ ] Run mypy - no errors

### BDD Implementation (Final Scenario)
- [ ] Implement step: `@then('syntax highlighting should use "markdown" language')`
  - Check that output contains markdown-highlighted code
  - Verify no "unknown" or "text" language used
- [ ] Implement step: `@then("code should still be displayed with formatting")`
  - Verify code content is present in output
- [ ] Run BDD tests - Scenario 7 passes (7/7 complete ✅) ✓

### Integration Verification
- [ ] Test full pipeline: `gitctx index && gitctx search test`
- [ ] Test terse (default): `gitctx search test`
- [ ] Test verbose: `gitctx search test --verbose`
- [ ] Test verbose (short flag): `gitctx search test -v`
- [ ] Test MCP: `gitctx search test --mcp`
- [ ] Test format flag: `gitctx search test --format verbose`
- [ ] Test mutual exclusivity: `gitctx search test --mcp --verbose` (should exit 2)
- [ ] Test zero results: `gitctx search nonexistent_xyz_function_abcdef`
- [ ] All manual tests work as expected

### Final Verification
- [ ] All unit tests pass (10+ new tests)
- [ ] All BDD scenarios pass (7/7 ✅)
- [ ] Mypy passes
- [ ] Ruff check passes
- [ ] Code coverage >90% for CLI search module
- [ ] All acceptance criteria in story README checked

## Files to Create/Modify

- **CREATE**: `tests/unit/cli/test_search_formatting.py` (~150 lines, 10+ tests)
- **MODIFY**: `src/gitctx/cli/search.py` (add formatter integration, ~30 lines changed)
- **MODIFY**: `tests/e2e/steps/test_formatting_steps.py` (implement 2 final steps)

## Pattern Reuse

- **SYMBOLS dict** - Error symbol for validation messages
- **Rich Console** - Output for summary line
- **Typer** - CLI flags and validation
- **get_formatter()** - Registry lookup

## CLI Flag Behavior

| Command | Format Used | Valid? |
|---------|-------------|--------|
| `gitctx search test` | terse | ✅ |
| `gitctx search test --verbose` | verbose | ✅ |
| `gitctx search test -v` | verbose | ✅ |
| `gitctx search test --mcp` | mcp | ✅ |
| `gitctx search test --format verbose` | verbose | ✅ |
| `gitctx search test --format mcp` | mcp | ✅ |
| `gitctx search test --mcp --verbose` | N/A | ❌ Exit 2 |
| `gitctx search test --format mcp --verbose` | N/A | ❌ Exit 2 |

## Error Messages

**Mutual Exclusivity:**
```
✗ Error: --mcp and --verbose are mutually exclusive
```

**Unknown Formatter:**
```
✗ Unknown formatter: invalid. Available: terse, verbose, mcp
```

## Success Criteria

- [ ] CLI flags --format, --verbose, --mcp implemented
- [ ] Mutual exclusivity validation works (exit code 2)
- [ ] Formatter integration replaces direct result printing
- [ ] Results summary line shows count and duration
- [ ] 10+ unit tests passing
- [ ] 7/7 BDD scenarios passing ✅
- [ ] All acceptance criteria checked in story
- [ ] Code coverage >90%
- [ ] Manual testing confirms all formats work
- [ ] Commit: `feat(TASK-0001.3.3.5): CLI integration with formatter flags (7/7 BDD passing ✅)`
