# TASK-0001.4.2.2: Create GitHeadBooster Class with TDD

**Parent Story**: [STORY-0001.4.2](README.md)
**Status**: ðŸ”µ Not Started
**Estimated Hours**: 3-4
**Actual Hours**: -

## Objective

Create GitHeadBooster class using TDD to apply 1.5x score boost to HEAD chunks. Implement score boosting algorithm with configurable multiplier. Write comprehensive unit tests BEFORE implementation (TDD - redâ†’greenâ†’refactor). Implement first BDD step for score verification.

## BDD Progress

**Before this task**: 0/3 scenarios passing
**After this task**: 1/3 scenarios passing (Scenario 1: HEAD ranks higher ðŸŸ¡)

**Scenarios for this task:**
- Scenario 1: HEAD code ranks higher than historical code (partial - basic boost applied, not full ranking verification)

## Implementation Checklist

### Phase 1: Unit Tests First (TDD - RED)

- [ ] Create `tests/unit/search/test_git_head_booster.py`
  - [ ] Test booster initialization with default multiplier (1.5)
  - [ ] Test booster initialization with custom multiplier
  - [ ] Test boost() method with single HEAD result
  - [ ] Test boost() method with single historical result (no boost)
  - [ ] Test boost() method with mixed HEAD and historical results
  - [ ] Test boost() preserves original scores in metadata
  - [ ] Test boost() handles empty results list
  - [ ] Test boost() applies multiplier correctly (score * 1.5)
  - [ ] Test boost() maintains result order (doesn't rerank, just boosts)
  - [ ] Test boost() with edge cases (score=0, score=1.0, is_head=None)
  - [ ] Test multiplier validation (reject <1.0, reject >3.0)
- [ ] Run tests - all fail ðŸ”´

### Phase 2: Implementation (GREEN)

- [ ] Create `src/gitctx/search/git_head_booster.py`
  - [ ] Import SearchResult from types
  - [ ] Define GitHeadBooster class
  - [ ] Add __init__ with multiplier parameter (default 1.5)
  - [ ] Validate multiplier range (1.0 <= multiplier <= 3.0)
  - [ ] Implement boost() method signature
    ```python
    def boost(self, results: list[SearchResult]) -> list[SearchResult]:
        """Apply HEAD boost to search results.

        Args:
            results: Search results with is_head metadata

        Returns:
            New list with boosted hybrid_score for HEAD chunks
        """
    ```
  - [ ] Implement boost logic:
    - [ ] Check each result.is_head flag
    - [ ] If is_head=True, multiply hybrid_score by multiplier
    - [ ] Store original score in metadata (original_hybrid_score)
    - [ ] Return new SearchResult objects (immutable pattern)
  - [ ] Handle edge cases (None scores, missing is_head, empty list)
- [ ] Run tests - all pass ðŸŸ¢

### Phase 3: Refactor

- [ ] Extract validation into _validate_multiplier() helper
- [ ] Add comprehensive docstrings explaining 1.5x choice
- [ ] Add type hints for all methods
- [ ] Verify immutability (boost() doesn't modify input list)
- [ ] Run tests - all still pass ðŸŸ¢

### Phase 4: BDD Implementation (Partial)

- [ ] Modify `tests/e2e/steps/head_boosting_steps.py`
- [ ] Implement step: "Given a repository with files at different commits"
  - [ ] Parse table with is_head column
  - [ ] Create test repository with HEAD and historical files
  - [ ] Use e2e_indexed_repo_factory with is_head metadata
- [ ] Implement step: "And HEAD results should have 1.5x boost applied"
  - [ ] Parse search results
  - [ ] Verify hybrid_score for HEAD results = original * 1.5
  - [ ] Verify original_hybrid_score metadata preserved
- [ ] Run Scenario 1 - should pass basic boost check âœ“
- [ ] Scenarios 2-3 still fail (ranking/tie-breaking not implemented yet)

### Verification

- [ ] All unit tests pass (12+ tests for GitHeadBooster)
- [ ] Code coverage >90% for GitHeadBooster class
- [ ] Mypy type checking passes
- [ ] Scenario 1 passes basic boost verification (1/3 passing)
- [ ] Scenarios 2-3 still fail with expected errors
- [ ] Commit: `feat(TASK-0001.4.2.2): GitHeadBooster class with 1.5x multiplier (1/3 BDD passing)`

## Files to Create/Modify

- **CREATE**: `src/gitctx/search/git_head_booster.py` (~80 lines, booster class)
- **CREATE**: `src/gitctx/search/__init__.py` (~5 lines, export GitHeadBooster)
- **CREATE**: `tests/unit/search/test_git_head_booster.py` (~300 lines, comprehensive TDD tests)
- **MODIFY**: `tests/e2e/steps/head_boosting_steps.py` (~40 lines, implement 2 steps)

## Pattern Reuse

- **Immutable Result Pattern** - Return new SearchResult objects, don't modify input
  - Example: `SearchResult(content=r.content, ..., hybrid_score=boosted_score)`
  - Maintains functional programming style, easier to test
- **e2e_indexed_repo_factory** (`tests/e2e/conftest.py:353`) - Create repos with is_head metadata
  - Usage: `repo = e2e_indexed_repo_factory(files={'src/auth/current.py': {'content': '...', 'is_head': True}, 'src/auth/old.py': {'content': '...', 'is_head': False}})`
- **Validator Pattern** - Separate validation into helper methods
  - Similar to EmbedderFactory validation in `src/gitctx/models/factory.py`

## Technical Notes

### HEAD Boost Algorithm

```python
def boost(self, results: list[SearchResult]) -> list[SearchResult]:
    """Apply 1.5x boost to HEAD chunks."""
    boosted = []
    for result in results:
        if result.is_head:
            # Boost hybrid_score by multiplier
            new_score = result.hybrid_score * self.multiplier
            # Store original score
            metadata = {**result.metadata, 'original_hybrid_score': result.hybrid_score}
            # Create new result with boosted score
            boosted_result = SearchResult(
                content=result.content,
                file_path=result.file_path,
                chunk_index=result.chunk_index,
                is_head=result.is_head,
                commit_sha=result.commit_sha,
                distance=result.distance,
                bm25_score=result.bm25_score,
                vector_score=result.vector_score,
                hybrid_score=new_score,  # Boosted!
                metadata=metadata,
            )
            boosted.append(boosted_result)
        else:
            # No boost for historical chunks
            boosted.append(result)
    return boosted
```

**Key points:**
- Multiplier applies to hybrid_score (post-RRF score)
- Original score preserved in metadata for transparency
- Immutable pattern (return new objects)
- Conservative 1.5x default (can increase to 2.0x based on EPIC-0001.5 evaluation)

### Multiplier Validation

Valid range: 1.0 â‰¤ multiplier â‰¤ 3.0
- **< 1.0**: Would penalize HEAD (nonsensical)
- **1.0**: No boost (neutral)
- **1.2-2.0**: Typical range from BM25 literature
- **1.5**: Conservative choice (story default)
- **2.0**: Aggressive boost (EPIC acceptance criteria mentions this)
- **> 3.0**: Likely to override semantic relevance (too aggressive)

### SearchResult Extension

Assumes SearchResult has is_head field (added in EPIC-0001.3):
```python
@dataclass
class SearchResult:
    # ... existing fields ...
    is_head: bool  # True if from HEAD commit
    commit_sha: str  # Git commit hash
    hybrid_score: float | None  # RRF score from STORY-0001.4.1
```

## Dependencies

- **TASK-0001.4.2.1** (Write BDD Scenarios) - Must complete first (scenarios must exist)
- **STORY-0001.4.1** (Hybrid Search) - Must complete first (hybrid_score field must exist)
