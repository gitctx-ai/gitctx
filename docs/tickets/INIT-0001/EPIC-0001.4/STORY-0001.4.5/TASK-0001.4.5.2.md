# TASK-0001.4.5.2: Add cents_per_million_tokens to ModelSpec Registry

**Parent Story**: [STORY-0001.4.5](README.md)
**Status**: ðŸ”µ Not Started
**Estimated Hours**: 2
**Actual Hours**: -

## Objective

Add pricing information to the ModelSpec registry by adding a `cents_per_million_tokens` field, verifying current OpenAI pricing from the official website, and implementing unit tests following TDD.

## BDD Progress

**Before this task**: 0/7 scenarios passing
**After this task**: 1/7 scenarios passing (foundation ready - can create repos with pricing context)

**Scenarios for this task:**
- Scenario 1: Default mode shows multi-phase progress (partial - "Given I have a repository" step passing)

## Implementation Checklist

### Pricing Verification (FIRST STEP)

- [ ] Fetch https://openai.com/api/pricing/
- [ ] Verify text-embedding-3-large: $0.13 / 1M tokens (13 cents)
- [ ] Verify text-embedding-3-small: $0.02 / 1M tokens (2 cents)
- [ ] Document verification date in commit message (e.g., "verified: 2025-01-17")

### Unit Tests First (TDD - RED)

- [ ] Create `tests/unit/models/test_registry.py`
- [ ] Write test: `test_get_model_spec_includes_pricing`
  - Verify `cents_per_million_tokens` field exists in returned ModelSpec
  - Assert field is present for both models
- [ ] Write test: `test_pricing_is_integer_cents`
  - Verify data type is `int` (not float)
  - Ensures pricing stored as cents (not dollars)
- [ ] Write test: `test_all_models_have_pricing`
  - Iterate over all models in MODELS dict
  - Assert each has `cents_per_million_tokens` key
- [ ] Write test: `test_pricing_matches_expected_values`
  - Assert text-embedding-3-large has 13 cents
  - Assert text-embedding-3-small has 2 cents
- [ ] Run tests: `uv run pytest tests/unit/models/test_registry.py -v`
- [ ] All tests fail âœ“ (field doesn't exist yet)

### Implementation (GREEN)

- [ ] MODIFY: `src/gitctx/models/registry.py`
- [ ] Add `cents_per_million_tokens: int` to ModelSpec TypedDict
  ```python
  class ModelSpec(TypedDict):
      dimensions: int
      max_tokens: int
      provider: str
      cents_per_million_tokens: int  # NEW: Pricing in cents
  ```
- [ ] Update `text-embedding-3-large` entry:
  ```python
  "text-embedding-3-large": {
      "dimensions": 3072,
      "max_tokens": 8191,
      "provider": "openai",
      "cents_per_million_tokens": 13,  # $0.13/1M tokens (verified: 2025-01-17)
  }
  ```
- [ ] Update `text-embedding-3-small` entry:
  ```python
  "text-embedding-3-small": {
      "dimensions": 1536,
      "max_tokens": 8191,
      "provider": "openai",
      "cents_per_million_tokens": 2,  # $0.02/1M tokens (verified: 2025-01-17)
  }
  ```
- [ ] Add pricing maintenance comment:
  ```python
  # Pricing Maintenance: Values verified against https://openai.com/api/pricing/
  # Each entry includes "verified: YYYY-MM-DD" date.
  # Update pricing when API costs change (check quarterly or when OpenAI announces changes).
  ```
- [ ] Run tests: `uv run pytest tests/unit/models/test_registry.py -v`
- [ ] All tests pass âœ“

### BDD Implementation (Partial)

- [ ] MODIFY: `tests/e2e/steps/tui_progress_steps.py`
- [ ] Implement step: "Given I have a repository with {n:d} files"
  - Use `e2e_git_repo_factory` to create test repo
  - Create N files with sample content
  - Return repo context for subsequent steps
- [ ] Run BDD: `uv run pytest tests/e2e/features/tui_progress.feature::scenario_1 -v`
- [ ] Scenario 1 partially passing (can create repo, rest still NotImplementedError)

### Verification

- [ ] All unit tests pass (4 tests)
- [ ] mypy passes: `uv run mypy src/gitctx/models/registry.py`
- [ ] No ruff warnings: `uv run ruff check src/gitctx/models/registry.py`
- [ ] Pricing verified from official OpenAI source âœ“
- [ ] BDD progress: 0/7 â†’ 1/7 (foundation ready)

## Files to Create/Modify

- MODIFY: `src/gitctx/models/registry.py` (~15 lines changed, add field + pricing values + comments)
- CREATE: `tests/unit/models/test_registry.py` (~80 lines, 4 tests)
- MODIFY: `tests/e2e/steps/tui_progress_steps.py` (~20 lines, implement 1 step)

## Pattern Reuse

- Model registry pattern (extend existing ModelSpec, don't create new structure)
- `e2e_git_repo_factory` fixture for BDD step implementation

## Dependencies

- Requires manual access to https://openai.com/api/pricing/ during implementation
- Must verify pricing before writing tests (ensures test assertions match reality)

## Success Criteria

- âœ… ModelSpec TypedDict includes `cents_per_million_tokens: int` field
- âœ… Both OpenAI models have verified pricing (13 cents and 2 cents)
- âœ… Pricing verified from official OpenAI website (documented in code comments)
- âœ… All unit tests pass (4+ tests)
- âœ… mypy and ruff pass
- âœ… BDD foundation step implemented (can create test repos)
