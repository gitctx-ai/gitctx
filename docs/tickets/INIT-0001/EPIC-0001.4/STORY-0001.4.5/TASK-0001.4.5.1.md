# TASK-0001.4.5.1: Write BDD Scenarios for TUI Progress

**Parent Story**: [STORY-0001.4.5](README.md)
**Status**: ðŸ”µ Not Started
**Estimated Hours**: 3
**Actual Hours**: -

## Objective

Write ALL BDD scenarios for TUI progress tracking, establishing the complete specification before implementation. This task defines WHAT the system should do (not HOW it does it).

## BDD Progress

**Before this task**: 0/7 scenarios (none exist)
**After this task**: 0/7 scenarios passing (all stubbed, all failing - expected for Task 1)

**Scenarios for this task:**
- Scenario 1: Default mode shows multi-phase progress
- Scenario 2: Quiet mode shows minimal output
- Scenario 3: Cache savings displayed during embedding
- Scenario 4: ETA updates based on throughput
- Scenario 5: Throughput calculation handles small repositories
- Scenario 6: Progress bar updates smoothly without flicker
- Scenario 7: Progress error handling (stderr redirected)

## Implementation Checklist

### Create Feature File

- [ ] Create `tests/e2e/features/tui_progress.feature`
- [ ] Add feature header with description
- [ ] Write Scenario 1: Default mode shows multi-phase progress
  - Given I have a repository with 100 files
  - When I run "gitctx index"
  - Then I should see "â†’ Walking commit graph" with progress bar
  - And I should see "â†’ Generating embeddings" with cost breakdown and progress bar
  - And I should see "â†’ Saving index" with progress bar
  - And I should see "âœ“ Indexing Complete" followed by statistics table
- [ ] Write Scenario 2: Quiet mode shows minimal output
  - Given I have a repository with 100 files
  - When I run "gitctx index --quiet"
  - Then I should see only final summary: "Indexed N commits (M blobs, X cached) in Ys"
  - And I should NOT see progress bars or phase markers
- [ ] Write Scenario 3: Cache savings displayed during embedding
  - Given I have previously indexed a repository
  - When I run "gitctx index" again with 50% cached blobs
  - Then embedding phase should show "Total Costs: $X (N blobs) | Saved using repo cache: $Y (M blobs)"
  - And saved cost should equal sum of cached embedding costs
- [ ] Write Scenario 4: ETA updates based on throughput
  - Given I am indexing a large repository
  - When embedding phase starts
  - Then ETA should update every second based on current throughput
  - And throughput should be calculated from last 100 blobs processed
- [ ] Write Scenario 5: Throughput calculation handles small repositories
  - Given I have a repository with 50 files
  - When I run "gitctx index"
  - Then embedding phase should calculate throughput over min(100, 50) blobs
  - And throughput should show "blobs/sec" metric
  - And progress bar should complete without division-by-zero errors
- [ ] Write Scenario 6: Progress bar updates smoothly without flicker
  - Given I have a repository with 50 files
  - When I run "gitctx index"
  - Then I should see progress bars for walking, embedding, and saving phases
  - And each progress bar should overwrite the previous line (no scrolling)
  - And the final statistics should display after completion
- [ ] Write Scenario 7: Progress error handling (stderr redirected)
  - Given I have a repository with 100 files
  - When I run "gitctx index 2>/tmp/output.txt" (stderr redirected)
  - Then indexing should complete successfully
  - And output file should contain phase markers without ANSI codes
  - And no progress bars should be written

### Create Step Definition Stubs

- [ ] Create `tests/e2e/steps/tui_progress_steps.py`
- [ ] Stub step: "Given I have a repository with {n:d} files"
- [ ] Stub step: "Given I have previously indexed a repository"
- [ ] Stub step: "Given I am indexing a large repository"
- [ ] Stub step: "When I run {command}"
- [ ] Stub step: "When I run {command} again with {percent:d}% cached blobs"
- [ ] Stub step: "When embedding phase starts"
- [ ] Stub step: "Then I should see {text} with progress bar"
- [ ] Stub step: "Then I should see {text} with cost breakdown and progress bar"
- [ ] Stub step: "Then I should see only final summary: {pattern}"
- [ ] Stub step: "Then I should NOT see progress bars or phase markers"
- [ ] Stub step: "Then embedding phase should show {pattern}"
- [ ] Stub step: "Then embedding phase should calculate throughput over min(100, {n:d}) blobs"
- [ ] Stub step: "Then throughput should show {metric} metric"
- [ ] Stub step: "Then progress bar should complete without division-by-zero errors"
- [ ] Stub step: "Then I should see progress bars for walking, embedding, and saving phases"
- [ ] Stub step: "Then each progress bar should overwrite the previous line (no scrolling)"
- [ ] Stub step: "Then the final statistics should display after completion"
- [ ] Stub step: "Then indexing should complete successfully"
- [ ] Stub step: "Then output file should contain phase markers without ANSI codes"
- [ ] Stub step: "Then no progress bars should be written"
- [ ] Stub step: "Then ETA should update every second based on current throughput"
- [ ] Stub step: "Then throughput should be calculated from last 100 blobs processed"
- [ ] Stub step: "And saved cost should equal sum of cached embedding costs"
- [ ] All step definitions raise `NotImplementedError` with descriptive message

### Verification

- [ ] Run `uv run pytest tests/e2e/features/tui_progress.feature -v`
- [ ] All 7 scenarios fail with `NotImplementedError` (expected)
- [ ] No syntax errors in feature file (Gherkin parser accepts it)
- [ ] No import errors in step definitions file
- [ ] Feature file line count ~150 lines
- [ ] Step definitions file line count ~120 lines

## Files to Create

- CREATE: `tests/e2e/features/tui_progress.feature` (~150 lines, 7 scenarios)
- CREATE: `tests/e2e/steps/tui_progress_steps.py` (~120 lines, stubbed steps)

## Pattern Reuse

- `e2e_git_repo_factory` (from `tests/conftest.py`) - for creating test repositories with commits
  - Usage: `repo = e2e_git_repo_factory(commits=100, files={'test.py': 'content'})`

## Notes

- **This task does NOT implement any functionality** - it only defines behavior
- All scenarios should fail with `NotImplementedError` after this task
- Scenarios 4 and 6 include timing assertions that may require manual verification later
- Scenario 7 tests stderr redirection (non-TTY terminal behavior)

## Success Criteria

- âœ… Feature file created with all 7 scenarios in valid Gherkin syntax
- âœ… Step definitions file created with all steps stubbed (raise NotImplementedError)
- âœ… All 7 scenarios fail when run (expected - no implementation yet)
- âœ… No syntax or import errors
- âœ… Ready for incremental implementation in subsequent tasks
