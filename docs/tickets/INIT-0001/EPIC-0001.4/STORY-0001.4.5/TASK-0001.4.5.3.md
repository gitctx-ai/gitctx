# TASK-0001.4.5.3: Refactor ProgressReporter with Rich.Progress

**Parent Story**: [STORY-0001.4.5](README.md)
**Status**: ðŸ”µ Not Started
**Estimated Hours**: 10
**Actual Hours**: -

## Objective

Refactor the existing ProgressReporter class to use Rich.Progress bars with ETA calculation, throughput display, cache cost tracking, and terminal detection. Rename verbose/terse modes to default/quiet.

## BDD Progress

**Before this task**: 1/7 scenarios passing (foundation only)
**After this task**: 5/7 scenarios passing (core functionality working)

**Scenarios for this task:**
- Scenario 1: Default mode shows multi-phase progress (FULL)
- Scenario 2: Quiet mode shows minimal output (FULL)
- Scenario 3: Cache savings displayed during embedding (FULL)
- Scenario 5: Throughput calculation handles small repositories (FULL)
- Scenario 7: Progress error handling - stderr redirected (FULL)

**Manual verification required:**
- Scenario 4: ETA updates based on throughput (watch ETA update during test run)
- Scenario 6: Progress bar updates smoothly without flicker (visual inspection during test run)

## Implementation Checklist

### Unit Tests First (TDD - RED)

- [ ] Create `tests/unit/indexing/test_progress.py`
- [ ] Write test: `test_progress_reporter_quiet_mode`
  - Create reporter with `quiet=True`
  - Call `phase()`, `update()`, `finish()`
  - Assert no stderr output (silent mode)
- [ ] Write test: `test_progress_reporter_default_mode`
  - Create reporter with `quiet=False`
  - Assert stderr contains progress indicators
- [ ] Write test: `test_indexing_stats_cached_fields`
  - Assert `cached_blobs` field exists and initializes to 0
  - Assert `cached_cost_usd` field exists and initializes to 0.0
- [ ] Write test: `test_phase_with_rich_progress`
  - Call `phase("Walking commit graph", total=1000)`
  - Assert creates Rich.Progress context manager
  - Assert progress bar displayed
- [ ] Write test: `test_update_calculates_eta`
  - Simulate processing 100 items
  - Assert ETA calculated from remaining work / throughput
  - Assert ETA shows "calculating..." for <10 items
- [ ] Write test: `test_update_calculates_throughput`
  - Simulate processing with time.sleep
  - Assert throughput displayed as "N items/sec"
- [ ] Write test: `test_terminal_detection`
  - Mock `Console.is_terminal = False`
  - Assert progress bars disabled
  - Assert phase markers still displayed
- [ ] Write test: `test_embedding_phase_cost_display`
  - Simulate embedding phase with cache hits
  - Assert displays "Total Costs: $X (N blobs) | Saved using repo cache: $Y (M blobs)"
- [ ] Write test: `test_finish_default_summary`
  - Call `finish()` in default mode
  - Assert output includes "Unique blobs: N (M cached)"
  - Assert uses `SYMBOLS['success']` for completion marker
- [ ] Write test: `test_finish_quiet_summary`
  - Call `finish()` in quiet mode
  - Assert output format: "Indexed N commits (M blobs, X cached) in Ys"
- [ ] Write test: `test_symbols_usage`
  - Assert `SYMBOLS['arrow']` used for phase markers
  - Assert `SYMBOLS['success']` used for completion
- [ ] Write test: `test_progress_exception_handling`
  - Mock Rich.Progress to raise exception
  - Assert reporter logs warning and continues
  - Assert indexing doesn't crash
- [ ] Write test: `test_dumb_terminal_fallback`
  - Mock `Console.is_dumb_terminal = True`
  - Assert falls back to simple text (no ANSI codes)
- [ ] Write test: `test_legacy_windows_handling`
  - Mock `Console.legacy_windows = True`
  - Assert uses ASCII symbols from SYMBOLS dict
- [ ] Write test: `test_model_spec_pricing_usage`
  - Assert reporter fetches `cents_per_million_tokens` from ModelSpec
  - Assert displays pricing in embedding phase header
- [ ] Run tests: `uv run pytest tests/unit/indexing/test_progress.py -v`
- [ ] All tests fail âœ“ (15+ tests)

### Implementation (GREEN)

- [ ] MODIFY: `src/gitctx/indexing/progress.py`
- [ ] Update IndexingStats dataclass:
  ```python
  @dataclass
  class IndexingStats:
      total_commits: int = 0
      total_blobs: int = 0
      total_chunks: int = 0
      total_tokens: int = 0
      total_cost_usd: float = 0.0
      cached_blobs: int = 0  # NEW
      cached_cost_usd: float = 0.0  # NEW (savings)
      errors: int = 0
      start_time: float = 0.0
  ```
- [ ] Update ProgressReporter.__init__:
  ```python
  def __init__(self, quiet: bool = False, model_name: str = "text-embedding-3-large"):
      self.quiet = quiet
      self.model_name = model_name
      self.model_spec = get_model_spec(model_name)
      self.stats = IndexingStats()
      self.current_phase: str = ""
      self.progress_ctx: Progress | None = None
  ```
- [ ] Refactor phase() method:
  ```python
  def phase(self, name: str, total: int | None = None) -> None:
      self.current_phase = name

      if self.quiet:
          return  # No output in quiet mode

      # Create Console with terminal detection
      console = Console(stderr=True)

      if not console.is_terminal:
          # Non-TTY: Show phase markers only, no progress bars
          print(f"{SYMBOLS['arrow']} {name}", file=sys.stderr)
          return

      if console.is_dumb_terminal:
          # Dumb terminal: Simple text, no ANSI codes
          print(f"{SYMBOLS['arrow']} {name}", file=sys.stderr)
          return

      # Phase marker with special formatting for embedding
      if name == "Generating embeddings":
          price = self.model_spec["cents_per_million_tokens"] / 100
          print(
              f"{SYMBOLS['arrow']} {name} using OpenAI {self.model_name} "
              f"(${price:.2f}/M tokens)",
              file=sys.stderr
          )
      else:
          print(f"{SYMBOLS['arrow']} {name}", file=sys.stderr)

      # Create Rich.Progress context (wrapped in try/except)
      try:
          if total is not None:
              self.progress_ctx = Progress(
                  TextColumn("[progress.description]{task.description}"),
                  BarColumn(),
                  TextColumn("{task.completed}/{task.total} ({task.percentage:.0f}%)"),
                  TextColumn("ETA {task.fields[eta]}"),
                  TextColumn("{task.fields[throughput]}"),
                  console=Console(stderr=True)
              )
              self.task_id = self.progress_ctx.add_task(
                  name,
                  total=total,
                  eta="calculating...",
                  throughput=""
              )
              self.progress_ctx.start()
      except Exception as e:
          logger.warning(f"Progress display failed: {e}, continuing without progress bars")
          self.progress_ctx = None
  ```
- [ ] Refactor update() method:
  ```python
  def update(
      self,
      commits: int = 0,
      blobs: int = 0,
      chunks: int = 0,
      tokens: int = 0,
      cost: float = 0.0,
      cached_blobs: int = 0,
      cached_cost: float = 0.0,
  ) -> None:
      # Update stats
      if commits:
          self.stats.total_commits = commits
      if blobs:
          self.stats.total_blobs = blobs
      if chunks:
          self.stats.total_chunks += chunks
      if tokens:
          self.stats.total_tokens += tokens
      if cost:
          self.stats.total_cost_usd += cost
      if cached_blobs:
          self.stats.cached_blobs = cached_blobs
      if cached_cost:
          self.stats.cached_cost_usd = cached_cost

      # Update progress bar (if active)
      if self.progress_ctx and not self.quiet:
          try:
              elapsed = time.time() - self.stats.start_time
              completed = self.stats.total_blobs
              throughput = completed / elapsed if elapsed > 0 else 0

              # Show "calculating..." until sufficient samples
              if completed < 10:
                  eta_display = "calculating..."
              else:
                  remaining = self.progress_ctx.tasks[self.task_id].total - completed
                  eta_seconds = remaining / throughput if throughput > 0 else 0
                  eta_display = str(timedelta(seconds=int(eta_seconds)))

              self.progress_ctx.update(
                  self.task_id,
                  completed=completed,
                  eta=eta_display,
                  throughput=f"{throughput:.0f} items/sec"
              )
          except Exception as e:
              logger.warning(f"Progress update failed: {e}")

      # Show cost breakdown for embedding phase (default mode only)
      if self.current_phase == "Generating embeddings" and not self.quiet:
          fresh_blobs = self.stats.total_blobs - self.stats.cached_blobs
          print(
              f"  Total Costs: ${self.stats.total_cost_usd:.5f} ({fresh_blobs} blobs) | "
              f"Saved using repo cache: ${self.stats.cached_cost_usd:.5f} "
              f"({self.stats.cached_blobs} blobs)",
              file=sys.stderr
          )
  ```
- [ ] Refactor finish() method:
  ```python
  def finish(self) -> None:
      if self.progress_ctx:
          try:
              self.progress_ctx.stop()
          except Exception as e:
              logger.warning(f"Progress stop failed: {e}")

      elapsed = time.time() - self.stats.start_time

      if self.quiet:
          self._print_quiet_summary(elapsed)
      else:
          self._print_default_summary(elapsed)
  ```
- [ ] Implement _print_default_summary():
  ```python
  def _print_default_summary(self, elapsed: float) -> None:
      print(f"{SYMBOLS['success']} Indexing Complete\n", file=sys.stderr)

      print("Statistics:", file=sys.stderr)
      print(f"  Commits:      {format_number(self.stats.total_commits)}", file=sys.stderr)
      print(
          f"  Unique blobs: {format_number(self.stats.total_blobs)} "
          f"({self.stats.cached_blobs} cached)",
          file=sys.stderr
      )
      print(f"  Chunks:       {format_number(self.stats.total_chunks)}", file=sys.stderr)
      print(f"  Tokens:       {format_number(self.stats.total_tokens)}", file=sys.stderr)
      print(f"  Cost:         {format_cost(self.stats.total_cost_usd)}", file=sys.stderr)
      print(f"  Time:         {format_duration(elapsed)}", file=sys.stderr)
  ```
- [ ] Implement _print_quiet_summary():
  ```python
  def _print_quiet_summary(self, elapsed: float) -> None:
      print(
          f"Indexed {format_number(self.stats.total_commits)} commits "
          f"({format_number(self.stats.total_blobs)} unique blobs, "
          f"{self.stats.cached_blobs} cached) in {format_duration(elapsed)}"
      )
      print(
          f"Tokens: {format_number(self.stats.total_tokens)} | "
          f"Cost: {format_cost(self.stats.total_cost_usd)}"
      )
  ```
- [ ] Run tests: `uv run pytest tests/unit/indexing/test_progress.py -v`
- [ ] All tests pass âœ“

### BDD Implementation (Actionable Scenarios)

- [ ] MODIFY: `tests/e2e/steps/tui_progress_steps.py`
- [ ] Implement Scenario 1 steps (default mode):
  - "When I run gitctx index" â†’ Execute command, capture stderr
  - "Then I should see {text} with progress bar" â†’ Assert text in stderr
  - Verify "â†’ Walking commit graph", "â†’ Generating embeddings", "â†’ Saving index", "âœ“ Indexing Complete", "Statistics:" all present
- [ ] Implement Scenario 2 steps (quiet mode):
  - "When I run gitctx index --quiet" â†’ Execute with flag
  - "Then I should see only final summary" â†’ Assert format matches
  - "Then I should NOT see progress bars or phase markers" â†’ Assert no "â†’" or progress characters
- [ ] Implement Scenario 3 steps (cache savings):
  - "Given I have previously indexed a repository" â†’ Index once, then again
  - "Then embedding phase should show {pattern}" â†’ Assert cost display present
- [ ] Implement Scenario 5 steps (small repos):
  - "Then throughput should show blobs/sec metric" â†’ Assert metric in output
  - "Then progress bar should complete without division-by-zero errors" â†’ Assert no exceptions
- [ ] Implement Scenario 7 steps (error handling):
  - "When I run gitctx index 2>/tmp/output.txt" â†’ Redirect stderr
  - "Then output file should contain phase markers without ANSI codes" â†’ Parse file, verify no escape sequences
- [ ] Run BDD: `uv run pytest tests/e2e/features/tui_progress.feature -v`
- [ ] Scenarios 1, 2, 3, 5, 7 pass âœ“ (5/7 automated)
- [ ] Scenarios 4, 6 verified manually during test run âœ“ (2/7 manual)

### Verification

- [ ] All unit tests pass (15+ tests)
- [ ] BDD scenarios 1-3, 5, 7 pass (automated)
- [ ] Scenarios 4, 6 verified manually (ETA updates visible, no flicker)
- [ ] Code coverage >90%: `uv run pytest --cov=src/gitctx/indexing/progress`
- [ ] mypy passes: `uv run mypy src/gitctx/indexing/progress.py`
- [ ] ruff passes: `uv run ruff check src/gitctx/indexing/progress.py`
- [ ] Manual E2E test: Run `gitctx index` on real repo, verify progress display
- [ ] Manual E2E test: Run `gitctx index --quiet` on real repo, verify minimal output

## Files to Create/Modify

- MODIFY: `src/gitctx/indexing/progress.py` (~200 lines changed, major refactor)
- CREATE: `tests/unit/indexing/test_progress.py` (~250 lines, 15+ tests)
- MODIFY: `tests/e2e/steps/tui_progress_steps.py` (~150 lines, implement 5 scenarios)

## Pattern Reuse

- Extend existing ProgressReporter class (don't create new class)
- Rich Library patterns from `src/gitctx/cli/search.py`:
  - `Progress` context manager with custom columns
  - `Console(stderr=True)` for error output
- Symbol usage from `src/gitctx/cli/symbols.py`:
  - `SYMBOLS['arrow']` for phase markers (â†’)
  - `SYMBOLS['success']` for completion (âœ“)
- Formatting utilities from `src/gitctx/indexing/formatting.py`:
  - `format_cost()` for currency display
  - `format_duration()` for time display
  - `format_number()` for comma-separated numbers

## Notes

- **Refactor, don't rewrite**: Extend existing ProgressReporter, preserve existing API
- **Terminal detection**: Use Rich Console's built-in detection (handles platform differences)
- **Error resilience**: Wrap Rich.Progress operations in try/except to prevent crashes
- **Manual verification**: Scenarios 4 and 6 require visual inspection during implementation
  - Scenario 4: Watch ETA update every ~1 second during test run
  - Scenario 6: Verify no scrolling/flicker during progress display

## Success Criteria

- âœ… ProgressReporter uses Rich.Progress for all phases
- âœ… ETA calculation with rolling average (shows "calculating..." until 10+ items)
- âœ… Throughput display (items/sec)
- âœ… Cache cost tracking (shows fresh + saved costs)
- âœ… Terminal detection (Console.is_terminal, Console.is_dumb_terminal)
- âœ… Quiet mode (renamed from terse, no progress output)
- âœ… Default mode (renamed from verbose, full progress display)
- âœ… All unit tests pass (15+ tests)
- âœ… BDD scenarios 1-3, 5, 7 pass (5/7 automated)
- âœ… Scenarios 4, 6 verified manually (2/7)
- âœ… Code coverage >90%
