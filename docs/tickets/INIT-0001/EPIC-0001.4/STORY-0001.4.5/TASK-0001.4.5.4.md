# TASK-0001.4.5.4: Update CLI Flags and Pipeline Integration

**Parent Story**: [STORY-0001.4.5](README.md)
**Status**: ðŸ”µ Not Started
**Estimated Hours**: 4
**Actual Hours**: -

## Objective

Complete the TUI progress feature by updating CLI flags (remove --verbose, add --quiet), modifying pipeline to track cache metrics, updating embed_with_cache to return cache costs, and implementing final BDD scenarios.

## BDD Progress

**Before this task**: 5/7 scenarios passing (core functionality)
**After this task**: 7/7 scenarios passing âœ… (all scenarios complete)

**Scenarios for this task:**
- Scenario 4: ETA updates based on throughput (COMPLETE - verify "blobs processed" metric)
- All remaining step definitions completed

## Implementation Checklist

### Integration Tests First (TDD - RED)

- [ ] MODIFY: `tests/unit/cli/test_index.py`
- [ ] Write test: `test_index_command_accepts_quiet_flag`
  - Call `index_command(quiet=True, ...)`
  - Assert ProgressReporter created with `quiet=True`
- [ ] Write test: `test_index_command_verbose_flag_removed`
  - Assert `--verbose` parameter doesn't exist
  - Verify backward compatibility not needed (pre-1.0)
- [ ] CREATE: `tests/unit/indexing/test_embeddings.py` (if doesn't exist)
- [ ] Write test: `test_embed_with_cache_returns_cached_cost`
  - Mock cache hit with embeddings that have cost_usd
  - Assert returns tuple: `(embeddings, True, cached_cost)`
  - Assert cached_cost = sum of embedding costs
- [ ] Write test: `test_embed_with_cache_cache_miss_returns_zero_cost`
  - Mock cache miss
  - Assert returns tuple: `(embeddings, False, 0.0)`
- [ ] MODIFY: `tests/unit/indexing/test_pipeline.py`
- [ ] Write test: `test_pipeline_tracks_cached_blobs`
  - Mock 50% cache hit rate
  - Assert cached_count increments correctly
- [ ] Write test: `test_pipeline_tracks_cached_costs`
  - Mock embeddings with various costs
  - Assert cached_cost accumulates correctly
- [ ] Write test: `test_reporter_receives_cache_metrics`
  - Mock ProgressReporter.update
  - Assert called with `cached_blobs` and `cached_cost` parameters
- [ ] Write test: `test_pipeline_separates_fresh_and_cached_costs`
  - Mock mixed cache hits/misses
  - Assert fresh_cost and cached_cost tracked separately
- [ ] Run tests: `uv run pytest tests/unit/cli/test_index.py tests/unit/indexing/test_embeddings.py tests/unit/indexing/test_pipeline.py -v`
- [ ] All tests fail âœ“ (8+ new tests)

### CLI Changes (GREEN)

- [ ] MODIFY: `src/gitctx/cli/index.py`
- [ ] Remove parameter:
  ```python
  # DELETE THIS LINE:
  # verbose: bool = typer.Option(False, "--verbose", "-v", help="Verbose output")
  ```
- [ ] Add parameter:
  ```python
  quiet: bool = typer.Option(False, "--quiet", "-q", help="Minimal output")
  ```
- [ ] Update ProgressReporter instantiation:
  ```python
  reporter = ProgressReporter(
      quiet=quiet,
      model_name=settings.repo.model.embedding
  )
  ```
- [ ] Run CLI tests: `uv run pytest tests/unit/cli/test_index.py -v`
- [ ] CLI tests pass âœ“

### Pipeline Changes - embed_with_cache (GREEN)

- [ ] MODIFY: `src/gitctx/indexing/embeddings.py`
- [ ] Update function signature:
  ```python
  async def embed_with_cache(
      chunker: ChunkerProtocol,
      embedder: EmbedderProtocol,
      cache: EmbeddingCache,
      blob_record: BlobRecord,
  ) -> tuple[list[Embedding], bool, float]:
      """Generate embeddings with cache tracking.

      Returns:
          Tuple of (embeddings, was_cached, cached_cost)
          - embeddings: List of Embedding objects
          - was_cached: True if retrieved from cache
          - cached_cost: Cost saved by using cache (0.0 if not cached)
      """
  ```
- [ ] Update cache hit logic:
  ```python
  cached = cache.get(blob_record.sha)
  if cached is not None:
      # Calculate what we would have paid (savings)
      cached_cost = sum(emb.cost_usd for emb in cached)
      logger.info(f"Cache hit for blob {blob_record.sha[:8]} (saved ${cached_cost:.6f})")
      return (cached, True, cached_cost)
  ```
- [ ] Update cache miss logic:
  ```python
  # Cache miss - generate embeddings
  embeddings = await embedder.embed(chunks)  # ... existing logic ...
  cache.set(blob_record.sha, embeddings)

  return (embeddings, False, 0.0)
  ```
- [ ] Run embedding tests: `uv run pytest tests/unit/indexing/test_embeddings.py -v`
- [ ] Embedding tests pass âœ“

### Pipeline Changes - index_repository (GREEN)

- [ ] MODIFY: `src/gitctx/indexing/pipeline.py`
- [ ] Add cache tracking variables at start of main loop:
  ```python
  async def index_repository(...):
      # ... existing initialization ...

      fresh_cost = 0.0
      cached_cost = 0.0
      cached_count = 0

      for blob_record in blobs:
          # ... existing blob processing ...
  ```
- [ ] Update embed_with_cache call and tracking:
  ```python
  embeddings, was_cached, saved_cost = await embed_with_cache(
      chunker=chunker,
      embedder=embedder,
      cache=cache,
      blob_record=blob_record
  )

  if was_cached:
      cached_count += 1
      cached_cost += saved_cost
  else:
      fresh_cost += sum(emb.cost_usd for emb in embeddings)

  reporter.update(
      blobs=total_blobs,
      cached_blobs=cached_count,
      cost=fresh_cost,
      cached_cost=cached_cost
  )
  ```
- [ ] Run pipeline tests: `uv run pytest tests/unit/indexing/test_pipeline.py -v`
- [ ] Pipeline tests pass âœ“

### BDD Implementation (Final Scenarios)

- [ ] MODIFY: `tests/e2e/steps/tui_progress_steps.py`
- [ ] Implement Scenario 4 remaining steps:
  - "Then ETA should update every second based on current throughput"
    - Note: Timing verified manually during test run
    - Automated: Verify "blobs/sec" or "items/sec" appears in output
  - "Then throughput should be calculated from last 100 blobs processed"
    - Note: Algorithm verified via unit tests
    - Automated: Verify throughput metric present
- [ ] Complete any remaining step definitions
- [ ] Run ALL BDD scenarios: `uv run pytest tests/e2e/features/tui_progress.feature -v`
- [ ] All 7 scenarios pass âœ…
  - 5 fully automated (exact output matching)
  - 2 with manual timing verification (Scenarios 4, 6)

### Verification

- [ ] All unit tests pass: `uv run pytest tests/unit/ -v`
- [ ] All integration tests pass
- [ ] All BDD scenarios pass: `uv run pytest tests/e2e/features/tui_progress.feature -v`
- [ ] Full test suite passes: `uv run pytest`
- [ ] mypy passes: `uv run mypy src`
- [ ] ruff check passes: `uv run ruff check src tests`
- [ ] ruff format passes: `uv run ruff format src tests --check`
- [ ] Code coverage >90%: `uv run pytest --cov=src/gitctx --cov-report=term-missing`
- [ ] Manual E2E verification:
  - [ ] Run `gitctx index` on real repo â†’ Verify default mode progress display
  - [ ] Run `gitctx index --quiet` on real repo â†’ Verify minimal output
  - [ ] Run `gitctx index` twice â†’ Verify cache savings displayed on second run
  - [ ] Watch ETA update during indexing â†’ Verify updates every ~1 second
  - [ ] Verify no scrolling/flicker during progress display

## Files to Create/Modify

- MODIFY: `src/gitctx/cli/index.py` (~5 lines changed, CLI flag update)
- MODIFY: `src/gitctx/indexing/embeddings.py` (~10 lines changed, return tuple with cost)
- MODIFY: `src/gitctx/indexing/pipeline.py` (~20 lines changed, track cache metrics)
- MODIFY: `tests/unit/cli/test_index.py` (~40 lines added, 2 tests)
- CREATE/MODIFY: `tests/unit/indexing/test_embeddings.py` (~40 lines added, 2 tests)
- MODIFY: `tests/unit/indexing/test_pipeline.py` (~60 lines added, 4 tests)
- MODIFY: `tests/e2e/steps/tui_progress_steps.py` (~30 lines, complete scenario 4 steps)

## Pattern Reuse

- Config factory for test settings
- Formatting utilities for output validation in BDD steps
- Mock fixtures for isolating components during unit testing

## Dependencies

- Requires TASK-0001.4.5.3 complete (ProgressReporter refactored with cache tracking)
- Requires TASK-0001.4.5.2 complete (ModelSpec has pricing information)

## Notes

- **Breaking change**: Removes `--verbose` flag (acceptable for pre-1.0 project)
- **Default behavior change**: Full progress display becomes the default (not opt-in)
- **Cache tracking**: Separates fresh costs (API calls) from cached costs (savings)
- **Manual verification**: Scenarios 4 and 6 timing requirements verified during manual testing

## Success Criteria

- âœ… CLI accepts `--quiet` flag (no `--verbose` flag)
- âœ… embed_with_cache returns `(embeddings, was_cached, cached_cost)` tuple
- âœ… Pipeline tracks cached_count, fresh_cost, cached_cost separately
- âœ… Pipeline passes cache metrics to ProgressReporter.update()
- âœ… All unit tests pass (8+ new tests)
- âœ… All BDD scenarios pass (7/7 âœ…)
- âœ… Full test suite passes with >90% coverage
- âœ… Manual E2E testing confirms all acceptance criteria met
- âœ… No regressions in existing functionality
