# TASK-0001.4.1.1: Write BDD Scenarios for Hybrid Search

**Parent Story**: [STORY-0001.4.1](README.md)
**Status**: ðŸ”µ Not Started
**Estimated Hours**: 2-3
**Actual Hours**: -

## Objective

Write ALL 3 BDD scenarios for hybrid search (keyword match, semantic match, combined ranking) with stubbed step definitions. All scenarios should fail with NotImplementedError (expected). This defines WHAT the system should do before HOW it does it.

## BDD Progress

**Before this task**: 0/3 scenarios exist
**After this task**: 0/3 scenarios passing (all stubbed, all failing ðŸ”´)

**Scenarios for this task:**
- Scenario 1: Hybrid search finds exact keyword matches
- Scenario 2: Hybrid search finds semantic matches
- Scenario 3: Hybrid search combines keyword and semantic ranking

## Implementation Checklist

### Phase 1: Create Feature File

- [ ] Create `tests/e2e/features/hybrid_search.feature`
- [ ] Write Scenario 1: "Hybrid search finds exact keyword matches"
  - [ ] Given repository with auth/middleware.py and auth/handlers.py
  - [ ] When search for "AuthMiddleware"
  - [ ] Then first result should be "src/auth/middleware.py"
  - [ ] And result should have BM25 score > 0.7 (keyword match)
- [ ] Write Scenario 2: "Hybrid search finds semantic matches"
  - [ ] Given repository with auth files
  - [ ] When search for "user authentication logic"
  - [ ] Then results include both middleware.py and handlers.py
  - [ ] And results should have vector scores > 0.7 (semantic match)
- [ ] Write Scenario 3: "Hybrid search combines keyword and semantic ranking"
  - [ ] Given repository with jwt.py, oauth.py, auth_guide.md
  - [ ] When search for "JWT auth middleware class"
  - [ ] Then jwt.py ranks first (keyword + semantic match)
  - [ ] And oauth.py ranks second (semantic match)
  - [ ] And auth_guide.md ranks lower (partial semantic match)

### Phase 2: Create Stubbed Step Definitions

- [ ] Create `tests/e2e/steps/hybrid_search_steps.py`
- [ ] Stub step: "Given a repository with files" (table parsing)
- [ ] Stub step: "When I search for {query}"
- [ ] Stub step: "Then the first result should be {file_path}"
- [ ] Stub step: "And the result should have BM25 score > 0.7"
- [ ] Stub step: "Then results should include both {file1} and {file2}"
- [ ] Stub step: "And results should have vector scores > 0.7"
- [ ] Stub step: "Then {file} should rank {position}"
- [ ] Stub step: "And {file} should rank {position}"
- [ ] All stubs raise NotImplementedError with message indicating which task implements

### Verification

- [ ] Run `uv run pytest tests/e2e/features/hybrid_search.feature -v`
- [ ] Verify all 3 scenarios fail with NotImplementedError
- [ ] Verify clear error messages showing which task implements each step
- [ ] Commit: `test(TASK-0001.4.1.1): Write BDD scenarios for hybrid search (0/3 stubbed)`

## Files to Create

- **CREATE**: `tests/e2e/features/hybrid_search.feature` (~80 lines, 3 Gherkin scenarios)
- **CREATE**: `tests/e2e/steps/hybrid_search_steps.py` (~120 lines, 8 stubbed steps)

## Pattern Reuse

- **e2e_indexed_repo_factory** (`tests/e2e/conftest.py:353`) - For creating custom indexed repos with specific file structure
- **e2e_cli_runner** (`tests/e2e/conftest.py`) - For running gitctx search commands
- **Existing search_steps.py** (`tests/e2e/steps/search_steps.py`) - Pattern for Given/When/Then step structure

## Example Stub

```python
@then('the result should have BM25 score > 0.7')
def check_bm25_score(context):
    """Verify BM25 score indicates strong keyword match (> 0.7 threshold).

    Implementation: TASK-0001.4.1.3 (after hybrid search implemented)
    """
    raise NotImplementedError(
        'BM25 score verification not implemented yet. '
        'Will be implemented in TASK-0001.4.1.3 when hybrid search is working.'
    )
```

## Dependencies

**None** - This is TASK-1 in incremental BDD pattern, defines all scenarios upfront.
