# TASK-0001.4.1.2: SearchStrategy Protocol and SearchResult Extension

**Parent Story**: [STORY-0001.4.1](README.md)
**Status**: ðŸ”µ Not Started
**Estimated Hours**: 3-4
**Actual Hours**: -

## Objective

Create SearchStrategy protocol for storage-agnostic search interface and create SearchResult dataclass (does not exist yet) with all required fields plus score breakdown (bm25_score, vector_score, hybrid_score). Implement basic BDD steps for repository setup and result verification.

## BDD Progress

**Before this task**: 0/3 scenarios passing
**After this task**: 1/3 scenarios passing (Scenario 1: keyword match basic check ðŸŸ¡)

**Scenarios for this task:**
- Scenario 1: Hybrid search finds exact keyword matches (partial implementation - basic result check only, not score verification)

## Implementation Checklist

### Phase 1: Unit Tests First (TDD - RED)

- [ ] Create `tests/unit/storage/test_protocols.py`
  - [ ] Test SearchStrategy protocol signature validation
  - [ ] Test protocol can be imported and used in type hints
  - [ ] Test protocol has correct method signature (search with 4 params)
- [ ] Create `tests/unit/indexing/test_search_result.py`
  - [ ] Test SearchResult creation with all required fields
  - [ ] Test SearchResult has bm25_score field (float | None)
  - [ ] Test SearchResult has vector_score field (float | None)
  - [ ] Test SearchResult has hybrid_score field (float | None)
  - [ ] Test SearchResult score fields default to None
  - [ ] Test SearchResult with all score fields populated
  - [ ] Test SearchResult uses primitive types only (FFI compatibility)
- [ ] Run tests - all fail âœ“

### Phase 2: Implementation (GREEN)

- [ ] Create `src/gitctx/storage/protocols.py`
  - [ ] Import Protocol from typing, SearchResult from types
  - [ ] Define SearchStrategy protocol
  - [ ] Add search() method signature with docstring
  - [ ] Add note about minimal design (no lifecycle methods)
- [ ] Modify `src/gitctx/indexing/types.py`
  - [ ] Create SearchResult dataclass following CodeChunk pattern
  - [ ] Add all core fields: chunk_content, file_path, distance, commit_sha, etc.
  - [ ] Add git metadata fields: author_name, commit_date, commit_message, is_head
  - [ ] Add score breakdown fields:
    - [ ] bm25_score: float | None = None (from _score)
    - [ ] vector_score: float | None = None (from 1.0 - _distance)
    - [ ] hybrid_score: float | None = None (from _relevance_score)
  - [ ] Write comprehensive docstring with field descriptions and examples
  - [ ] Use primitive types only (str, int, float, bool) for FFI compatibility
- [ ] Run unit tests - all pass âœ“
- [ ] Run mypy - no type errors âœ“

### Phase 3: Refactor (if needed)

- [ ] Review protocol definition for clarity
- [ ] Ensure consistent with ChunkerProtocol, EmbedderProtocol patterns
- [ ] Verify SearchResult maintains FFI compatibility (primitive types only)

### Phase 4: BDD Implementation (Partial - Basic Steps)

- [ ] Modify `tests/e2e/steps/hybrid_search_steps.py`
- [ ] Implement step: "Given a repository with files" (table parsing)
  - [ ] Parse table data from Gherkin scenario
  - [ ] Create test repository with specified files and content
  - [ ] Use e2e_indexed_repo_factory fixture
- [ ] Implement step: "When I search for {query}"
  - [ ] Execute gitctx search command with query
  - [ ] Store search results in context
- [ ] Implement step: "Then the first result should be {file_path}"
  - [ ] Parse search output
  - [ ] Verify first result matches expected file path
  - [ ] Basic check only (not score verification - deferred to TASK-3)
- [ ] Run Scenario 1 - should pass basic file match check âœ“
- [ ] Scenarios 2-3 still fail (expected - ranking/scores not implemented yet)

### Verification

- [ ] All unit tests pass (protocol + SearchResult extension)
- [ ] Mypy type checking passes
- [ ] Scenario 1 passes basic file matching (1/3 passing)
- [ ] Scenarios 2-3 still fail with NotImplementedError (expected)
- [ ] Code coverage >90% for new protocol and type extensions
- [ ] Commit: `feat(TASK-0001.4.1.2): SearchStrategy protocol + SearchResult scores (1/3 BDD passing)`

## Files to Create/Modify

- **CREATE**: `src/gitctx/storage/protocols.py` (~40 lines, SearchStrategy protocol)
- **CREATE**: `src/gitctx/indexing/types.py` - SearchResult dataclass (~60 lines with comprehensive docstring)
  - Note: SearchResult does not currently exist in codebase (lancedb_store.py returns list[dict])
  - Following CodeChunk pattern: @dataclass with primitive types, detailed docs, examples
- **CREATE**: `tests/unit/storage/test_protocols.py` (~60 lines, protocol validation tests)
- **CREATE**: `tests/unit/indexing/test_search_result.py` (~120 lines, SearchResult creation and field tests)
- **MODIFY**: `tests/e2e/steps/hybrid_search_steps.py` (~60 lines, implement 3 basic steps)

## Pattern Reuse

- **ChunkerProtocol** (`src/gitctx/indexing/protocols.py:8`) - Protocol pattern for storage-agnostic interfaces
  - Reuse protocol structure and docstring style
  - Maintains ability to add future implementations (Qdrant, Pinecone)
- **CodeChunk dataclass** (`src/gitctx/indexing/types.py:8`) - Dataclass pattern with primitive types
  - Reuse field definition pattern: `field_name: type | None = None`
  - Maintains FFI compatibility (no complex objects)
- **e2e_indexed_repo_factory** (`tests/e2e/conftest.py:353`) - Custom indexed repository creation
  - Usage: `repo = e2e_indexed_repo_factory(files={'auth.py': 'class AuthMiddleware', ...})`

## Technical Notes

**SearchStrategy Protocol Design:**
- Intentionally minimal (no initialize/close methods)
- LanceDBStore manages own connection lifecycle via __init__/table property
- Enables future storage backends without breaking changes

**SearchResult Score Fields (from LanceDB response):**
- All scores optional (float | None) for backward compatibility
- bm25_score: BM25 keyword matching score from `_score` field (float or None, higher = better)
- vector_score: Cosine similarity computed as `1.0 - _distance` (float, 0-1 range)
- hybrid_score: RRF combined score from `_relevance_score` field (float, 0-1 range)

## Dependencies

- **TASK-0001.4.1.1** (Write BDD Scenarios) - Must complete first (scenarios must exist before implementing steps)
