# TASK-0001.4.1.4: Integration Testing and Regression Verification

**Parent Story**: [STORY-0001.4.1](README.md)
**Status**: ðŸ”µ Not Started
**Estimated Hours**: 2-3
**Actual Hours**: -

## Objective

Run full integration testing to verify hybrid search works end-to-end with existing search pipeline. Ensure ALL existing search BDD scenarios still pass (no regressions). Verify performance is acceptable (hybrid â‰¤ 2x vector-only baseline).

## BDD Progress

**Before this task**: 3/3 hybrid search scenarios passing
**After this task**: 3/3 hybrid + all existing search scenarios passing âœ…

**Scenarios for this task:**
- All 3 hybrid search scenarios (maintain passing)
- All existing search scenarios from `tests/e2e/features/search.feature`

## Implementation Checklist

### Phase 1: Run Existing Search Scenarios

- [ ] Identify all existing search E2E tests
  - [ ] List scenarios in `tests/e2e/features/search.feature`
  - [ ] List scenarios in `tests/e2e/test_search_features.py`
  - [ ] Check for VCR cassettes (recorded HTTP responses)
- [ ] Run existing search scenarios with hybrid search enabled
  - [ ] `uv run pytest tests/e2e/ -k search -v`
  - [ ] Verify all scenarios still pass
  - [ ] Document any that fail (investigate before proceeding)
- [ ] Regression scenarios to verify:
  - [ ] Search with no results
  - [ ] Search with cached query embedding
  - [ ] Search with minimum similarity threshold (max_distance)
  - [ ] Search with filter_head_only=True
  - [ ] Search with various limit values (1, 10, 100)
  - [ ] Search with special characters in query
  - [ ] Search with empty query (if applicable)

### Phase 2: Performance Testing

- [ ] Benchmark vector-only search (baseline)
  - [ ] Index test repository (1000+ files)
  - [ ] Run 100 queries, measure p50/p95/p99 latency
  - [ ] Record baseline: `vector_baseline_p95 = X ms`
- [ ] Benchmark hybrid search
  - [ ] Same test repository (1000+ files)
  - [ ] Run same 100 queries, measure p50/p95/p99 latency
  - [ ] Record hybrid: `hybrid_p95 = Y ms`
- [ ] Verify performance acceptable
  - [ ] hybrid_p95 â‰¤ 2x vector_baseline_p95
  - [ ] If > 2x, investigate (LanceDB should optimize hybrid queries)
  - [ ] Document results in task completion notes

### Phase 3: CLI Output Verification (if applicable)

- [ ] Check if score breakdown shown in CLI output
  - [ ] Run `gitctx search "test query" --verbose` (if verbose flag shows scores)
  - [ ] Verify output format is clear and readable
  - [ ] If scores shown, verify BM25/vector/hybrid labels correct
- [ ] Check terse output (default mode)
  - [ ] Run `gitctx search "test query"`
  - [ ] Verify output unchanged (no breaking changes to user-facing format)
  - [ ] Scores optional, don't break existing workflows

### Phase 4: Full Test Suite

- [ ] Run complete BDD test suite
  - [ ] `uv run pytest tests/e2e/ -v`
  - [ ] Verify all scenarios pass (hybrid + existing)
- [ ] Run complete unit test suite
  - [ ] `uv run pytest tests/unit/ -v`
  - [ ] Verify no regressions in storage/indexing/search modules
- [ ] Run full quality gates
  - [ ] `uv run ruff check src tests`
  - [ ] `uv run ruff format src tests --check`
  - [ ] `uv run mypy src`
  - [ ] `uv run pytest --cov=src/gitctx --cov-report=term-missing`
  - [ ] Verify coverage >90% (should improve with new tests)

### Phase 5: Update Story Status

- [ ] Update STORY-0001.4.1/README.md
  - [ ] Mark all acceptance criteria as complete âœ…
  - [ ] Update "Progress": 100%
  - [ ] Update "Status": ðŸŸ¢ Complete
  - [ ] Add "BDD Progress: 3/3 scenarios passing"
- [ ] Verify all 4 tasks marked complete
- [ ] Commit: `test(TASK-0001.4.1.4): Integration tests + regression verification (story complete)`

### Verification

- [ ] All 3 hybrid search scenarios pass
- [ ] All existing search scenarios pass (no regressions)
- [ ] Performance: hybrid â‰¤ 2x vector-only baseline
- [ ] Full test suite passes (E2E + unit)
- [ ] Code coverage â‰¥90%
- [ ] All quality gates pass (ruff, mypy)
- [ ] Story marked ðŸŸ¢ Complete

## Files to Verify

- **VERIFY**: `tests/e2e/features/search.feature` (existing scenarios)
- **VERIFY**: `tests/e2e/features/hybrid_search.feature` (3 new scenarios)
- **VERIFY**: `tests/e2e/test_search_features.py` (all search tests)
- **VERIFY**: `tests/unit/storage/test_lancedb_store.py` (existing storage tests)
- **VERIFY**: `tests/unit/storage/test_lancedb_hybrid.py` (new hybrid tests)
- **MODIFY**: `docs/tickets/INIT-0001/EPIC-0001.4/STORY-0001.4.1/README.md` (mark complete)

## Performance Targets

**Expected Performance:**
- Hybrid search: â‰¤ 2x vector-only latency
- Reference: LanceDB hybrid search ~470 QPS on 130K documents (prrao87/lancedb-study)
- Target p95 latency: <500ms for 1000-file repository

**If performance issues detected:**
1. Profile with `pytest --profile` or cProfile
2. Check LanceDB index status (IVF-PQ index created?)
3. Verify query_type='hybrid' and rerank() calls correct
4. Consult LanceDB docs for hybrid search optimization

## Regression Test Scenarios

**Existing scenarios to verify:**

1. **Search with no results**
   - Query that matches nothing should return empty results
   - Hybrid search shouldn't break this

2. **Search with cached query embedding**
   - Query embedding cache should still work
   - No duplicate API calls to OpenAI

3. **Search with max_distance threshold**
   - Post-filtering should still work
   - Results respect distance threshold

4. **Search with filter_head_only**
   - Should only return HEAD chunks
   - Hybrid search preserves filtering

5. **Search with various limits**
   - limit=1 returns 1 result
   - limit=100 returns up to 100 results
   - Hybrid search respects limit parameter

## Completion Criteria

- [ ] All 3 hybrid search scenarios pass
- [ ] All existing search scenarios pass
- [ ] No performance degradation >2x
- [ ] Unit test coverage >90%
- [ ] Full quality gates pass
- [ ] Story marked âœ… Complete with all acceptance criteria verified

## Dependencies

- **TASK-0001.4.1.3** (Hybrid Search Implementation) - Must complete first (hybrid search must work before integration testing)
