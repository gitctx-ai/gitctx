# TASK-0001.4.4.2: Add zstandard Dependency and Compression Constants

**Parent Story**: [STORY-0001.4.4](README.md)
**Status**: ✅ Complete
**Estimated Hours**: 2
**Actual Hours**: 2

## Objective

Add zstandard dependency, add compression constants to EmbeddingCache class, and write comprehensive unit tests for compression utilities. This establishes the foundation for compression implementation.

## BDD Progress

**Before this task**: 0/2 scenarios passing
**After this task**: 0/2 scenarios passing (foundation only, no BDD implementation yet)

**Scenarios for this task:** Foundation work (no BDD steps implemented)

## Implementation Checklist

### Add Dependency (TDD - Setup)
- [ ] Run `uv add zstandard` to update pyproject.toml
- [ ] Verify zstandard>=0.22.0 added to dependencies
- [ ] Run `uv sync` to install

### Unit Tests First (TDD - RED)
- [ ] Create `tests/unit/storage/test_compression.py`
- [ ] Write test: compress and decompress safetensors bytes (roundtrip)
- [ ] Write test: compressed size is smaller than original
- [ ] Write test: decompression produces identical bytes
- [ ] Write test: compression level affects output size
- [ ] Write test: invalid compressed data raises error
- [ ] Write test: compression ratio achieves 8-10% reduction for typical embeddings
  - Assertion: `assert 0.90 <= (compressed_size / original_size) <= 0.92`
- [ ] Write test: compression handles empty tensors gracefully
- [ ] Write test: compression handles large tensors (1000+ vectors)
- [ ] Run tests - all fail ✓

### Implementation (GREEN)
- [ ] Import zstandard in `src/gitctx/storage/embedding_cache.py`
  - Add: `import zstandard as zstd`
- [ ] Update imports: use `save, load` from safetensors.numpy
  - Remove: Any references to `save_file, load_file` if present
  - Add: `from safetensors.numpy import save, load`
  - Verify: `grep -n "save_file\|load_file" src/gitctx/storage/embedding_cache.py` returns no results
- [ ] Add imports: `import json, struct` for metadata parsing
- [ ] Add class constant: `COMPRESSION_LEVEL = 3` to EmbeddingCache
  - Add docstring comment: "# Level 3: Balance of speed and ratio (zstd recommendation)"
- [ ] Do NOT create helper methods yet - tests use zstd compressor/decompressor directly
- [ ] Run tests - all pass ✓

### Verification
- [ ] All unit tests pass (8+ tests)
- [ ] Code coverage >90% for tests/unit/storage/test_compression.py
- [ ] mypy passes (proper type annotations)
- [ ] ruff check and format pass
- [ ] If any verification fails: revert changes, fix issue, re-run tests

## Files to Create/Modify

- MODIFY: `pyproject.toml` (add zstandard>=0.22.0 dependency)
- CREATE: `tests/unit/storage/test_compression.py` (~120 lines, 8+ tests)
- MODIFY: `src/gitctx/storage/embedding_cache.py` (add import, constant, helper methods)

## Pattern Reuse

- **Dependency management**: `uv add` pattern (existing)
- **Class constants**: Follow existing pattern in EmbeddingCache
- **Unit test structure**: Follow existing unit test patterns in tests/unit/storage/

## Performance Targets

- Compression: <10ms per file
- Decompression: <5ms per file
- Size reduction: 8-10% (90-92% of original)

## Notes

- zstandard is a pure C extension with binary wheels (no build complexity)
- Level 3 is zstd's recommended default (balance of speed and ratio)
- **Safetensors API for bytes**: Use `save()` / `load()` (not `save_file()` / `load_file()`)
  - `save()` returns bytes, `load()` accepts bytes
  - Metadata parsing: Manual header extraction (struct + json pattern)
  - This is the [official safetensors pattern](https://huggingface.co/docs/safetensors/metadata_parsing) for working with bytes
