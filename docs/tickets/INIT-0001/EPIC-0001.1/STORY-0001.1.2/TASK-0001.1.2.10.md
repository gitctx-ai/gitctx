# TASK-0001.1.2.10: Add Windows CI Integration Tests

**Parent Story**: [STORY-0001.1.2](README.md)
**Status**: âœ… Complete
**Estimated Hours**: 0.5
**Actual Hours**: 0.5
**Completion Commits**: 46a17b5, 570cd0c

## Objective

Add Windows-specific integration tests to verify config behavior on Windows, particularly around file permissions, path handling, and platform symbols.

## Context

Current tests skip Windows for permission checks. Need proper Windows integration tests to ensure cross-platform compatibility, especially for file permissions (ACLs) and path handling.

## Implementation Checklist

- [x] Add Windows-specific file permission tests (ACL-based)
- [x] Verify platform symbol selection on Windows cmd.exe vs PowerShell
- [x] Test Windows path handling (`%USERPROFILE%` expansion)
- [x] Test CRLF line ending handling in YAML files
- [x] Verify Unicode support on Windows
- [x] Remove `pytest.skip` for Windows permission tests where appropriate
- [x] Run quality gates: `uv run poe fix && uv run poe quality`

## Acceptance Criteria

- Windows file permission tests verify ACL behavior
- Platform symbols correctly selected on Windows
- Windows paths (`%USERPROFILE%`) handled correctly
- CRLF line endings don't break YAML parsing
- Unicode works on Windows
- Tests pass in GitHub Actions Windows runner
- All quality gates pass

## Files to Modify

- [tests/unit/core/test_user_config.py](../../../../../tests/unit/core/test_user_config.py) - Windows-specific tests
- [tests/e2e/features/cli.feature](../../../../../tests/e2e/features/cli.feature) - Windows scenarios if needed
- [tests/e2e/steps/cli_steps.py](../../../../../tests/e2e/steps/cli_steps.py) - Windows step definitions if needed

## Technical Notes

**Windows File Permissions**:

Windows uses ACLs (Access Control Lists), not Unix-style permissions. Need different approach:

```python
def test_user_config_windows_permissions():
    """User config has restrictive ACLs on Windows."""
    import sys
    if sys.platform != "win32":
        pytest.skip("Windows-only test")

    from gitctx.core.user_config import UserConfig
    config = UserConfig()
    config.save()

    # On Windows, verify file is accessible to owner
    config_path = Path.home() / ".gitctx" / "config.yml"
    assert config_path.exists()
    assert os.access(config_path, os.R_OK | os.W_OK)

    # Optionally check ACLs using pywin32 or similar
    # For now, just verify file is readable/writable by owner
```

**Platform Symbol Tests**:

```python
def test_windows_cmd_uses_ascii_symbols():
    """Windows cmd.exe uses ASCII symbols, not Unicode."""
    import sys
    if sys.platform != "win32":
        pytest.skip("Windows-only test")

    # Mock environment to simulate cmd.exe
    # Verify symbols are ASCII ([OK], [X], etc.)
```

**Path Handling**:

```python
def test_windows_userprofile_path():
    """Windows expands %USERPROFILE% correctly."""
    import sys
    if sys.platform != "win32":
        pytest.skip("Windows-only test")

    from gitctx.core.user_config import _get_user_home
    home = _get_user_home()
    assert home.exists()
    assert "Users" in str(home)  # Typical Windows path
```

**Line Ending Tests**:

```python
def test_crlf_line_endings_in_yaml():
    """YAML files with CRLF line endings parse correctly."""
    # Write config with CRLF line endings
    config_text = "search:\r\n  limit: 20\r\n"
    config_file.write_text(config_text)

    # Load config
    config = GitCtxSettings()
    assert config.get("search.limit") == 20
```

## Test Strategy

**Windows-Specific Coverage**:
1. File permissions (ACLs)
2. Path handling (%USERPROFILE%, backslashes)
3. Symbol selection (cmd.exe vs PowerShell)
4. Line endings (CRLF)
5. Unicode support

**Approach**:
- Use `sys.platform == "win32"` checks
- Run in GitHub Actions Windows runner
- Don't skip tests unnecessarily - verify actual behavior

## Definition of Done

- [x] Windows-specific tests added
- [x] Tests pass in GitHub Actions Windows runner
- [x] No unnecessary `pytest.skip` calls
- [x] All quality gates pass
- [x] Task marked complete in story README
