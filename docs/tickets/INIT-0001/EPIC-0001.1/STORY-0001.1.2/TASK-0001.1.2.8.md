# TASK-0001.1.2.8: Add Essential Edge Case Tests

**Parent Story**: [STORY-0001.1.2](README.md)
**Status**: ‚úÖ Complete
**Estimated Hours**: 0.25
**Actual Hours**: 0.25

## Objective

Add focused edge case tests for real-world scenarios: Unicode handling (international users), auto-directory creation (first-time users), and file corruption (editor crashes).

## Context

Current tests cover happy paths well. Need minimal edge case coverage for:
1. **Unicode** - Users worldwide have non-ASCII in API keys, model names
2. **First-time UX** - Missing `~/.gitctx/` directory should auto-create
3. **File corruption** - Editor crashes/disk full should show clear errors

**NOT testing**: Concurrent writes (CLI is single-process), DOS attacks (user controls files), YAML bombs (safe_load handles), deep nesting (Pydantic prevents).

## Implementation Checklist

- [x] Add Unicode tests (3 tests):
  - API key with Chinese characters: `api_keys.openai = "ÂØÜÈí•-sk-abc123"`
  - Model name with emoji: `model.embedding = "text-embedding-üåç-large"`
  - RTL text in API key: `api_keys.openai = "sk-ÿßŸÑÿπÿ±ÿ®Ÿäÿ©123"`
- [x] Add auto-create directory test (1 test):
  - `save()` creates `~/.gitctx/` if missing (with parents)
- [x] Add file corruption tests (2 tests):
  - Truncated YAML file ‚Üí ValidationError with clear message
  - Malformed YAML ‚Üí ValidationError with helpful message
- [x] Run quality gates: All passed (ruff check, ruff format, mypy, pytest - 192 tests, 94.59% coverage)

## Acceptance Criteria

- Unicode characters in config values handled correctly
- Missing parent directories created automatically
- Malformed YAML shows clear, actionable error messages
- All quality gates pass
- Coverage maintained ‚â• 85%

## Files to Modify

- [tests/unit/core/test_user_config.py](../../../../../tests/unit/core/test_user_config.py) - Unicode + auto-create tests
- [tests/unit/core/test_repo_config.py](../../../../../tests/unit/core/test_repo_config.py) - Corruption tests

## Technical Notes

**Unicode Tests** (test_user_config.py):

```python
class TestEdgeCasesUnicode:
    """Test Unicode handling - real scenario: international users."""

    def test_unicode_chinese_in_api_key(self, isolated_env):
        """API key can contain Chinese characters."""
        config_file = isolated_env / ".gitctx" / "config.yml"
        config_file.write_text("api_keys:\n  openai: ÂØÜÈí•-sk-abc123\n")

        config = UserConfig()
        assert config.api_keys.openai.get_secret_value() == "ÂØÜÈí•-sk-abc123"

    def test_unicode_emoji_in_model_name(self, tmp_path, monkeypatch):
        """Model name can contain emoji."""
        monkeypatch.chdir(tmp_path)
        config = RepoConfig()
        config.model.embedding = "text-embedding-üåç-large"
        config.save()

        config2 = RepoConfig()
        assert config2.model.embedding == "text-embedding-üåç-large"

    def test_unicode_rtl_in_api_key(self, isolated_env):
        """API key can contain RTL (Arabic) text."""
        config_file = isolated_env / ".gitctx" / "config.yml"
        config_file.write_text("api_keys:\n  openai: sk-ÿßŸÑÿπÿ±ÿ®Ÿäÿ©123\n")

        config = UserConfig()
        assert config.api_keys.openai.get_secret_value() == "sk-ÿßŸÑÿπÿ±ÿ®Ÿäÿ©123"
```

**Auto-Create Directory Test** (test_user_config.py):

```python
class TestFilesystemEdgeCases:
    """Test filesystem edge cases - real scenario: first-time user."""

    def test_save_creates_missing_parent_directories(self, tmp_path, monkeypatch):
        """save() creates ~/.gitctx/ if missing."""
        new_home = tmp_path / "nonexistent" / "user" / "home"
        monkeypatch.setenv("HOME", str(new_home))

        config = UserConfig()
        config.api_keys.openai = SecretStr("sk-test123")
        config.save()

        config_file = new_home / ".gitctx" / "config.yml"
        assert config_file.exists()
```

**File Corruption Tests** (test_repo_config.py):

```python
class TestFileCorruption:
    """Test file corruption - real scenario: editor crash, disk full."""

    def test_truncated_yaml_shows_clear_error(self, tmp_path, monkeypatch):
        """Truncated YAML shows clear error message."""
        monkeypatch.chdir(tmp_path)
        config_file = tmp_path / ".gitctx" / "config.yml"
        config_file.parent.mkdir()
        config_file.write_text("search:\n  lim")  # Truncated mid-value

        with pytest.raises(Exception) as exc:
            RepoConfig()
        assert "parse" in str(exc.value).lower() or "yaml" in str(exc.value).lower()

    def test_malformed_yaml_shows_clear_error(self, tmp_path, monkeypatch):
        """Malformed YAML shows helpful error message."""
        monkeypatch.chdir(tmp_path)
        config_file = tmp_path / ".gitctx" / "config.yml"
        config_file.parent.mkdir()
        config_file.write_text("search:\n- wrong_type")  # List instead of dict

        with pytest.raises(Exception):
            RepoConfig()
```

## Test Strategy

**Focus**: Real-world edge cases only

1. **Unicode** - International users (Chinese, Arabic, emoji)
2. **First-time UX** - Auto-create directories
3. **File corruption** - Editor crashes, disk full

**Explicitly NOT testing**:
- Concurrent writes (CLI is single-process)
- DOS attacks (user controls files, pointless)
- YAML bombs (PyYAML safe_load handles)
- Deep nesting (Pydantic schema prevents)
- Invalid UTF-8 (extremely rare, truncated test similar)

## Definition of Done

- [ ] 6 focused edge case tests added
- [ ] All tests passing
- [ ] Coverage maintained ‚â• 85%
- [ ] All quality gates pass
- [ ] Task marked complete in story README
