# TASK-0001.1.2.4: Security Hardening - Permission Checks

**Parent Story**: [STORY-0001.1.2](README.md)
**Status**: ✅ Complete
**Estimated Hours**: 0.5
**Actual Hours**: 0.5
**Completion Commit**: fec762e (fix: Address PR review - security, docs, UX)

## Objective

Add runtime permission checks for user config file to warn users if their `~/.gitctx/config.yml` has insecure permissions (> 0600), protecting API keys from unauthorized access.

## Context

PR #4 review feedback identified that while we set 0600 permissions on save, we don't check permissions on load. Users could accidentally chmod the file later, exposing their API keys.

## Implementation Checklist

- [ ] Add permission check in `UserConfig.settings_customise_sources()`
- [ ] Check if `~/.gitctx/config.yml` exists and has permissions > 0600
- [ ] Display warning using Rich console: `[yellow]⚠️ User config has insecure permissions (current: 0XXX, should be 0600)[/yellow]`
- [ ] Add unit test in `tests/unit/core/test_user_config.py` for permission check
- [ ] Add BDD scenario in `tests/e2e/features/cli.feature`: "User config with insecure permissions shows warning"
- [ ] Run quality gates: `uv run poe fix && uv run poe quality`
- [ ] Manual testing: Create config with 0644, verify warning displays

## Acceptance Criteria

- User config with permissions > 0600 triggers warning on any config read operation
- Warning shows current permissions and recommended permissions (0600)
- Warning is non-blocking (doesn't prevent reading config)
- Unit test verifies permission check logic
- BDD scenario verifies end-to-end warning display
- All quality gates pass

## Files to Modify

- [src/gitctx/core/user_config.py](../../../../../src/gitctx/core/user_config.py) - Add check in `settings_customise_sources()`
- [tests/unit/core/test_user_config.py](../../../../../tests/unit/core/test_user_config.py) - Add permission test
- [tests/e2e/features/cli.feature](../../../../../tests/e2e/features/cli.feature) - Add BDD scenario

## Technical Notes

```python
# In settings_customise_sources(), before returning sources:
yaml_file = _get_user_home() / ".gitctx" / "config.yml"
if yaml_file.exists():
    stat = yaml_file.stat()
    # On Unix: st_mode & 0o777 gives permission bits
    # Check if group or others have any permissions
    if stat.st_mode & 0o077:  # Group (o70) or others (o07) have access
        from rich.console import Console
        console = Console()
        current_perms = oct(stat.st_mode)[-3:]
        console.print(f"[yellow]⚠️ User config has insecure permissions (current: {current_perms}, should be 0600)[/yellow]")
```

## Test Strategy

**Unit Test** (`test_user_config_permission_check`):
- Create temp config with 0644 permissions
- Mock Path.home() to point to temp location
- Capture console output
- Assert warning is displayed with correct permission values

**BDD Scenario**:
```gherkin
Scenario: User config with insecure permissions shows warning
  Given user config exists with permissions 0644
  When I run "gitctx config get api_keys.openai"
  Then the output should contain "⚠️ User config has insecure permissions"
  And the output should contain "current: 644, should be 0600"
```

## Definition of Done

- [ ] Code implemented and passes ruff/mypy
- [ ] Unit test added and passing
- [ ] BDD scenario added and passing
- [ ] Manual testing completed
- [ ] All quality gates pass
- [ ] Task marked complete in story README
