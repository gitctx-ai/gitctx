# TASK-0001.1.2.3: Integrate with CLI Commands and Add Config Init

**Parent Story**: [STORY-0001.1.2](README.md)
**Status**: âœ… Complete
**Estimated Hours**: 2.5 (was 0.5, +2.0 for TUI compliance: progressive disclosure, symbols, tips, exit codes)
**Actual Hours**: 2.5
**Completion Commit**: `312d2aa` - feat(TASK-0001.1.2.3): Integrate config with CLI and add TUI compliance

## Description

**GREEN Phase** - Connect the UserConfig and RepoConfig to CLI commands, add config init command, and implement smart routing.

This task updates `src/gitctx/cli/config.py` to use `GitCtxSettings` router, add `config init` command, and enable source indicators. All existing CLI behavior is preserved - no breaking changes.

## Implementation Checklist

### TUI Compliance Setup (MUST DO FIRST)

- [x] **Create shared tips module** (`src/gitctx/cli/tips.py`):
  - [x] Implement `is_first_run(command: str) -> bool` - checks `~/.gitctx/.{command}_run` marker
  - [x] Implement `show_tip(command: str)` - displays tip box with proper platform box style
  - [x] Define `TIPS` dict with config command tip about secure API key storage
  - [x] Import SYMBOLS from `gitctx.cli.symbols` (reuse existing module)
  - [x] Import Panel, ROUNDED, ASCII from rich for tip boxes
  - [x] **Note**: This module will be reused by other commands (index, search, clear)

- [x] **Import existing symbols and tips** in `src/gitctx/cli/config.py`:
  - [x] Import `SYMBOLS` from `gitctx.cli.symbols` (already exists - DO NOT reinvent)
  - [x] Import `is_first_run`, `show_tip` from `gitctx.cli.tips` (create new shared module)

- [x] **CRITICAL: Copy CLI patterns from existing commands** (DO NOT reinvent):
  - [x] **Verbose/Quiet flags**: Copy EXACT definitions from `src/gitctx/cli/index.py:20-31`
  - [x] **Output mode branching**: Copy EXACT pattern from `src/gitctx/cli/index.py:67-110` (if quiet return, if verbose details, else terse)
  - [x] **Console setup**: Copy from `index.py:10-11` (module-level `console` and `console_err`)
  - [x] **Error formatting**: Copy from `index.py:61` (`console_err.print(f"[red]{SYMBOLS['error']}[/red] Error: {msg}")`)
  - [x] **Exit codes**: Use `raise typer.Exit(code=N)` like `index.py:62`, `search.py:67`
  - [x] **Symbol usage**: See `index.py:61, 76-93`, `search.py:65` for examples
  - [x] **Reuse masking function**: Keep existing `_mask_sensitive_value()` from config.py:48-57

### Add Config Init Command

- [x] Add `config init` subcommand with **TUI-compliant output**:
  - [x] Add `-v/--verbose` and `-q/--quiet` flags
  - [x] Calls `init_repo_config()` from core
  - [x] **Default mode (terse)**: Single line `"Initialized .gitctx/"`
  - [x] **Verbose mode**: Multi-line with "Created..." and "Next steps:"
  - [x] **Quiet mode**: No output on success
  - [x] Show first-run tip after success (default/verbose only)
  - [x] Error handling if directory already exists

### Replace In-Memory Storage

- [x] Update `src/gitctx/cli/config.py`:
  - [x] Import `GitCtxSettings` from `gitctx.core.config`
  - [x] Replace `_config_store` dict with `GitCtxSettings()` instance
  - [x] Remove old dict-based helper functions
  - [x] Keep all command signatures unchanged (maintain interface contract)

### Update Config Set Command

- [x] Modify `config_set()` with **TUI-compliant output**:
  - [x] Add `-v/--verbose` and `-q/--quiet` flags
  - [x] Use `GitCtxSettings.set()` for routing
  - [x] Catch validation errors and show helpful messages
  - [x] Catch FileNotFoundError for repo config, suggest `config init`
  - [x] **Default mode**: `"set {key}"` (lowercase, terse)
  - [x] **Quiet mode**: No output on success
  - [x] Exit code 6 for permission denied errors

### Update Config Get Command

- [x] Modify `config_get()` with **TUI-compliant progressive disclosure**:
  - [x] Add `-v/--verbose` and `-q/--quiet` flags
  - [x] Use `GitCtxSettings.get()` for routing
  - [x] Get source indicator from `settings.get_source(key)`
  - [x] Mask SecretStr values (automatic via Pydantic)
  - [x] **Quiet mode**: Just the masked value `"sk-...123"`
  - [x] **Default mode (terse)**: Just the masked value `"sk-...123"` (same as quiet, git-like)
  - [x] **Verbose mode**: `"{key} = {value} {source}"`
  - [x] Handle None values: `"{key} is not set"`, exit code 1

### Update Config List Command

- [x] Modify `config_list()` with **TUI-compliant source hiding**:
  - [x] Add `-v/--verbose` and `-q/--quiet` flags
  - [x] Iterate over user config (api_keys)
  - [x] Iterate over repo config (search, index, model)
  - [x] Get source for each key
  - [x] Mask SecretStr values
  - [x] **Quiet mode**: Just `"{key}={value}"` (no sources)
  - [x] **Default mode**: `"{key}={value} {source}"` for non-defaults only (hide "(default)")
  - [x] **Verbose mode**: `"{key}={value} {source}"` for ALL values (show defaults)
  - [x] Sort keys alphabetically

### Add Validation Error Handling

- [x] Catch `pydantic.ValidationError`:
  - [x] Show field name and error message with âœ— symbol
  - [x] Exit with code 2 (usage error per TUI_GUIDE.md)
  - [x] Format: `"[red]{SYMBOLS['error']}[/red] Error: {field}: {error}"`

- [x] Catch `PermissionError`:
  - [x] Show clear error message with âœ— symbol
  - [x] Exit with code 6 (permission denied per TUI_GUIDE.md)
  - [x] Format: `"[red]{SYMBOLS['error']}[/red] Permission denied: {path}"`

## Code Implementation

### NEW: Create `src/gitctx/cli/tips.py`

**CRITICAL**: This is a NEW shared module for first-run tips that will be reused by all commands.

```python
"""First-run tips system for gitctx CLI.

Provides helpful tips to users on their first run of each command,
then automatically hides them on subsequent runs.

See TUI_GUIDE.md for tip formatting specifications.
"""

from pathlib import Path
from rich.console import Console
from rich.panel import Panel
from rich.box import ROUNDED, ASCII

from gitctx.cli.symbols import SYMBOLS  # Reuse existing symbols module

# Create console for platform detection
_console = Console()

# Tips dictionary - add new tips here as needed
TIPS = {
    "config": "API keys are stored securely in ~/.gitctx/config.yml with file permissions 0600. Team settings in .gitctx/config.yml are safe to commit.",
    # Future tips for other commands:
    # "index": "Embeddings are stored in .gitctx/db/ and should be committed to share with your team.",
    # "search": "Use --limit to control result count. Results are ranked by semantic similarity.",
}


def is_first_run(command: str) -> bool:
    """Detect if this is user's first time running a command.

    Creates a marker file at ~/.gitctx/.{command}_run to track first runs.
    Returns True only on the very first invocation of the command.

    Args:
        command: The command name (e.g., "config", "index", "search")

    Returns:
        True if this is the first run, False otherwise

    Example:
        >>> if is_first_run("config"):
        ...     show_tip("config")
    """
    marker_file = Path.home() / ".gitctx" / f".{command}_run"
    if not marker_file.exists():
        marker_file.parent.mkdir(parents=True, exist_ok=True)
        marker_file.touch()
        return True
    return False


def show_tip(command: str) -> None:
    """Display a tip box for the specified command.

    Uses platform-appropriate box style (ASCII for Windows cmd.exe,
    Unicode for modern terminals).

    Args:
        command: The command name to show a tip for

    Example:
        >>> show_tip("config")
        ðŸ’¡ Tip
        â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
        â”‚ API keys are stored securely in ...    â”‚
        â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
    """
    tip = TIPS.get(command)
    if not tip:
        return

    # Use ASCII box for legacy Windows cmd.exe, Unicode for modern terminals
    box_style = ASCII if _console.legacy_windows else ROUNDED
    tip_icon = SYMBOLS["tip"]

    panel = Panel(
        tip,
        title=f"{tip_icon} Tip",
        title_align="left",
        box=box_style,
        border_style="blue",
        expand=False,
    )

    _console.print()
    _console.print(panel)
    _console.print()
```

### Update `src/gitctx/cli/config.py`

```python
"""Config command for gitctx CLI."""

import sys
from pydantic import ValidationError
import typer
from rich.console import Console

from gitctx.core.config import GitCtxSettings
from gitctx.cli.symbols import SYMBOLS  # Reuse existing symbols module
from gitctx.cli.tips import is_first_run, show_tip  # Reuse tips system

console = Console()

# Create a sub-app for config commands
config_app = typer.Typer(help="Manage gitctx configuration")


def register(app: typer.Typer) -> None:
    """Register the config command group with the CLI app."""
    app.add_typer(config_app, name="config")


def _set_nested_value(settings: GitCtxSettings, key: str, value: str) -> None:
    """Set a nested configuration value using dot notation.

    Args:
        settings: GitCtxSettings instance
        key: Dot-notation key (e.g., "api_keys.openai")
        value: Value to set

    Raises:
        ValidationError: If value fails Pydantic validation
        AttributeError: If key path is invalid
    """
    parts = key.split(".")
    current = settings

    # Navigate to parent
    for part in parts[:-1]:
        current = getattr(current, part)

    # Set the final field
    setattr(current, parts[-1], value)


def _get_nested_value(settings: GitCtxSettings, key: str) -> str | None:
    """Get a nested configuration value using dot notation.

    Args:
        settings: GitCtxSettings instance
        key: Dot-notation key (e.g., "api_keys.openai")

    Returns:
        Value as string, or None if not set
    """
    parts = key.split(".")
    current = settings

    try:
        for part in parts:
            current = getattr(current, part)

        # Handle SecretStr
        if hasattr(current, "get_secret_value"):
            return current.get_secret_value()

        # Handle None
        if current is None:
            return None

        return str(current)
    except AttributeError:
        return None


def _mask_value(key: str, value: str) -> str:
    """Mask sensitive values for display.

    Args:
        key: Configuration key
        value: Value to potentially mask

    Returns:
        Masked value if sensitive, otherwise original value
    """
    # Check if this is an API key field
    if "key" in key.lower() and len(value) > 6:
        return f"{value[:3]}...{value[-3:]}"
    return value


@config_app.command("init")
def config_init(
    verbose: bool = typer.Option(False, "-v", "--verbose", help="Show detailed output"),
    quiet: bool = typer.Option(False, "-q", "--quiet", help="Suppress all output except errors"),
) -> None:
    """
    Initialize repo-level configuration.

    Creates:
      - .gitctx/config.yml (team settings)
      - .gitctx/.gitignore (protects db/ and logs/)

    Run this once per repository before setting repo-level config.
    """
    try:
        from gitctx.core.config import init_repo_config
        init_repo_config()

        if not quiet:
            # Default: terse single-line (TUI_GUIDE.md compliance)
            console.print("Initialized .gitctx/")

            if verbose:
                # Verbose: detailed output with next steps
                console.print("  Created .gitctx/config.yml")
                console.print("  Created .gitctx/.gitignore")
                console.print("\nNext steps:")
                console.print("  1. Set your API key: gitctx config set api_keys.openai sk-...")
                console.print("  2. Index your repo: gitctx index")
                console.print("  3. Commit to share: git add .gitctx/ && git commit -m 'chore: Add gitctx embeddings'")

            # First-run tip (only once)
            if is_first_run("config"):
                show_tip("config")

    except FileExistsError:
        if not quiet:
            console.print(f"[yellow]{SYMBOLS['warning']}[/yellow] .gitctx/ already initialized")
    except PermissionError as e:
        console.print(f"[red]{SYMBOLS['error']}[/red] Permission denied: {e}", file=sys.stderr)
        raise typer.Exit(6)
    except Exception as e:
        console.print(f"[red]{SYMBOLS['error']}[/red] Error: {e}", file=sys.stderr)
        raise typer.Exit(1)


@config_app.command("set")
def config_set(
    key: str = typer.Argument(..., help="Configuration key (supports dot notation)"),
    value: str = typer.Argument(..., help="Configuration value"),
    verbose: bool = typer.Option(False, "-v", "--verbose", help="Show detailed output"),
    quiet: bool = typer.Option(False, "-q", "--quiet", help="Suppress all output except errors"),
) -> None:
    """
    Set a configuration value.

    Examples:

        $ gitctx config set api_keys.openai sk-abc123
        $ gitctx config set search.limit 20
    """
    try:
        # Load settings, update value, save
        settings = GitCtxSettings()
        _set_nested_value(settings, key, value)
        settings.save()

        if not quiet:
            # Default: terse lowercase confirmation (TUI_GUIDE.md compliance)
            console.print(f"set {key}")

    except ValidationError as e:
        # Show validation errors with symbol (exit code 2 per TUI_GUIDE.md)
        for error in e.errors():
            field = ".".join(str(loc) for loc in error["loc"])
            console.print(f"[red]{SYMBOLS['error']}[/red] Error: {field}: {error['msg']}", file=sys.stderr)
        raise typer.Exit(2)
    except PermissionError as e:
        console.print(f"[red]{SYMBOLS['error']}[/red] Permission denied: {e}", file=sys.stderr)
        raise typer.Exit(6)
    except AttributeError:
        console.print(f"[red]{SYMBOLS['error']}[/red] Error: Unknown configuration key: {key}", file=sys.stderr)
        raise typer.Exit(2)
    except Exception as e:
        console.print(f"[red]{SYMBOLS['error']}[/red] Error: {e}", file=sys.stderr)
        raise typer.Exit(1)


@config_app.command("get")
def config_get(
    key: str = typer.Argument(..., help="Configuration key to retrieve"),
    verbose: bool = typer.Option(False, "-v", "--verbose", help="Show key name and source"),
    quiet: bool = typer.Option(False, "-q", "--quiet", help="Output value only, no formatting"),
) -> None:
    """
    Get a configuration value.

    Environment variables take precedence over config file values.

    Examples:

        $ gitctx config get api_keys.openai
        sk-...123

        $ gitctx config get api_keys.openai --verbose
        api_keys.openai = sk-...123 (from user config)
    """
    try:
        settings = GitCtxSettings()
        value = _get_nested_value(settings, key)

        if value is None:
            console.print(f"{key} is not set")
            raise typer.Exit(1)

        # Mask sensitive values
        masked = _mask_value(key, value)

        if quiet:
            # Quiet: just the value (for scripting)
            console.print(masked)
        elif verbose:
            # Verbose: key = value (source)
            source = settings.get_source(key)
            console.print(f"{key} = {masked} {source}")
        else:
            # Default: just the value (terse, git-like per TUI_GUIDE.md)
            console.print(masked)

    except AttributeError:
        console.print(f"[red]{SYMBOLS['error']}[/red] Error: Unknown configuration key: {key}", file=sys.stderr)
        raise typer.Exit(2)


@config_app.command("list")
def config_list(
    verbose: bool = typer.Option(False, "-v", "--verbose", help="Show sources for all values including defaults"),
    quiet: bool = typer.Option(False, "-q", "--quiet", help="Suppress formatting, show key=value only"),
) -> None:
    """
    List all configuration settings.

    Shows current configuration with sensitive values masked.

    Examples:

        $ gitctx config list
        api_keys.openai=sk-...123 (from user config)
        search.limit=10

        $ gitctx config list --verbose
        api_keys.openai=sk-...123 (from user config)
        search.limit=10 (default)
        model.embedding=text-embedding-3-large (default)
    """
    settings = GitCtxSettings()

    # Flatten nested models to dot notation
    items = []

    # api_keys.*
    if settings.api_keys.openai is not None:
        value = settings.api_keys.openai.get_secret_value()
        masked = _mask_value("api_keys.openai", value)
        source = settings.get_source("api_keys.openai")
        items.append(("api_keys.openai", masked, source))

    # search.*
    for field in ["limit", "rerank"]:
        value = getattr(settings.search, field)
        source = settings.get_source(f"search.{field}")
        items.append((f"search.{field}", str(value), source))

    # index.*
    for field in ["chunk_size", "chunk_overlap"]:
        value = getattr(settings.index, field)
        source = settings.get_source(f"index.{field}")
        items.append((f"index.{field}", str(value), source))

    # model.*
    for field in ["embedding"]:
        value = getattr(settings.model, field)
        source = settings.get_source(f"model.{field}")
        items.append((f"model.{field}", str(value), source))

    # Sort and print
    if not items:
        console.print("No configuration set")
        return

    for key, value, source in sorted(items):
        if quiet:
            # Quiet: just key=value
            console.print(f"{key}={value}")
        elif verbose:
            # Verbose: show ALL sources (including defaults)
            console.print(f"{key}={value} {source}")
        else:
            # Default: only show source if non-default (TUI_GUIDE.md compliance)
            if source and "(default)" not in source.lower():
                console.print(f"{key}={value} {source}")
            else:
                console.print(f"{key}={value}")
```

## Testing Requirements

**CRITICAL**: Use existing CLI fixtures for testing:

### Fixture Usage for CLI Tests

**For unit tests** - Use `cli_runner` fixture:

```python
def test_config_set_validates_types(cli_runner, temp_home, monkeypatch):
    """Test that config set validates type correctness.

    Uses cli_runner for in-process CLI testing (faster than subprocess).
    Uses temp_home for isolated file system.
    """
    from gitctx.cli.main import app

    # Setup isolated home
    monkeypatch.setattr("pathlib.Path.home", lambda: temp_home)

    # Try to set invalid value
    result = cli_runner.invoke(app, ["config", "set", "search.limit", "invalid"])

    # Should fail with validation error
    assert result.exit_code == 1
    assert "validation error" in result.output.lower()

def test_config_get_shows_source(cli_runner, temp_home, monkeypatch):
    """Test that config get shows source indicator.

    Uses cli_runner and temp_home fixtures.
    """
    from gitctx.cli.main import app

    # Setup
    monkeypatch.setattr("pathlib.Path.home", lambda: temp_home)
    monkeypatch.setenv("OPENAI_API_KEY", "sk-test123")

    # Get config value
    result = cli_runner.invoke(app, ["config", "get", "api_keys.openai"])

    # Should show value and source
    assert result.exit_code == 0
    assert "sk-...123" in result.output
    assert "(from OPENAI_API_KEY)" in result.output
```

**For E2E tests** - Use `e2e_cli_runner` fixture:

```python
def test_config_persistence_across_invocations(e2e_cli_runner, e2e_git_isolation_env):
    """Test that config persists across separate CLI invocations.

    Uses e2e_cli_runner for true subprocess isolation.
    e2e_git_isolation_env provides isolated HOME with .gitctx/ directory.
    """
    from gitctx.cli.main import app

    # Set config in first invocation
    result1 = e2e_cli_runner.invoke(app, ["config", "set", "search.limit", "25"])
    assert result1.exit_code == 0

    # Get config in second invocation (separate process)
    result2 = e2e_cli_runner.invoke(app, ["config", "get", "search.limit"])
    assert result2.exit_code == 0
    assert "25" in result2.output
```

### Fixture Selection Guide

**Use `cli_runner`** (from `tests/conftest.py`) when:
- Testing CLI command logic in-process
- Need fast test execution
- Don't need true subprocess isolation
- Testing validation, output formatting

**Use `e2e_cli_runner`** (from `tests/e2e/conftest.py`) when:
- Testing true persistence across invocations
- Need complete subprocess isolation
- Testing environment variable handling
- Testing file system operations

### After Implementation:

- [x] Run CLI unit tests: `uv run pytest tests/unit/cli/test_config.py -v`
  - âœ… All 28 unit tests passing
  - âœ… Tests for validation, source indicators all passing
- [x] Run BDD tests: `uv run pytest tests/e2e/ -k config -v`
  - âœ… All 19 config scenarios passing
- [x] Manual testing completed:
  ```bash
  # Set and get - âœ… Working
  # Environment variable precedence - âœ… Working
  # Validation - âœ… Working
  # List - âœ… Working
  ```

## Output Format Changes

**config get** - Adds source indicator (new):
```bash
# Before (STORY-0001.1.1):
$ gitctx config get api_keys.openai
sk-...123

# After (this task):
$ gitctx config get api_keys.openai
api_keys.openai = sk-...123 (from config file)
```

**config list** - Adds source indicators for API keys (new):
```bash
# Before:
api_keys.openai=sk-...123
search.limit=10

# After:
api_keys.openai=sk-...123 (from OPENAI_API_KEY)
search.limit=10
```

**config set** - Unchanged:
```bash
Set api_keys.openai
```

## Acceptance Criteria

- [x] `config set` saves to YAML file
- [x] `config get` shows value with source indicator
- [x] `config list` shows all settings with sources
- [x] Validation errors caught and displayed helpfully
- [x] SecretStr values automatically masked
- [x] No breaking changes to CLI interface
- [x] All BDD scenarios pass (19/19 passing)
- [x] All unit tests pass (28/28 passing)
- [x] Coverage maintained at â‰¥ 85% (actual: 95.32%)

## Interface Compatibility (with STORY-0001.1.1)

**Preserved behaviors** - All 78 tests from STORY-0001.1.1 must pass:
- âœ… `config set` output format unchanged
- âœ… `config get` shows masked values
- âœ… `config list` shows all settings
- âœ… Dot notation works
- âœ… Environment variables override config

**Enhanced behaviors** (additions, not breaking changes):
- âž• Persistent storage (survives restarts)
- âž• Source indicators in output
- âž• Type validation with helpful errors
- âž• Provider env var (`OPENAI_API_KEY`) support

## Testing Commands

```bash
# Run unit tests
uv run pytest tests/unit/cli/test_config.py -v

# Run BDD tests
uv run pytest tests/e2e/ -k config -v

# Run all tests
uv run pytest -v

# Manual testing
uv run gitctx config set api_keys.openai sk-test123
uv run gitctx config get api_keys.openai
uv run gitctx config list

# Test precedence
export OPENAI_API_KEY=sk-provider789
export GITCTX_API_KEYS__OPENAI=sk-gitctx456
uv run gitctx config get api_keys.openai  # Should show api_keys.openai = sk-...789 (from OPENAI_API_KEY)

# Test validation
uv run gitctx config set search.limit invalid  # Should error
```

## Available Fixtures

From `tests/conftest.py`:
- **`temp_home`** - Isolated HOME with `.gitctx/` already created
- **`git_isolation_base`** - Security isolation env vars
- **`cli_runner`** - In-process CLI runner (fast, good for unit tests)

From `tests/e2e/conftest.py`:
- **`e2e_git_isolation_env`** - Complete subprocess environment
- **`e2e_cli_runner`** - Subprocess CLI runner (true isolation)
- **`e2e_env_factory`** - Custom environment factory
- **`e2e_git_repo`** - Real git repository

From `tests/e2e/steps/cli_steps.py`:
- **`context`** - Stores test data between steps (already exists!)

## Notes

- **GREEN phase**: Connect Config to CLI, tests should pass
- Maintain CLI interface contract (all existing tests must pass)
- Source indicators are additive enhancements (not breaking)
- Validation errors improve UX (not a breaking change)
- File persistence is transparent to users
- **Use existing fixtures**: 8 comprehensive fixtures available, no new ones needed
- **`cli_runner` vs `e2e_cli_runner`**: Use cli_runner for fast unit tests, e2e_cli_runner for true subprocess isolation
- **`temp_home` bonus**: Already has `.gitctx/` directory created!

## Dependencies

- [x] TASK-0001.1.2.2 complete (Config class implemented)
- [x] All tests from TASK-0001.1.2.1 passing
- [x] `src/gitctx/core/config.py` exists and tested

---

**Created**: 2025-10-04
**Last Updated**: 2025-10-05
**Completed**: 2025-10-05
