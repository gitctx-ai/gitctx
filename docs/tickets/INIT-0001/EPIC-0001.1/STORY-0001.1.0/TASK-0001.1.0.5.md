# TASK-0001.1.0.5: CI/CD Pipeline Setup

**Parent Story**: [STORY-0001.1.0](../stories/STORY-0001.1.0.md)  
**Status**: âœ… Complete  
**Estimated Hours**: 3  
**Actual Hours**: 1

## Description

Set up GitHub Actions CI/CD pipeline to run all quality checks and tests on every push and pull request. The pipeline should test across multiple Python versions and operating systems to ensure compatibility.

## Implementation Checklist

- [x] Create `.github/workflows/` directory structure
- [x] Configure main CI workflow (`ci.yml`)
- [x] Set up test matrix (Python 3.11, 3.12, 3.13 on Linux, macOS, Windows)
- [x] Configure dependency caching for faster builds
- [x] Add code coverage reporting to Codecov/Coveralls
- [x] Add status badges to README with specific markdown
- [x] Test pipeline triggers on push

## TDD Requirements

### Test First (RED)

Not applicable. Configuration only.

### Implementation (GREEN)

```yaml
# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  pull_request:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:  # Allow manual trigger

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION_DEFAULT: "3.13"
  UV_CACHE_DIR: /tmp/.uv-cache

jobs:
  # Quick checks that should fail fast
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION_DEFAULT }}
      
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      
      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.UV_CACHE_DIR }}
          key: uv-${{ runner.os }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            uv-${{ runner.os }}-
      
      - name: Install dependencies
        run: |
          uv sync --all-extras
      
      - name: Run ruff check
        run: |
          uv run ruff check src tests
      
      - name: Run ruff format check
        run: |
          uv run ruff format --check src tests

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION_DEFAULT }}
      
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      
      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.UV_CACHE_DIR }}
          key: uv-${{ runner.os }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            uv-${{ runner.os }}-
      
      - name: Install dependencies
        run: |
          uv sync --all-extras
      
      - name: Run mypy
        run: |
          uv run mypy src

  test:
    name: Test Python ${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.11", "3.12", "3.13"]
        exclude:
          # Reduce matrix size for faster CI
          - os: windows-latest
            python-version: "3.11"
          - os: windows-latest
            python-version: "3.12"
          - os: macos-latest
            python-version: "3.12"
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install uv (Unix)
        if: runner.os != 'Windows'
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      
      - name: Install uv (Windows)
        if: runner.os == 'Windows'
        run: |
          irm https://astral.sh/uv/install.ps1 | iex
          echo "$env:USERPROFILE\.cargo\bin" >> $env:GITHUB_PATH
      
      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.UV_CACHE_DIR }}
          key: uv-${{ runner.os }}-py${{ matrix.python-version }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            uv-${{ runner.os }}-py${{ matrix.python-version }}-
      
      - name: Install dependencies
        run: |
          uv sync --all-extras
      
      - name: Run tests with coverage
        run: |
          uv run pytest --cov=src/gitctx --cov-report=xml --cov-report=term
      
      - name: Upload coverage to Codecov
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.13'
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./coverage.xml
          fail_ci_if_error: false
          verbose: true

  # Final check that all required checks passed
  all-checks:
    name: All Checks Passed
    if: always()
    needs: [lint, type-check, test]
    runs-on: ubuntu-latest
    steps:
      - name: Verify all checks passed
        uses: re-actors/alls-green@release/v1
        with:
          jobs: ${{ toJSON(needs) }}
```

### Additional Workflow: PR Checks

```yaml
# .github/workflows/pr-checks.yml
name: PR Checks

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  check-title:
    name: Check PR Title
    runs-on: ubuntu-latest
    steps:
      - name: Check PR title format
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert

  check-files:
    name: Check File Size
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check for large files
        run: |
          # Find files larger than 1MB
          large_files=$(find . -type f -size +1M | grep -v "^./.git")
          if [ -n "$large_files" ]; then
            echo "Error: Large files detected (>1MB):"
            echo "$large_files"
            exit 1
          fi
```

### Refactor

- Optimize matrix strategy based on actual needs
- Add more sophisticated caching
- Consider adding security scanning

## Acceptance Criteria

- [x] GitHub Actions workflows directory exists
- [x] CI workflow triggers on push and PR
- [x] Tests run on multiple Python versions (3.11, 3.12, 3.13)
- [x] Tests run on multiple OS (Linux, macOS, Windows)
- [x] Dependencies are cached for faster builds
- [x] Coverage reports are generated
- [x] All quality gates run (lint, format, type check, tests)
- [x] Workflow passes on clean code

## Dependencies

- GitHub repository
- All previous tasks completed (project structure, tests, etc.)
- Codecov account (optional, for coverage reporting)

## Testing Commands

```bash
# Validate workflow syntax locally (requires act)
act -l

# Run workflow locally (requires act and Docker)
act push

# Test workflow triggers
git add .
git commit -m "test: CI pipeline"
git push

# Check workflow status
gh run list
gh run watch

# View workflow logs
gh run view --log
```

## Status Badges for README

Add these exact badges to the top of README.md, right after the `# gitctx` title:

```markdown
# gitctx

[![CI](https://github.com/gitctx-ai/gitctx/actions/workflows/ci.yml/badge.svg)](https://github.com/gitctx-ai/gitctx/actions/workflows/ci.yml)
[![codecov](https://codecov.io/gh/gitctx-ai/gitctx/branch/main/graph/badge.svg)](https://codecov.io/gh/gitctx-ai/gitctx)
[![Python 3.11+](https://img.shields.io/badge/python-3.11%2B-blue.svg)](https://www.python.org/downloads/)
[![uv](https://img.shields.io/badge/uv-latest-green.svg)](https://github.com/astral-sh/uv)
[![Ruff](https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/astral-sh/ruff/main/assets/badge/v2.json)](https://github.com/astral-sh/ruff)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

git native context enhancement for agentic coding.
```

## Notes

- Keep CI fast (<5 minutes total) to maintain developer productivity
- Use matrix strategy wisely - balance coverage vs speed
- Cache dependencies aggressively
- Fail fast on critical checks (lint, format)
- Consider adding branch protection rules after CI is stable
- The `all-checks` job ensures all required checks pass
- Python 3.13 is used as default (latest stable version)

---

**Created**: 2025-09-28  
**Last Updated**: 2025-09-28
