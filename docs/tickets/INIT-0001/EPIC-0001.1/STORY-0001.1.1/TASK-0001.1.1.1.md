# TASK-0001.1.1.1: Implement Index Command

**Parent Story**: [STORY-0001.1.1](README.md)
**Status**: ðŸ”µ Not Started
**Estimated Hours**: 1
**Actual Hours**: -

## Description

Add the `index` command to the CLI with options for verbose output and forced reindexing. The command should have a mock implementation that demonstrates the expected UX with progress indicators and summary statistics.

## Implementation Checklist

- [ ] Create `src/gitctx/cli/index.py` module
- [ ] Implement `register()` function to add command to app
- [ ] Add `--verbose/-v` flag for detailed output
- [ ] Add `--force/-f` flag for forced reindexing
- [ ] Implement mock progress display using Rich
- [ ] Show mock statistics after completion
- [ ] Enable BDD test: "Index command help"
- [ ] Add unit tests for command registration
- [ ] Verify help text is comprehensive

## TDD Requirements

### Test First (RED)

Write unit tests in `tests/unit/cli/test_index.py`:

```python
import pytest
from typer.testing import CliRunner
from gitctx.cli.main import app

runner = CliRunner()

def test_index_command_exists():
    """Verify index command is registered."""
    result = runner.invoke(app, ["index", "--help"])
    assert result.exit_code == 0
    assert "Index the repository" in result.stdout

def test_index_verbose_flag():
    """Verify --verbose flag is accepted."""
    result = runner.invoke(app, ["index", "--verbose"])
    assert result.exit_code == 0
    assert "verbose" in result.stdout.lower() or "detailed" in result.stdout.lower()

def test_index_force_flag():
    """Verify --force flag is accepted."""
    result = runner.invoke(app, ["index", "--force"])
    assert result.exit_code == 0
    assert "force" in result.stdout.lower() or "reindexing" in result.stdout.lower()

def test_index_short_flags():
    """Verify -v and -f short flags work."""
    result = runner.invoke(app, ["index", "-v", "-f"])
    assert result.exit_code == 0

def test_index_help_text():
    """Verify help text includes all options."""
    result = runner.invoke(app, ["index", "--help"])
    assert "--verbose" in result.stdout
    assert "-v" in result.stdout
    assert "--force" in result.stdout
    assert "-f" in result.stdout
    assert "Show detailed output" in result.stdout
    assert "Force reindexing" in result.stdout
```

### Implementation (GREEN)

Create `src/gitctx/cli/index.py`:

```python
"""Index command for gitctx CLI."""

import time
import typer
from rich.console import Console
from rich.progress import Progress, SpinnerColumn, TextColumn, BarColumn, TaskProgressColumn

console = Console()

def register(app: typer.Typer) -> None:
    """Register the index command with the CLI app."""
    app.command(name="index")(index_command)

def index_command(
    verbose: bool = typer.Option(
        False,
        "--verbose", "-v",
        help="Show detailed output during indexing"
    ),
    force: bool = typer.Option(
        False,
        "--force", "-f",
        help="Force reindexing even if cache exists"
    ),
) -> None:
    """
    Index the repository for searching.

    This command analyzes your git repository and creates searchable
    embeddings for all code and documentation files.

    Examples:

        # Basic indexing
        $ gitctx index

        # Force reindex with verbose output
        $ gitctx index --force --verbose

        # Using short flags
        $ gitctx index -v -f
    """
    # Mock implementation message
    if verbose:
        console.print("[dim]Mock implementation - verbose mode enabled[/dim]")

    if force:
        console.print("[yellow]Force reindexing enabled[/yellow]")
        console.print()

    # Mock progress display
    with Progress(
        SpinnerColumn(),
        TextColumn("[progress.description]{task.description}"),
        BarColumn(),
        TaskProgressColumn(),
        console=console,
    ) as progress:
        # Simulate indexing steps
        task1 = progress.add_task("Discovering files...", total=100)
        for i in range(100):
            time.sleep(0.005)  # Simulate work
            progress.update(task1, advance=1)
            if verbose and i % 20 == 0:
                console.print(f"  [dim]Found {i*12} files...[/dim]")

        task2 = progress.add_task("Generating embeddings...", total=100)
        for i in range(100):
            time.sleep(0.005)  # Simulate work
            progress.update(task2, advance=1)

    # Mock summary statistics
    console.print()
    console.print("[green]âœ“[/green] Repository indexed successfully")
    console.print()
    console.print("  [bold]Statistics:[/bold]")
    console.print("    Files indexed:     1,234")
    console.print("    Code chunks:       5,678")
    console.print("    Embeddings:        5,678")
    console.print("    Index size:        45.2 MB")
    console.print("    Time elapsed:      1.2s")

    if verbose:
        console.print()
        console.print("  [bold]File types indexed:[/bold]")
        console.print("    Python (.py):      456 files")
        console.print("    JavaScript (.js):  234 files")
        console.print("    TypeScript (.ts):  189 files")
        console.print("    Markdown (.md):    355 files")
```

Update `src/gitctx/cli/main.py`:

```python
"""Main CLI application."""

import typer
from rich.console import Console

from gitctx import __version__

# Create app with Rich support
app = typer.Typer(
    name="gitctx",
    help="Context optimization engine for coding workflows",
    add_completion=False,
    rich_markup_mode="rich",
    context_settings={"help_option_names": ["-h", "--help"]},
)

console = Console()

def version_callback(value: bool) -> None:
    """Show version and exit."""
    if value:
        console.print(f"gitctx version {__version__}")
        raise typer.Exit()

@app.callback()
def main(
    version: bool | None = typer.Option(
        None,
        "--version",
        callback=version_callback,
        is_eager=True,
        help="Show version and exit",
    ),
) -> None:
    """gitctx - Context optimization engine for coding workflows."""
    pass

# Register commands
from gitctx.cli import index

index.register(app)
```

### BDD Scenario

Enable in `tests/e2e/features/cli.feature`:

```gherkin
Scenario: Index command help
  When I run "gitctx index --help"
  Then the output should contain "Index the repository"
  And the output should contain "--verbose"
  And the exit code should be 0
```

### Refactor

- Consider extracting progress display to a utility function
- Add type hints for all parameters
- Consider making mock delays configurable for testing

## Acceptance Criteria

- [x] `gitctx index` command is executable
- [x] `--verbose/-v` flag shows detailed output
- [x] `--force/-f` flag indicates forced reindexing
- [x] Progress indicators display during mock indexing
- [x] Summary statistics shown after completion
- [x] Help text includes usage examples
- [x] Unit tests pass for all command variations
- [x] BDD scenario "Index command help" passes

## Dependencies

- Parent story must be created
- Basic CLI structure from STORY-0001.1.0

## Testing Commands

```bash
# Run unit tests
uv run pytest tests/unit/cli/test_index.py -v

# Run BDD test
uv run pytest tests/e2e -k "index" -v

# Manual testing
uv run gitctx index --help
uv run gitctx index
uv run gitctx index --verbose
uv run gitctx index --force
uv run gitctx index -v -f
```

## Notes

- Mock implementation should feel responsive (<50ms perceived delay)
- Progress bars make the mock feel more realistic
- Verbose output helps users understand what will happen in real implementation
- This establishes the UX pattern for all long-running commands

---

**Created**: 2025-10-01
**Last Updated**: 2025-10-01