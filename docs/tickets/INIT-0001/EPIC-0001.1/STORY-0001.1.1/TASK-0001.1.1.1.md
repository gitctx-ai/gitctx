# TASK-0001.1.1.1: Implement Index Command

**Parent Story**: [STORY-0001.1.1](README.md)
**Status**: ✅ Complete
**Estimated Hours**: 1
**Actual Hours**: 1

## Description

Add the `index` command to the CLI with three output modes (Default, Verbose, Quiet) and options for forced reindexing. The mock implementation must follow TUI_GUIDE.md specifications: terse single-line output by default, detailed multi-line output in verbose mode, silent in quiet mode.

## Implementation Checklist

- [x] Create `src/gitctx/cli/index.py` module
- [x] Implement `register()` function to add command to app
- [x] Add `--verbose/-v` flag for detailed output
- [x] Add `--quiet/-q` flag for silent operation
- [x] Add `--force/-f` flag for forced reindexing
- [x] Implement default mode: single-line terse output (TUI_GUIDE.md line 189)
- [x] Implement verbose mode: multi-line detailed output (TUI_GUIDE.md lines 207-236)
- [x] Implement quiet mode: silent on success (TUI_GUIDE.md lines 240-243)
- [x] Validate git repository exists before mock indexing
- [x] Use `console.print()` directly, NO Rich panels/progress bars
- [x] Enable BDD test: "Index command help"
- [x] Add unit tests for all three output modes
- [x] Verify help text is comprehensive

## TDD Requirements

### Test First (RED)

Write unit tests in `tests/unit/cli/test_index.py`:

```python
import pytest
from typer.testing import CliRunner
from gitctx.cli.main import app

runner = CliRunner()

def test_index_command_exists():
    """Verify index command is registered."""
    result = runner.invoke(app, ["index", "--help"])
    assert result.exit_code == 0
    assert "Index the repository" in result.stdout

def test_index_default_output():
    """Verify default mode is terse (single line)."""
    result = runner.invoke(app, ["index"])
    assert result.exit_code == 0
    lines = [l for l in result.stdout.split('\n') if l.strip()]
    # Default should be 1 line: "Indexed N commits (M unique blobs) in Xs"
    assert len(lines) == 1
    assert "Indexed" in result.stdout
    assert "commits" in result.stdout
    assert "unique blobs" in result.stdout

def test_index_verbose_flag():
    """Verify --verbose flag shows detailed output."""
    result = runner.invoke(app, ["index", "--verbose"])
    assert result.exit_code == 0
    # Verbose should have multiple sections
    assert "Walking commit graph" in result.stdout or "→" in result.stdout
    assert "Found" in result.stdout
    lines = [l for l in result.stdout.split('\n') if l.strip()]
    assert len(lines) > 5  # Multiple lines in verbose mode

def test_index_quiet_flag():
    """Verify --quiet flag suppresses output."""
    result = runner.invoke(app, ["index", "--quiet"])
    assert result.exit_code == 0
    # Quiet mode should have NO output on success
    assert result.stdout.strip() == ""

def test_index_force_flag():
    """Verify --force flag is accepted."""
    result = runner.invoke(app, ["index", "--force"])
    assert result.exit_code == 0
    assert "Cleared existing index" in result.stdout or "force" in result.stdout.lower()

def test_index_short_flags():
    """Verify -v, -q, -f short flags work."""
    result = runner.invoke(app, ["index", "-v", "-f"])
    assert result.exit_code == 0

    result = runner.invoke(app, ["index", "-q"])
    assert result.exit_code == 0
    assert result.stdout.strip() == ""

def test_index_help_text():
    """Verify help text includes all options."""
    result = runner.invoke(app, ["index", "--help"])
    assert "--verbose" in result.stdout
    assert "-v" in result.stdout
    assert "--quiet" in result.stdout
    assert "-q" in result.stdout
    assert "--force" in result.stdout
    assert "-f" in result.stdout
```

### Implementation (GREEN)

**IMPORTANT**: Follow TUI_GUIDE.md specifications exactly. See lines 178-368 for complete index command behavior.

Create `src/gitctx/cli/index.py`:

```python
"""Index command for gitctx CLI."""

from pathlib import Path
import sys
import typer
from rich.console import Console

console = Console()

def register(app: typer.Typer) -> None:
    """Register the index command with the CLI app."""
    app.command(name="index")(index_command)

def index_command(
    verbose: bool = typer.Option(
        False,
        "--verbose", "-v",
        help="Show detailed output during indexing"
    ),
    quiet: bool = typer.Option(
        False,
        "--quiet", "-q",
        help="Suppress all output except errors"
    ),
    force: bool = typer.Option(
        False,
        "--force", "-f",
        help="Force reindexing even if cache exists"
    ),
) -> None:
    """
    Index the repository for searching.

    This command analyzes your git repository and creates searchable
    embeddings for all code and documentation files.

    Examples:

        # Basic indexing (terse output)
        $ gitctx index

        # Detailed output
        $ gitctx index --verbose

        # Silent operation
        $ gitctx index --quiet

        # Force reindex
        $ gitctx index --force
    """
    # Validate git repository exists
    if not Path(".git").exists():
        console.print("[red]✗[/red] Error: not a git repository", file=sys.stderr)
        raise typer.Exit(code=3)

    # Mock implementation - demonstrates expected output format from TUI_GUIDE.md

    # QUIET MODE: No output on success
    if quiet:
        # Silent - real implementation would index here
        return

    # VERBOSE MODE: Multi-line detailed output (TUI_GUIDE.md lines 207-236)
    if verbose:
        if force:
            console.print("Cleared existing index (47.3 MB)")

        console.print("→ Walking commit graph")
        console.print("  Found 5678 commits")
        console.print()
        console.print("→ Extracting blobs")
        console.print("  Total blob references: 4567")
        console.print("  Unique blobs: 1234")
        console.print("  Deduplication: 73% savings")
        console.print()
        console.print("→ Generating embeddings")
        console.print("  Processing blobs: abc123, def456, ...")
        console.print()
        console.print("→ Saving index")
        console.print("  Blobs: ~/.gitctx/blobs/ (45.2 MB)")
        console.print("  Metadata: ~/.gitctx/metadata/ (2.1 MB)")
        console.print()
        console.print("[green]✓[/green] Indexed 5678 commits (1234 unique blobs) in 8.2s")
        console.print()
        console.print("Statistics:")
        console.print("  Commits:      5678")
        console.print("  Unique blobs: 1234")
        console.print("  Total refs:   4567")
        console.print("  Dedup rate:   73%")
        console.print("  Chunks:       3456")
        console.print("  Size:         47.3 MB")
        return

    # DEFAULT MODE: Terse single-line output (TUI_GUIDE.md line 189)
    if force:
        console.print("Cleared existing index (47.3 MB)")
    console.print("Indexed 5678 commits (1234 unique blobs) in 8.2s")
```

Update `src/gitctx/cli/main.py` to register the index command:

```python
# Register commands
from gitctx.cli import index

index.register(app)
```

### BDD Scenario

Enable in `tests/e2e/features/cli.feature`:

```gherkin
Scenario: Index command help
  When I run "gitctx index --help"
  Then the output should contain "Index the repository"
  And the output should contain "--verbose"
  And the exit code should be 0
```

### Refactor

- Extract git repository validation to utility function
- Add type hints for all parameters
- Extract mock data (commit counts, timings) to constants for easy testing

## Acceptance Criteria

- [x] `gitctx index` command is executable
- [x] Default mode outputs single terse line (TUI_GUIDE.md compliant)
- [x] `--verbose/-v` flag shows multi-line detailed output
- [x] `--quiet/-q` flag suppresses all output on success
- [x] `--force/-f` flag shows "Cleared existing index" message
- [x] Git repository validation works (checks for .git directory)
- [x] Exit code 3 returned when not in git repository
- [x] NO Rich panels, progress bars, or tables used
- [x] Help text includes usage examples for all three modes
- [x] Unit tests pass for all output modes
- [x] BDD scenario "Index command help" passes

## Dependencies

- Parent story must be created
- Basic CLI structure from STORY-0001.1.0

## Testing Commands

```bash
# Run unit tests
uv run pytest tests/unit/cli/test_index.py -v

# Run BDD test
uv run pytest tests/e2e -k "index" -v

# Manual testing
uv run gitctx index --help
uv run gitctx index
uv run gitctx index --verbose
uv run gitctx index --force
uv run gitctx index -v -f
```

## Notes

- Mock implementation demonstrates output format from TUI_GUIDE.md
- Default mode is terse (single line) - NOT verbose with progress bars
- Verbose mode shows detailed step-by-step output for transparency
- Quiet mode enables scriptable/CI usage
- Git repository check ensures mocks validate basic preconditions
- This establishes the terse-by-default UX pattern for all commands
- Rich Console automatically handles platform-aware symbol rendering (✓ vs [OK])

---

**Created**: 2025-10-01
**Last Updated**: 2025-10-01