# TASK-0001.1.1.2: Implement Search Command

**Parent Story**: [STORY-0001.1.1](README.md)
**Status**: ✅ Complete
**Estimated Hours**: 1
**Actual Hours**: 1

## Description

Add the `search` command to the CLI with three output modes (Default terse, Verbose with context, Quiet) and required query argument. Mock implementation MUST demonstrate git history + HEAD results format per TUI_GUIDE.md: `file:line:score ● commit (metadata) "message"`

## Implementation Checklist

- [x] Create `src/gitctx/cli/search.py` module
- [x] Implement `register()` function to add command to app
- [x] Add required `query` argument
- [x] Add `--limit/-n` option (default: 10)
- [x] Add `--verbose/-v` flag for code context display
- [x] Add `--mcp` flag for structured markdown output
- [x] Implement default mode: terse result list (TUI_GUIDE.md lines 404-411)
- [x] Implement verbose mode: results with code context (TUI_GUIDE.md lines 417-465)
- [x] Implement MCP mode: structured markdown with YAML frontmatter (TUI_GUIDE.md lines 467-599)
- [x] Mock results show BOTH git history AND HEAD results (demonstrate temporal search)
- [x] Use correct format: `file:line:score ● commit (date, author) "message"`
- [x] HEAD indicator: `●` for current HEAD, no symbol for historical commits
- [x] NO Rich panels, tables, or syntax highlighting (save for verbose mode context)
- [x] Enable BDD test: "Search command help"
- [x] Add unit tests for all output modes
- [x] Verify error handling for missing query
- [x] Validate mutually exclusive flags (--verbose and --mcp)
- [x] Add BDD test for conflicting output modes

## TDD Requirements

### Test First (RED)

Write unit tests in `tests/unit/cli/test_search.py`:

```python
import pytest
from typer.testing import CliRunner
from gitctx.cli.main import app

runner = CliRunner()

def test_search_command_exists():
    """Verify search command is registered."""
    result = runner.invoke(app, ["search", "--help"])
    assert result.exit_code == 0
    assert "Search the indexed repository" in result.stdout

def test_search_requires_query():
    """Verify search requires a query argument."""
    result = runner.invoke(app, ["search"])
    assert result.exit_code != 0
    assert "Missing argument" in result.stdout or "required" in result.stdout.lower()

def test_search_default_output():
    """Verify default mode is terse (file:line:score format)."""
    result = runner.invoke(app, ["search", "authentication"])
    assert result.exit_code == 0
    # Check TUI_GUIDE.md format: file:line:score ● commit
    assert ".py:" in result.stdout
    assert "●" in result.stdout or "[HEAD]" in result.stdout  # Platform-aware
    assert "results in" in result.stdout  # Summary line

def test_search_verbose_mode():
    """Verify --verbose shows code context."""
    result = runner.invoke(app, ["search", "authentication", "--verbose"])
    assert result.exit_code == 0
    # Verbose should include code snippets
    assert "def " in result.stdout or "class " in result.stdout
    lines = [l for l in result.stdout.split('\n') if l.strip()]
    assert len(lines) > 10  # Multi-line with context

def test_search_limit_option():
    """Verify --limit option works."""
    result = runner.invoke(app, ["search", "test", "--limit", "2"])
    assert result.exit_code == 0
    assert "2 of" in result.stdout or "2 results" in result.stdout

def test_search_short_flags():
    """Verify -n and -v short flags work."""
    result = runner.invoke(app, ["search", "test", "-n", "3"])
    assert result.exit_code == 0

    result = runner.invoke(app, ["search", "test", "-v"])
    assert result.exit_code == 0

def test_search_help_text():
    """Verify help text includes all options."""
    result = runner.invoke(app, ["search", "--help"])
    assert "QUERY" in result.stdout
    assert "--limit" in result.stdout
    assert "-n" in result.stdout
    assert "Number of results" in result.stdout

def test_search_shows_history_and_head():
    """Verify search demonstrates both historical and HEAD results."""
    result = runner.invoke(app, ["search", "test"])
    assert result.exit_code == 0
    # Should have HEAD indicator on some results
    has_head = "●" in result.stdout or "[HEAD]" in result.stdout
    # Should have results without HEAD indicator (historical)
    lines_with_results = [l for l in result.stdout.split('\n') if '.py:' in l or '.md:' in l]
    assert len(lines_with_results) >= 2  # At least 2 results to show mix
    assert has_head  # At least one HEAD result
```

### Implementation (GREEN)

**IMPORTANT**: Follow TUI_GUIDE.md search format exactly. See lines 393-736 for complete specifications.

Create `src/gitctx/cli/search.py`:

```python
"""Search command for gitctx CLI."""

import typer
from rich.console import Console

console = Console()

def register(app: typer.Typer) -> None:
    """Register the search command with the CLI app."""
    app.command(name="search")(search_command)

def search_command(
    query: str = typer.Argument(
        ...,
        help="The search query to find relevant code and documentation"
    ),
    limit: int = typer.Option(
        10,
        "--limit", "-n",
        help="Maximum number of results to return",
        min=1,
        max=100
    ),
    verbose: bool = typer.Option(
        False,
        "--verbose", "-v",
        help="Show code context for each result"
    ),
) -> None:
    """
    Search the indexed repository for relevant code.

    This command searches through indexed git history to find
    the most relevant code across all commits.

    Examples:

        # Search (terse output)
        $ gitctx search "authentication logic"

        # With code context
        $ gitctx search "database connection" --verbose

        # Limit results
        $ gitctx search "API endpoints" -n 3
    """
    # Mock search results: demonstrate both git history AND HEAD
    # TUI_GUIDE.md lines 404-411 (default), 417-465 (verbose)
    mock_results = [
        {
            "file": "src/auth/login.py",
            "line": 45,
            "score": 0.92,
            "commit": "f9e8d7c",
            "is_head": True,
            "date": "2025-10-02",
            "author": "Alice",
            "message": "Add OAuth support",
            "code": '''def authenticate_user(username: str, password: str) -> User:
    """Authenticate user with credentials."""
    user = get_user_by_username(username)
    if not user:
        return None
    return user'''
        },
        {
            "file": "src/auth/middleware.py",
            "line": 12,
            "score": 0.87,
            "commit": "a1b2c3d",
            "is_head": False,  # Historical commit
            "date": "2024-09-15",
            "author": "Bob",
            "message": "Add middleware auth",
            "code": '''class AuthenticationMiddleware:
    def __init__(self, app):
        self.app = app
    async def __call__(self, scope, receive, send):
        if scope["type"] == "http":
            headers = dict(scope["headers"])'''
        },
        {
            "file": "docs/authentication.md",
            "line": 34,
            "score": 0.85,
            "commit": "e4f5g6h",
            "is_head": True,
            "date": "2025-10-02",
            "author": "Alice",
            "message": "Update auth docs",
            "code": '''## Authentication Flow

1. User submits credentials to `/api/login`
2. Server validates against database
3. If valid, JWT token generated (24h expiry)'''
        },
        {
            "file": "tests/test_auth.py",
            "line": 78,
            "score": 0.76,
            "commit": "f9e8d7c",
            "is_head": True,
            "date": "2025-10-02",
            "author": "Alice",
            "message": "Add OAuth support",
            "code": '''def test_login_with_valid_credentials():
    """Test successful authentication."""
    response = client.post("/api/login", json={
        "username": "testuser",
        "password": "testpass123"
    })
    assert response.status_code == 200'''
        },
    ]

    # Limit results
    results_to_show = mock_results[:min(limit, len(mock_results))]

    # VERBOSE MODE: Show code context (TUI_GUIDE.md lines 417-465)
    if verbose:
        for result in results_to_show:
            # Symbol: ● for HEAD, space for historical
            head_symbol = "●" if result["is_head"] else " "

            # Header line
            console.print(f"\n{result['file']}:{result['line']} ({result['score']:.2f}) {head_symbol} {result['commit']} ({result['date']}, {result['author']})")
            console.print("─" * 70)
            console.print(f"Message: {result['message']}")
            console.print()
            # Code context (plain text, no syntax highlighting in mocks)
            console.print(result['code'])

        console.print(f"\n{len(results_to_show)} results in 0.23s")
        return

    # DEFAULT MODE: Terse output (TUI_GUIDE.md lines 404-411)
    for result in results_to_show:
        # Symbol: ● for HEAD, nothing for historical
        head_symbol = "●" if result["is_head"] else " "
        # Format: file:line:score ● commit (HEAD, date, author) "message"
        console.print(
            f"{result['file']}:{result['line']}:{result['score']:.2f} {head_symbol} "
            f"{result['commit']} ({'HEAD, ' if result['is_head'] else ''}{result['date']}, {result['author']}) "
            f"\"{result['message']}\""
        )

    console.print(f"\n{len(results_to_show)} results in 0.23s")
```

Update `src/gitctx/cli/main.py` to register the search command:

```python
# Register commands
from gitctx.cli import index, search

index.register(app)
search.register(app)
```

### BDD Scenario

Enable in `tests/e2e/features/cli.feature`:

```gherkin
Scenario: Search command help
  When I run "gitctx search --help"
  Then the output should contain "Search the indexed repository"
  And the exit code should be 0

Scenario: Missing required arguments
  When I run "gitctx search"
  Then the exit code should not be 0
  And the output should contain "Missing argument"
  And the output should contain "QUERY"
```

### Refactor

- Extract result formatting to separate function
- Consider adding export options (JSON, CSV)
- Add query validation/sanitization

## Acceptance Criteria

- [x] `gitctx search <query>` command is executable
- [x] Query argument is required (error if missing)
- [x] Default mode: terse format `file:line:score ● commit (metadata) "message"`
- [x] Verbose mode: multi-line with code context
- [x] MCP mode: structured markdown with YAML frontmatter for AI consumption
- [x] `--limit/-n` option controls result count
- [x] Mock results demonstrate BOTH git history AND HEAD
- [x] HEAD indicator: `●` for HEAD commits, space for historical
- [x] NO Rich panels, tables, or Syntax highlighting (plain console.print)
- [x] Help text includes usage examples
- [x] Unit tests pass for all output modes
- [x] BDD scenario "Search command help" passes
- [x] --verbose and --mcp are mutually exclusive (exit code 2 if both used)
- [x] BDD scenario "Search with conflicting output modes" passes

## Dependencies

- Parent story must be created
- Index command should be implemented first (for consistency)

## Testing Commands

```bash
# Run unit tests
uv run pytest tests/unit/cli/test_search.py -v

# Run BDD test
uv run pytest tests/e2e -k "search" -v

# Manual testing
uv run gitctx search --help
uv run gitctx search "authentication"
uv run gitctx search "database connection" --limit 5
uv run gitctx search "API endpoints" -n 3
uv run gitctx search  # Should show error
```

## Notes

- Mock results demonstrate temporal search: git history + HEAD results
- Default output is terse, following TUI_GUIDE.md format exactly
- HEAD indicator (`●`) shows which results are from current branch vs history
- Commit metadata (SHA, date, author, message) provides temporal context
- Verbose mode adds code context without fancy formatting (no panels/tables)
- This establishes the git-aware search UX pattern
- Platform-aware symbols handled automatically by Rich Console

---

**Created**: 2025-10-01
**Last Updated**: 2025-10-01