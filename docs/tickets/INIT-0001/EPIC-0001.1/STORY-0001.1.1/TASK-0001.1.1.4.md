# TASK-0001.1.1.4: Implement Clear Command

**Parent Story**: [STORY-0001.1.1](README.md)
**Status**: ✅ Complete
**Estimated Hours**: 1
**Actual Hours**: 1

## Description

Add the `clear` command to the CLI with options for selectively clearing different types of cached data. The command should demonstrate safe deletion patterns with confirmation prompts and the ability to force deletion without confirmation.

## Implementation Checklist

- [x] Create `src/gitctx/cli/clear.py` module
- [x] Implement `register()` function to add command to app
- [x] Add `--force/-f` flag to skip confirmation
- [x] Add `--database/-d` flag to clear database
- [x] Add `--embeddings/-e` flag to clear embeddings
- [x] Add `--all/-a` flag to clear everything
- [x] Implement confirmation prompts using Typer
- [x] Show what will be deleted before confirmation
- [x] Enable BDD test: "Clear command help"
- [x] Add unit tests for flag combinations
- [x] Verify safety checks work properly

## TDD Requirements

### Test First (RED)

Write unit tests in `tests/unit/cli/test_clear.py`:

```python
import pytest
from typer.testing import CliRunner
from gitctx.cli.main import app

runner = CliRunner()

def test_clear_command_exists():
    """Verify clear command is registered."""
    result = runner.invoke(app, ["clear", "--help"])
    assert result.exit_code == 0
    assert "Clear cache and embeddings" in result.stdout

def test_clear_requires_confirmation():
    """Verify clear asks for confirmation by default."""
    # Send 'n' to decline confirmation
    result = runner.invoke(app, ["clear"], input="n\n")
    assert result.exit_code == 0
    assert "confirm" in result.stdout.lower() or "sure" in result.stdout.lower()
    assert "cancelled" in result.stdout.lower() or "aborted" in result.stdout.lower()

def test_clear_force_flag():
    """Verify --force skips confirmation."""
    result = runner.invoke(app, ["clear", "--force"])
    assert result.exit_code == 0
    # Should not ask for confirmation
    assert "confirm" not in result.stdout.lower()
    assert "cleared" in result.stdout.lower() or "removed" in result.stdout.lower()

def test_clear_database_flag():
    """Verify --database flag works."""
    result = runner.invoke(app, ["clear", "--database", "--force"])
    assert result.exit_code == 0
    assert "database" in result.stdout.lower()

def test_clear_embeddings_flag():
    """Verify --embeddings flag works."""
    result = runner.invoke(app, ["clear", "--embeddings", "--force"])
    assert result.exit_code == 0
    assert "embeddings" in result.stdout.lower()

def test_clear_all_flag():
    """Verify --all flag clears everything."""
    result = runner.invoke(app, ["clear", "--all", "--force"])
    assert result.exit_code == 0
    assert "all" in result.stdout.lower() or "everything" in result.stdout.lower()

def test_clear_short_flags():
    """Verify short flags work."""
    result = runner.invoke(app, ["clear", "-a", "-f"])
    assert result.exit_code == 0

def test_clear_multiple_flags():
    """Verify multiple selective flags work together."""
    result = runner.invoke(app, ["clear", "-d", "-e", "-f"])
    assert result.exit_code == 0
    assert "database" in result.stdout.lower()
    assert "embeddings" in result.stdout.lower()

def test_clear_with_confirmation_yes():
    """Verify confirmation works when user says yes."""
    result = runner.invoke(app, ["clear", "--all"], input="y\n")
    assert result.exit_code == 0
    assert "cleared" in result.stdout.lower() or "removed" in result.stdout.lower()

def test_clear_help_text():
    """Verify help text includes all options."""
    result = runner.invoke(app, ["clear", "--help"])
    assert "--force" in result.stdout
    assert "-f" in result.stdout
    assert "--database" in result.stdout
    assert "-d" in result.stdout
    assert "--embeddings" in result.stdout
    assert "-e" in result.stdout
    assert "--all" in result.stdout
    assert "-a" in result.stdout
```

### Implementation (GREEN)

Create `src/gitctx/cli/clear.py`:

```python
"""Clear command for gitctx CLI."""

from pathlib import Path
import typer
from rich.console import Console
from rich.panel import Panel
from rich.table import Table
from typing import Optional

console = Console()

def register(app: typer.Typer) -> None:
    """Register the clear command with the CLI app."""
    app.command(name="clear")(clear_command)

def clear_command(
    force: bool = typer.Option(
        False,
        "--force", "-f",
        help="Skip confirmation prompt"
    ),
    database: bool = typer.Option(
        False,
        "--database", "-d",
        help="Clear the vector database"
    ),
    embeddings: bool = typer.Option(
        False,
        "--embeddings", "-e",
        help="Clear cached embeddings"
    ),
    all_data: bool = typer.Option(
        False,
        "--all", "-a",
        help="Clear all cached data (database + embeddings + cache)"
    ),
) -> None:
    """
    Clear cache and embeddings.

    This command removes cached data to free up disk space or force
    reindexing. Use with caution as clearing data will require
    reindexing your repository.

    Examples:

        # Clear everything with confirmation
        $ gitctx clear --all

        # Force clear database without confirmation
        $ gitctx clear --database --force

        # Clear both database and embeddings
        $ gitctx clear -d -e -f

        # Clear everything without confirmation (use with caution!)
        $ gitctx clear --all --force
    """
    # Determine what to clear
    if all_data:
        clear_database = True
        clear_embeddings = True
        clear_cache = True
    else:
        clear_database = database
        clear_embeddings = embeddings
        clear_cache = False  # Only with --all for now

    # If no flags specified, default to clearing everything
    if not (clear_database or clear_embeddings or clear_cache):
        clear_database = True
        clear_embeddings = True
        clear_cache = True

    # Mock paths for demonstration
    gitctx_dir = Path.home() / ".gitctx"
    db_path = gitctx_dir / "index.db"
    embeddings_path = gitctx_dir / "embeddings"
    cache_path = gitctx_dir / "cache"

    # Create summary of what will be deleted
    items_to_clear = []
    total_size = 0  # Mock sizes

    if clear_database:
        items_to_clear.append(("Vector Database", str(db_path), "45.2 MB"))
        total_size += 45.2

    if clear_embeddings:
        items_to_clear.append(("Embeddings Cache", str(embeddings_path), "123.8 MB"))
        total_size += 123.8

    if clear_cache:
        items_to_clear.append(("Query Cache", str(cache_path), "12.4 MB"))
        total_size += 12.4

    # Display what will be cleared
    console.print("[bold]Items to be cleared:[/bold]")
    console.print()

    table = Table(show_header=True, header_style="bold cyan")
    table.add_column("Type", style="cyan")
    table.add_column("Location", style="dim")
    table.add_column("Size", justify="right")

    for item_type, location, size in items_to_clear:
        table.add_row(item_type, location, size)

    console.print(table)
    console.print()
    console.print(f"[bold]Total space to be freed:[/bold] {total_size:.1f} MB")
    console.print()

    # Confirmation prompt (unless --force is used)
    if not force:
        console.print("[yellow]⚠️  This operation cannot be undone![/yellow]")
        console.print("You will need to run [cyan]gitctx index[/cyan] again after clearing.")
        console.print()

        confirm = typer.confirm("Do you want to continue?", default=False)

        if not confirm:
            console.print("[red]Operation cancelled.[/red]")
            raise typer.Exit(0)

    # Mock clearing process
    console.print()
    with console.status("[bold cyan]Clearing data...[/bold cyan]") as status:
        if clear_database:
            status.update("Removing vector database...")
            # Mock: would actually delete db_path
            console.print("  [green]✓[/green] Vector database cleared")

        if clear_embeddings:
            status.update("Removing embeddings cache...")
            # Mock: would actually delete embeddings_path
            console.print("  [green]✓[/green] Embeddings cache cleared")

        if clear_cache:
            status.update("Removing query cache...")
            # Mock: would actually delete cache_path
            console.print("  [green]✓[/green] Query cache cleared")

    # Summary
    console.print()
    console.print(f"[green]✓[/green] Successfully cleared {len(items_to_clear)} item(s)")
    console.print(f"[green]✓[/green] Freed {total_size:.1f} MB of disk space")

    # Provide next steps
    console.print()
    console.print("[bold]Next steps:[/bold]")
    console.print("1. Run [cyan]gitctx index[/cyan] to rebuild the search index")
    console.print("2. Use [cyan]gitctx search[/cyan] to search your codebase")

    # Note about mock implementation
    console.print()
    console.print("[dim]Note: This is a mock implementation. No files were actually deleted.[/dim]")
```

Update `src/gitctx/cli/main.py` to register the clear command:

```python
# Register commands
from gitctx.cli import index, search, config, clear

index.register(app)
search.register(app)
config.register(app)
clear.register(app)
```

### BDD Scenario

Enable in `tests/e2e/features/cli.feature`:

```gherkin
Scenario: Clear command help
  When I run "gitctx clear --help"
  Then the output should contain "Clear cache and embeddings"
  And the output should contain "--force"
  And the output should contain "--database"
  And the output should contain "--embeddings"
  And the output should contain "--all"
  And the exit code should be 0
```

### Refactor

- Extract file size calculation to utility function
- Add progress bars for actual deletion
- Consider adding dry-run option
- Add backup option before clearing

## Acceptance Criteria

- [x] `gitctx clear` command is executable
- [x] `--force/-f` flag skips confirmation
- [x] `--database/-d` flag clears database only
- [x] `--embeddings/-e` flag clears embeddings only
- [x] `--all/-a` flag clears everything
- [x] Confirmation prompt shown by default
- [x] Summary shows what will be deleted and size
- [x] Multiple flags can be combined
- [x] Help text includes examples and warnings
- [x] Unit tests pass for all flag combinations
- [x] BDD scenario "Clear command help" passes

## Dependencies

- Parent story must be created
- Should be implemented after other commands for consistency

## Testing Commands

```bash
# Run unit tests
uv run pytest tests/unit/cli/test_clear.py -v

# Run BDD test
uv run pytest tests/e2e -k "clear" -v

# Manual testing
uv run gitctx clear --help
uv run gitctx clear  # Should ask for confirmation
uv run gitctx clear --force
uv run gitctx clear --database --force
uv run gitctx clear --embeddings --force
uv run gitctx clear --all --force
uv run gitctx clear -d -e -f
uv run gitctx clear -a -f

# Test confirmation prompts
echo "n" | uv run gitctx clear --all  # Should cancel
echo "y" | uv run gitctx clear --all  # Should proceed
```

## Notes

- Confirmation prompts are critical for safety
- Show clear information about what will be deleted
- Provide file sizes to help users understand impact
- Next steps guide users to reindex after clearing
- Mock implementation demonstrates UX without actual deletion
- This establishes patterns for all destructive operations

---

**Created**: 2025-10-01
**Last Updated**: 2025-10-01