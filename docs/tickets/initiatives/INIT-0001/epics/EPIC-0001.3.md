# EPIC-0001.3: Vector Search Implementation

**Parent Initiative**: [INIT-0001](../README.md)  
**Status**: ðŸ”µ Not Started  
**Estimated**: 21 story points  
**Progress**: â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 0%

## Overview

Replace mock search results with actual vector similarity search using LanceDB. Query embeddings are generated, compared against indexed embeddings, and results are ranked and formatted for display.

## Goals

- Build LanceDB from safetensors embeddings
- Generate query embeddings
- Implement similarity search with ranking
- Format results with syntax highlighting
- Optimize search performance

## Child Stories

| ID | Title | Status | Points |
|----|-------|--------|--------|
| [STORY-0001.3.1](../stories/STORY-0001.3.1.md) | LanceDB Setup | ðŸ”µ Not Started | 5 |
| [STORY-0001.3.2](../stories/STORY-0001.3.2.md) | Query Embedding Generation | ðŸ”µ Not Started | 3 |
| [STORY-0001.3.3](../stories/STORY-0001.3.3.md) | Vector Similarity Search | ðŸ”µ Not Started | 5 |
| [STORY-0001.3.4](../stories/STORY-0001.3.4.md) | Result Formatting | ðŸ”µ Not Started | 3 |
| [STORY-0001.3.5](../stories/STORY-0001.3.5.md) | Search Performance Optimization | ðŸ”µ Not Started | 5 |

## BDD Specifications

```gherkin
# tests/e2e/features/search.feature

Feature: Code Search
  As a developer
  I want to search my codebase
  So that I can find relevant code quickly

  Background:
    Given an indexed repository

  Scenario: Basic search
    When I run "gitctx search 'authentication middleware'"
    Then results should be returned within 2 seconds
    And results should show file paths
    And results should show line numbers
    And results should be syntax highlighted

  Scenario: Search with no results
    When I run "gitctx search 'nonexistent_function_xyz'"
    Then the output should say "No results found"
    And the exit code should be 0

  Scenario: Search with limit
    When I run "gitctx search 'database' --limit 5"
    Then exactly 5 results should be shown
    And results should be sorted by relevance

  Scenario: Search with JSON output
    When I run "gitctx search 'api endpoint' --json"
    Then output should be valid JSON
    And JSON should contain file paths
    And JSON should contain similarity scores

  Scenario: Search shows relevance
    When I run "gitctx search 'user authentication'"
    Then each result should show a relevance score
    And scores should be between 0 and 1
    And results should be ordered by score
```

## Technical Design

### LanceDB Store

```python
# src/gitctx/storage/lancedb_store.py
import lancedb
import numpy as np
from pathlib import Path

class VectorStore:
    def __init__(self, db_path: Path):
        self.db = lancedb.connect(db_path)
        self.table = None
    
    def build_from_embeddings(self, cache_dir: Path):
        """Build LanceDB from safetensors files."""
        embeddings = self._load_all_embeddings(cache_dir)
        
        # Create table with vector index
        self.table = self.db.create_table(
            "embeddings",
            data=embeddings,
            mode="overwrite"
        )
        
        # Create ANN index for performance
        self.table.create_index(
            "vector",
            index_type="IVF_PQ",
            num_partitions=256,
            num_sub_vectors=96
        )
```

### Search Engine

```python
# src/gitctx/search/vector_search.py
from langchain.embeddings import OpenAIEmbeddings

class SearchEngine:
    def __init__(self, vector_store: VectorStore):
        self.store = vector_store
        self.embedder = OpenAIEmbeddings(
            model="text-embedding-3-large"
        )
        self.cache = {}
    
    def search(self, query: str, limit: int = 10) -> List[SearchResult]:
        """Perform vector similarity search."""
        # Generate query embedding
        query_embedding = self._get_query_embedding(query)
        
        # Search in LanceDB
        results = self.store.table.search(query_embedding)\
            .limit(limit)\
            .to_pandas()
        
        # Format results
        return self._format_results(results)
    
    def _get_query_embedding(self, query: str) -> np.ndarray:
        """Generate or retrieve cached query embedding."""
        if query in self.cache:
            return self.cache[query]
        
        embedding = self.embedder.embed_query(query)
        self.cache[query] = embedding
        return embedding
```

### Result Formatter

```python
# src/gitctx/search/formatter.py
from rich.syntax import Syntax
from rich.console import Console

class ResultFormatter:
    def __init__(self):
        self.console = Console()
    
    def format_results(self, results: List[SearchResult]) -> None:
        """Format and display search results."""
        for result in results:
            # Show file:line reference
            self.console.print(
                f"[blue]{result.file_path}:{result.line_num}[/blue] "
                f"[dim](score: {result.score:.3f})[/dim]"
            )
            
            # Syntax highlight code
            syntax = Syntax(
                result.content,
                result.language,
                line_numbers=True,
                start_line=result.line_num
            )
            self.console.print(syntax)
            self.console.print()
```

### Performance Optimization

```python
# src/gitctx/search/cache.py
from functools import lru_cache
import hashlib

class SearchCache:
    def __init__(self, max_size: int = 100):
        self.cache = {}
        self.max_size = max_size
    
    def get_cache_key(self, query: str, limit: int) -> str:
        """Generate cache key for query."""
        return hashlib.md5(f"{query}:{limit}".encode()).hexdigest()
    
    @lru_cache(maxsize=100)
    def cached_search(self, query: str, limit: int):
        """Cache search results."""
        # Perform actual search
        return results
```

## Dependencies

- `lancedb` - Vector database
- `numpy` - Array operations
- `pandas` - Data manipulation
- `rich` - Terminal formatting
- `pygments` - Syntax highlighting

## Success Criteria

1. **Fast search** - Results in <2 seconds
2. **Relevant results** - Semantic similarity working
3. **Beautiful output** - Syntax highlighted, well formatted
4. **Reliable** - Handles edge cases gracefully
5. **Efficient** - Caching and indices optimized

## Performance Targets

- Search latency <2s (p95)
- Support 100K+ vectors
- Memory usage <500MB
- Cache hit rate >30%
- Result relevance >0.7 average

## Notes

- LanceDB provides SQL-like queries with vector search
- Caching is critical for responsive UX
- Result formatting makes or breaks usability
- Performance optimization is iterative

---

**Created**: 2025-09-28  
**Last Updated**: 2025-09-28
